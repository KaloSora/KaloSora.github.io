<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>KaloSora的博客</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-02-23T02:45:16.985Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>KaloSora</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用GPT提高研发效率</title>
    <link href="http://example.com/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/"/>
    <id>http://example.com/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/</id>
    <published>2025-02-23T02:45:11.000Z</published>
    <updated>2025-02-23T02:45:16.985Z</updated>
    
    <content type="html"><![CDATA[<p>‍‍</p><p>‍</p><p>相同系列的文章</p><p><a href="https://kalosora.github.io/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/">搭建HelloGPT</a></p><p><a href="https://kalosora.github.io/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/">改进为多态模GPT</a></p><p>‍</p><h2 id="使用LLM辅助设计"><a href="#使用LLM辅助设计" class="headerlink" title="使用LLM辅助设计"></a>使用LLM辅助设计</h2><p>可以让GPT生成多次不同的设计，最后结合自己的思考。</p><p>可以大大提高研发人员在面对陌生领域时的研发效率。</p><p>也可以让GPT帮助代码生成</p><ul><li>根据注释、要求直接生成代码</li><li>根据代码生成测试（目前最准确，因为上下文只有代码，没有业务需求）</li><li>根据代码生成注释</li><li>在不同编程语言之间翻译</li><li>解释代码的运作方式</li><li>修改代码中的bug</li><li>其他</li></ul><p>‍</p><p>可以使用ReAct模式：GPT代码生成 -&gt; GPT自测 -&gt; GPTbug自动修改 （迭代 * N）-&gt; 最终代码</p><p>需要满足以下条件</p><ul><li>ReAct过程中可以使用的方法</li><li>方法的输入简单（简单字符&#x2F;JSON）</li><li>方法的输出是大模型可理解（不能只返回Error code，给出一个详细的自然语言描述）</li></ul><p>‍</p><blockquote><p>源码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_llm_assist_design.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_llm_assist_design.ipynb</a></p></blockquote><p>‍</p><h2 id="提高代码生成的可用性"><a href="#提高代码生成的可用性" class="headerlink" title="提高代码生成的可用性"></a>提高代码生成的可用性</h2><p>使用ReAct pattern</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222165312-868qflu.png" alt="image">​</p><p>‍</p><p>解决遗留代码依赖</p><p>外部推理：编写AST树遍历所有的依赖，整合到Prompt里传给大模型</p><p>大模型推理：大模型基于ReAct模式自己寻找测试依赖</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222170014-8tbzyj0.png" alt="image">​</p><p>‍</p><p>方案比较</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222170655-s3vbpcu.png" alt="image">​</p><p>‍</p><blockquote><p>源码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_code_generation_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_code_generation_example.ipynb</a></p></blockquote><p>‍</p><h2 id="编写大模型友好代码"><a href="#编写大模型友好代码" class="headerlink" title="编写大模型友好代码"></a>编写大模型友好代码</h2><p>适合大模型生成代码的场景：</p><ul><li><p>功能明确，定义清楚</p><ul><li>通过规模较小的接口&#x2F;方法签名来清晰定义</li><li>清晰的注释&#x2F;Prompt的定义实现逻辑</li></ul></li><li><p>通用功能</p></li><li><p>依赖简单</p><ul><li>尤其是对自身遗留代码的依赖</li></ul></li></ul><p>‍</p><h2 id="大模型辅助运维和部署"><a href="#大模型辅助运维和部署" class="headerlink" title="大模型辅助运维和部署"></a>大模型辅助运维和部署</h2><p>利用大模型帮助Devops提高效率，赋能云原生实践</p><p>‍</p><p>什么是云原生？</p><p>计算资源弹性伸缩：需要的时候快速的获得计算资源（几十秒至几分钟），不需要的时候把计算资源释放掉。计算资源允许横向拓展（增加集群）和纵向拓展（加强机器配置）</p><p>单物理机（大型机） vs 云原生</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222203049-jioftgx.png" alt="image">​</p><p>‍</p><p>云原生实践中的CICD pipeline</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222203353-ht8yzo4.png" alt="image">​</p><p>‍</p><p>Terraform作为IaC工具，在云原生中发挥至关重要的作用</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222203619-xj2r1ye.png" alt="image">​</p><p>‍</p><p>可以利用大模型帮助开发者生成terraform template，开发人员只需要修改部分内容即可完成开发。</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222212927-ug7e6ny.png" alt="image">​</p><p>启用上下文记忆功能，让GPT把AWS云转换成阿里云的terraform格式</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222213417-vtmq4wm.png" alt="image">​</p><p>‍</p><p>还可以利用大模型生符合Kubernetes最佳实践的部署配置文件</p><p>最佳实践的要求</p><ul><li>部署的namespace为”service”</li><li>包含readiness及liveness probe</li><li>采用一个独立的 service account 运行</li><li>包含完美终止（graceful termination）配置</li></ul><p><a href="https://learnk8s.io/production-best-practices">K8s best practice</a></p><p>‍</p><blockquote><p>源码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_cloud_devops_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_cloud_devops_example.ipynb</a></p></blockquote><p>‍</p><h2 id="探索开源AI社区"><a href="#探索开源AI社区" class="headerlink" title="探索开源AI社区"></a>探索开源AI社区</h2><p>利用Hugging Face开源社区中大量的开源模型，提升研发效率</p><p><a href="https://huggingface.co/">huggingface</a></p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222214912-demx9p0.png" alt="image">​</p><p>‍</p><p>Open source的模型统称为 <code>pre-trained</code>​模型，可以直接使用它</p><p>Transformer Pipeline</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222215626-k9qx1ue.png" alt="image">​</p><p>‍</p><p>Hugging Face的模型可以统一使用Transformer Pipeline调用。</p><p>如果要使用远程调用模型的方式，需要注册账号并创建API token</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250222221046-uj658fe.png" alt="image">​</p><p>‍</p><p><strong>注意：Hugging Face需要安装tensorflow</strong></p><p>Mac intel arm64会出现找不到安装包的情况</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250223100358-l19mdgb.png" alt="image">​</p><p>‍</p><p>解决方法：安装Anaconda，并创建新的python运行环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">conda --version</span><br><span class="line"></span><br><span class="line">conda create -n TFmacOS python=3.9 pip</span><br><span class="line">conda activate TFmacOS </span><br><span class="line">python -m pip install tensorflow-macos==2.9.0</span><br><span class="line">python -m pip install tensorflow-metal</span><br><span class="line"></span><br><span class="line">conda install jupyter</span><br></pre></td></tr></table></figure><p>从<code>TFmacOS</code>​环境中启动jupyter notebook</p><p>‍</p><blockquote><p>源码</p><p>通过Hugging Face + Deepseek API 实现看图讲故事</p><p>或</p><p>LangChain + Hugging Face model</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_hugging_face_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_hugging_face_example.ipynb</a></p></blockquote><p>‍</p><h2 id="AI企业架构中的思考"><a href="#AI企业架构中的思考" class="headerlink" title="AI企业架构中的思考"></a>AI企业架构中的思考</h2><p>企业内部文档处理</p><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250223091728-jlaozxf.png" alt="image">​</p><p>‍</p><p>其他参考架构</p><ul><li>使用<code>prompt validation</code>​防御提示词注入进攻</li></ul><p>​<img src="/2025/02/23/%E4%BD%BF%E7%94%A8GPT%E6%8F%90%E9%AB%98%E7%A0%94%E5%8F%91%E6%95%88%E7%8E%87/image-20250223092857-9zxbsip.png" alt="image">​</p><p>‍</p><p>最后总结一下使用到的模型社区</p><p>Hugging Face</p><p>Ollama</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍‍&lt;/p&gt;
&lt;p&gt;‍&lt;/p&gt;
&lt;p&gt;相同系列的文章&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://kalosora.github.io/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/&quot;&gt;搭建HelloGPT&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a hr</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
    <category term="DeepSeek" scheme="http://example.com/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>让GPT使用工具</title>
    <link href="http://example.com/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/"/>
    <id>http://example.com/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/</id>
    <published>2025-02-22T08:24:11.000Z</published>
    <updated>2025-02-22T08:25:46.388Z</updated>
    
    <content type="html"><![CDATA[<p>‍‍</p><p>*使用DeepSeek API测试</p><h2 id="Function-Calling"><a href="#Function-Calling" class="headerlink" title="Function Calling"></a>Function Calling</h2><p>让AI调用已经定义好的python 方法</p><p>Function Calling 让模型能够调用外部工具，来增强自身能力。</p><ul><li>将可以使用方法（工具）说明，随用户请求一起放在Prompt中传给GPT</li><li>GPT返回要调用的方法及参数值，然后在外部运行该方法获得结果</li><li>将调用结果及前面的对话历史一起放入Prompt，再次调用GPT</li></ul><p>‍</p><p>例如：</p><ul><li>构建一个dict对象存储：{“Method1”, “Method2”, …}</li><li>在Prompt中加入方法定义</li><li>根据LLM的返回，决定是否调用函数（返回信息中含有”Function_call”），还是直接返回信息给用户</li><li>如需调用函数，则调用LLM指定函数，并将结果及调用的函数一起放在Prompt中再次调用LLM</li></ul><p>‍</p><p>OpenAI GPT4o的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> AzureOpenAI</span><br><span class="line">  </span><br><span class="line">client = AzureOpenAI(</span><br><span class="line">    api_key=os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>),  </span><br><span class="line">    api_version=os.getenv(<span class="string">&quot;OPENAI_API_VERSION&quot;</span>),</span><br><span class="line">    azure_endpoint = os.getenv(<span class="string">&quot;OPENAI_API_BASE&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">funcs = &#123;<span class="string">&quot;get_current_cluster_state&quot;</span>: get_current_cluster_state&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_cluster_state</span>(<span class="params">cluster_name</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;cluster:<span class="subst">&#123;cluster_name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span>  <span class="string">&quot;&quot;&quot;ERROR: Failed to pull image &quot;/docker/dsp:latest&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    msg=[&#123;<span class="string">&quot;role&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;content&quot;</span>:<span class="built_in">input</span>&#125;]</span><br><span class="line">    ret = run_conversation(msg)</span><br><span class="line">    <span class="keyword">return</span> ret.content</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_conversation</span>(<span class="params">msg</span>):</span><br><span class="line">    response = client.chat.completions.create(</span><br><span class="line">        model=deployment,</span><br><span class="line">        messages=msg,</span><br><span class="line">        functions=[</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_current_cluster_state&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Get the current state in a given cluster&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;cluster_name&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;the name of the cluster&quot;</span>,</span><br><span class="line">                            &#125;,</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;cluster_name&quot;</span>],</span><br><span class="line">                    &#125;</span><br><span class="line">          </span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        function_call=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    response_message = response.choices[<span class="number">0</span>].message</span><br><span class="line">  </span><br><span class="line">    function_call = response_message.function_call</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 如果不需要调用function，则直接返回结果</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> function_call:</span><br><span class="line">        <span class="keyword">return</span> response_message</span><br><span class="line">    function_name = function_call.name</span><br><span class="line">    function_to_call = funcs[function_name] </span><br><span class="line">    function_args = json.loads(response_message.function_call.arguments)</span><br><span class="line">    function_response = function_to_call(**function_args)            </span><br><span class="line">    msg.append( <span class="comment"># adding assistant response to messages</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: response_message.role,</span><br><span class="line">            <span class="string">&quot;function_call&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: function_name,</span><br><span class="line">                <span class="string">&quot;arguments&quot;</span>: response_message.function_call.arguments,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    msg.append( <span class="comment"># adding function response to messages</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;role&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: function_name,</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: function_response,</span><br><span class="line">        &#125;</span><br><span class="line">    ) </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> run_conversation(msg)</span><br><span class="line">   </span><br></pre></td></tr></table></figure><p>‍</p><p>在Prompt中加入方法描述</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250215180507-3yfoplo.png" alt="image">​</p><blockquote><p>DeepSeek示例源代码</p><p>目前会出现空回复的bug</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_function_calling.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_function_calling.ipynb</a></p></blockquote><p>‍</p><h2 id="使用LangChain-Agent"><a href="#使用LangChain-Agent" class="headerlink" title="使用LangChain Agent"></a>使用LangChain Agent</h2><p>让GPT以更简单的方式，学会使用工具。</p><p>Agent的核心思想是使用语言模型来选择要采取的一系列操作。</p><p>‍</p><blockquote><p>LangChain 工具集</p><p><a href="https://python.langchain.com/api_reference/">https://python.langchain.com/api_reference/</a></p></blockquote><p>‍</p><p>测试以后可以发现，LangChain使用工具的方法更加智能、灵活</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250216110005-bxe9e3f.png" alt="image">​</p><h3 id="Wolfram-Alpha-API-Wrapper"><a href="#Wolfram-Alpha-API-Wrapper" class="headerlink" title="Wolfram Alpha API Wrapper"></a>Wolfram Alpha API Wrapper</h3><p>​<code>Wolfram Alpha</code>​是专注于解决科学计算的工具，帮助AI更好得思考数学问题</p><blockquote><p>官网</p><p><a href="https://zh.wolframalpha.com/">https://zh.wolframalpha.com</a></p><p>‍</p><p>API ID Ceation</p><p><a href="https://developer.wolframalpha.com/">https://developer.wolframalpha.com</a></p><p>‍</p><p>WolframAlphaAPIWrapper document</p><p><a href="https://python.langchain.com/api_reference/community/utilities/langchain_community.utilities.wolfram_alpha.WolframAlphaAPIWrapper.html">https://python.langchain.com/api_reference/community/utilities/langchain_community.utilities.wolfram_alpha.WolframAlphaAPIWrapper.html</a></p></blockquote><p>‍</p><p>创建账号</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250216111208-2qgm45s.png" alt="image">​</p><p>创建你的APP ID</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250216111431-fmyfj9j.png" alt="image">​</p><p>复制<code>App ID</code>​<br><img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250216111655-uxjwrxm.png" alt="image">​</p><blockquote><p>参考源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_agent.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_agent.ipynb</a></p></blockquote><h2 id="In-context-learning"><a href="#In-context-learning" class="headerlink" title="In-context learning"></a>In-context learning</h2><p><strong>Zero-shot Learning</strong></p><p>一种机器学习方法，它允许模型在没有见过任何训练样本的情况下，对新类别的数据进行分类或识别。</p><p>这种方法通常依赖于模型在训练过程中学到的知识，以及对新类别的一些描述性信息，如属性或原数据。</p><p>例如，给出一些猫的特征，然后给出一堆图片，让机器识别出其中哪些图片是与猫相关的。</p><p>‍</p><p><strong>Few-shot Learning</strong></p><p>教导模型使用非常有限的训练数据来识别新的对象、类或任务。在这里是通过Prompt里加入少量示例，来实现模型学习。</p><p>‍</p><p>应用大语言模型要从传统机器学习思维切换为上下文学习思路</p><p>上下文学习包括Zero-shot Learning 和 Few-shot Learning，两者并无明显界限，可以根据实际需要灵活运用。</p><p>‍</p><blockquote><p>源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_in-ontext_learning.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_in-ontext_learning.ipynb</a></p></blockquote><p>‍</p><h2 id="ReAct模式"><a href="#ReAct模式" class="headerlink" title="ReAct模式"></a>ReAct模式</h2><p>大语言模型具有推理能力，因为它们通过学习大量的文本数据，捕捉语言中的模式和结构。这些模型在训练过程中，会学习到各种知识、逻辑关系和推理方法。当它们遇到新的问题时，可以根据已经学到的知识和推理方法，生成有意义的回答。</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220092417-an4b6d6.png" alt="image">​</p><p>‍</p><p>通过获取当前环境信息（观察），进一步思考，采取行动</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220092516-ffjujn5.png" alt="image">​</p><p>‍</p><h3 id="LangChain-ReAct-Agent"><a href="#LangChain-ReAct-Agent" class="headerlink" title="LangChain ReAct Agent"></a>LangChain ReAct Agent</h3><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220092544-lca8ao4.png" alt="image">​</p><p>‍</p><p>构建GPT，可以使用如下范式</p><p><span data-type="text" style="color: var(--b3-font-color6);">Question</span>: the input question you must answer</p><p><span data-type="text" style="color: var(--b3-font-color6);">Thought</span>: you should always think about what to do</p><p><span data-type="text" style="color: var(--b3-font-color6);">Action</span>: the action to take, should be one of [{tool_names}]</p><p><span data-type="text" style="color: var(--b3-font-color6);">Action Input:</span> the input to the action</p><p><span data-type="text" style="color: var(--b3-font-color6);">Observation</span>: the result of thr action… (Though&#x2F;Action&#x2F;Action Input&#x2F;Observation repeat N times)</p><p><span data-type="text" style="color: var(--b3-font-color6);">Thought</span>: Now I know the answer</p><p><span data-type="text" style="color: var(--b3-font-color6);">Final Answer</span>: the answer to the input question</p><p>‍</p><p>AutoGPT - 针对某个解决方案的循环自执行GPT</p><p>如果可以，配合短期和长期记忆保证上下文效果。</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220093712-epgkrva.png" alt="image">​</p><p>Plan: 设计实现预期结果的计划，将复杂的任务分解为较小的步骤。</p><p>Criticize: 评估计划的可行性和效率，识别潜在问题和改进领域</p><p>Act: 使用其多功能的能力执行计划的操作，例如网络搜索和数据检索</p><p>Observe：分析从Act中生成的反馈，从以前的性能中学习以改善未来的结果</p><p>Plan（修改）：根据反馈，修改初始计划，允许持续改进问题解决策略</p><p>‍</p><blockquote><p>源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_autogpt_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_autogpt_example.ipynb</a></p></blockquote><p>‍</p><h2 id="文本分片与向量化"><a href="#文本分片与向量化" class="headerlink" title="文本分片与向量化"></a>文本分片与向量化</h2><p>让大模型应用企业内部数据</p><p>大量文档和数据的挑战：如果使用prompt的方式来传递数据或上下文，会面临以下挑战：</p><ul><li>Prompt的内容大小限制</li><li>使用大量数据的成本</li><li>并非所有数据都会用于解决当前问题</li></ul><p>‍</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220210925-xq0i4n2.png" alt="image">​</p><p>一种可能的处理方式<strong>关键词检索</strong>：通过Elaticsearch、Lucene等类似搜索引擎的方式，根据文本建立索引，通过关键词<u>严格匹配</u>到对应的文本内容。但是这种方式会丢失很多上下文的信息，会让相同语意的文本丢失。</p><p>‍</p><p>更好的方法是让关键词检索变为<strong>语义检索</strong></p><p>语义检索是一种基于文本内容和意义的信息检索方法，它试图理解查询和文档的语义，以便更准确地找到与查询相关的文档。</p><p>向量化(embedding)是将文本数据转为数值向量的过程。向量化后的文本可以用于计算文本之间的相似性，如余弦相似度、欧几里德距离等度量。<strong>这使得语义检索能够根据查询和文档之间的语义相似性来对文档进行排序和检索，从而提高检索的准确性和效率</strong>。</p><p>我们可以把字符块进行向量化，通过向量间的距离来求解这些向量之间的相似性。也就是说，语义越相近的向量，它的距离就越短。</p><blockquote><p>参考阅读</p><p>Word2Vec相关的一些机器学习的理论</p></blockquote><p>‍</p><p>实现流程</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222100753-1kzxpe0.png" alt="image">​</p><p>代码示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向量化简单示例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.embeddings.openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># embedding = OpenAIEmbeddings() #如果直接使用OpenAI的GPT服务</span></span><br><span class="line">embedding = OpenAIEmbeddings(deployment=embedding_deployment) <span class="comment">#deployment是你在Azure中的 embedding 模型的部署名字</span></span><br><span class="line">sentence1 = <span class="string">&quot;我是一名软件工程师&quot;</span></span><br><span class="line">sentence2 = <span class="string">&quot;小张从事法律工作&quot;</span></span><br><span class="line">sentence3 = <span class="string">&quot;我是一名程序员&quot;</span></span><br><span class="line"></span><br><span class="line">embedding1 = embedding.embed_query(sentence1)</span><br><span class="line">embedding2 = embedding.embed_query(sentence2)</span><br><span class="line">embedding3 = embedding.embed_query(sentence3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点集计算向量间的距离</span></span><br><span class="line"><span class="built_in">print</span>(np.dot(embedding1,embedding2))</span><br><span class="line"><span class="built_in">print</span>(np.dot(embedding2,embedding3))</span><br><span class="line"><span class="built_in">print</span>(np.dot(embedding1,embedding3))</span><br></pre></td></tr></table></figure><p>‍</p><p>文本向量化</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.embeddings.openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">embed</span>(<span class="params">chunks</span>): </span><br><span class="line">    <span class="comment"># embedding = OpenAIEmbeddings()#如果直接使用OpenAI的GPT服务</span></span><br><span class="line">    embedding = OpenAIEmbeddings(deployment=embedding_deployment)</span><br><span class="line">    <span class="keyword">return</span> [embedding.embed_query(chunk) <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks]</span><br><span class="line"></span><br><span class="line">chunks = split_file_into_chunks(<span class="string">&quot;spotmax_intro.txt&quot;</span>,<span class="number">100</span>)</span><br><span class="line">embeddeds = embed(chunks)</span><br></pre></td></tr></table></figure><p>‍</p><p>向量检索</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_k_largest_indices</span>(<span class="params">input_list, k</span>):</span><br><span class="line">    sorted_indices = <span class="built_in">sorted</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(input_list)), key=<span class="keyword">lambda</span> i: input_list[i], reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(input_list)</span><br><span class="line">    <span class="built_in">print</span>(sorted_indices)</span><br><span class="line">    <span class="keyword">return</span> sorted_indices[:k]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">chunks,embeddeds,top_k, txt</span>):</span><br><span class="line">    embedding = OpenAIEmbeddings(deployment=<span class="string">&quot;embedding&quot;</span>,chunk_size=<span class="number">1</span>)</span><br><span class="line">    embedded_txt = embedding.embed_query(txt)</span><br><span class="line">    distances = [np.dot(embedded_txt,embedded) <span class="keyword">for</span> embedded <span class="keyword">in</span> embeddeds]</span><br><span class="line">    ret_idx = find_k_largest_indices(distances, top_k)</span><br><span class="line">    <span class="keyword">return</span> [chunks[i] <span class="keyword">for</span> i <span class="keyword">in</span> ret_idx]</span><br><span class="line"></span><br><span class="line">search(chunks,embeddeds,<span class="number">2</span>, <span class="string">&quot;提高系统可用性&quot;</span>)</span><br></pre></td></tr></table></figure><p>‍</p><p>向量检索 + GPT</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">anwser_question_with_doc</span>(<span class="params">question, chunks, embeddeds</span>):</span><br><span class="line">    relevent_chunks = search(chunks,embeddeds,<span class="number">2</span>, question)</span><br><span class="line">    prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    仅通过总结以下的文字片段回答用户问题, 注意保持回答的语言通顺（字数在30字以内）</span></span><br><span class="line"><span class="string">    --- </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> rchunks <span class="keyword">in</span> relevent_chunks:</span><br><span class="line">        prompt = prompt + <span class="string">&quot;\n&#x27;&quot;</span> + rchunks + <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">  </span><br><span class="line">    response = openai.ChatCompletion.create(</span><br><span class="line">    engine=deployment, <span class="comment"># engine = &quot;deployment_name&quot;.</span></span><br><span class="line">    messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,   </span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: question&#125;</span><br><span class="line">        ],</span><br><span class="line">        temperature = <span class="number">0.9</span>, </span><br><span class="line">        max_tokens = <span class="number">200</span></span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(anwser_question_with_doc(<span class="string">&quot;如何提高可用性&quot;</span>, chunks,embeddeds))</span><br></pre></td></tr></table></figure><p>‍</p><p>*也可以使用embedding模型辅助实现，embedding model使用<code>nomic-embed-text</code>​</p><blockquote><p>Ollama embedding model</p><p><a href="https://ollama.com/blog/embedding-models">https://ollama.com/blog/embedding-models</a></p><p>‍</p><p>nomic-embed-text model</p><p><a href="https://ollama.com/library/nomic-embed-text">https://ollama.com/library/nomic-embed-text</a></p></blockquote><p>‍</p><p>通过ollama安装模型</p><p>复制命令</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220213540-anf19y3.png" alt="image">​</p><p>‍</p><p>在命令行安装</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220214052-vh76gw4.png" alt="image">​</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250220214331-7pqihxh.png" alt="image">​</p><h3 id="LangChain-Retrieval"><a href="#LangChain-Retrieval" class="headerlink" title="LangChain Retrieval"></a>LangChain Retrieval</h3><p>通过LangChain连接大模型和内部文本</p><p>上面使用了chroma向量数据库，在这一节配合LangChain使用实现分片向量化的整个工作流</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222100908-g99sack.png" alt="image">​</p><p>LangChain Document Loader加载数据</p><p>支持CSV，文件目录，HTML，JSON，PDF，Markdown等多种格式</p><p><a href="https://python.langchain.com/docs/integrations/document_loaders/">https://python.langchain.com/docs/integrations/document_loaders/</a></p><p>‍</p><p>LangChain Retrievers</p><p>更好的文档分片工具</p><p><a href="https://python.langchain.com/docs/integrations/document_transformers/">https://python.langchain.com/docs/integrations/retrievers/</a></p><p>‍</p><p>最后把分片好的数据embed到向量数据库</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222101728-6nouej4.png" alt="image">​</p><p>LangChain提供了<code>RetrievalQA</code>​的方法直接查询向量数据库（Vectordb）</p><p>用户提问 -&gt; 向量数据库检索 -&gt; 构成新的prompt -&gt; 大模型回答</p><p>‍</p><p>这里使用md文档为例</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222114740-ivn5gg8.png" alt="image">​</p><p>‍</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">retriever=vectordb.as_retriever(</span><br><span class="line">    search_type=<span class="string">&quot;mmr&quot;</span>, search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">3</span>&#125;</span><br><span class="line">    <span class="comment">#search_type=&quot;similarity&quot;, search_kwargs=&#123;&quot;k&quot;: 3&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>search_type：根据场景选择适合的参数</p><ul><li>similarity：根据相似性查找，最多查找3个</li><li>mmr（max marginal）：找到三个最相似的，然后根据这三个数据库之间差别最大的，但是跟用户问题又有关联性的问题</li></ul><p>‍</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qa = RetrievalQA.from_chain_type(llm=llm, chain_type=<span class="string">&quot;refine&quot;</span>, retriever=retriever,</span><br><span class="line">                                 return_source_documents=<span class="literal">False</span>, verbose=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>chain_type: 可选值 stuff &#x2F; refine &#x2F; map reduce &#x2F; map re-rank</p><ul><li>要根据企业内部的实际情况和数据特性，尽可能多地测试</li><li>适当做一些定制化的改动以满足需求</li></ul><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222103300-hr9bz2x.png" alt="image">​</p><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222103405-zo9pqum.png" alt="image">​</p><p>‍</p><blockquote><p>源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_retrieval.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_retrieval.ipynb</a></p><p>参考阅读</p><p><a href="https://medium.com/@rahul.dusad/run-rag-pipeline-locally-with-ollama-embedding-model-nomic-embed-text-generate-model-llama3-e7a554a541b3">https://medium.com/@rahul.dusad/run-rag-pipeline-locally-with-ollama-embedding-model-nomic-embed-text-generate-model-llama3-e7a554a541b3</a></p></blockquote><p>‍</p><h2 id="构建多模态Chatbot"><a href="#构建多模态Chatbot" class="headerlink" title="构建多模态Chatbot"></a>构建多模态Chatbot</h2><p>​<img src="/2025/02/22/%E8%AE%A9GPT%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7/image-20250222150709-zlbhx60.png" alt="image">​</p><p>图形生成能力：openai可以使用DALL E2，或者是Stable Diffusion</p><p>Openai api示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> http.client</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_image</span>(<span class="params">prompt</span>):</span><br><span class="line">  api_base = os.getenv(<span class="string">&quot;OPENAI_API_BASE&quot;</span>)</span><br><span class="line">  api_key = os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br><span class="line">  api_version = api_version = <span class="string">&#x27;2022-08-03-preview&#x27;</span></span><br><span class="line"></span><br><span class="line">  url = <span class="string">&quot;&#123;&#125;dalle/text-to-image?api-version=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(api_base, api_version)</span><br><span class="line">  headers= &#123; <span class="string">&quot;api-key&quot;</span>: api_key, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span> &#125;</span><br><span class="line">  body = &#123;</span><br><span class="line">      <span class="string">&quot;caption&quot;</span>: prompt,</span><br><span class="line">      <span class="string">&quot;resolution&quot;</span>: <span class="string">&quot;512x512&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  submission = requests.post(url, headers=headers, json=body)</span><br><span class="line">  operation_location = submission.headers[<span class="string">&#x27;Operation-Location&#x27;</span>]</span><br><span class="line">  retry_after = submission.headers[<span class="string">&#x27;Retry-after&#x27;</span>]</span><br><span class="line">  status = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> (status != <span class="string">&quot;Succeeded&quot;</span>):</span><br><span class="line">      time.sleep(<span class="built_in">int</span>(retry_after))</span><br><span class="line">      response = requests.get(operation_location, headers=headers)</span><br><span class="line">      status = response.json()[<span class="string">&#x27;status&#x27;</span>]</span><br><span class="line">  image_url = response.json()[<span class="string">&#x27;result&#x27;</span>][<span class="string">&#x27;contentUrl&#x27;</span>]</span><br><span class="line">  <span class="comment">#display(Image(url=image_url))</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;\n![image](&quot;</span>+image_url+<span class="string">&quot;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> (create_image(<span class="string">&quot;A dog on the street.&quot;</span>))</span><br></pre></td></tr></table></figure><p>‍</p><blockquote><p>Openai 代码示例</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_all_in_one_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_all_in_one_example.ipynb</a></p></blockquote><p>‍</p><p>‍</p><p>‍</p><p>‍</p><p>‍</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍‍&lt;/p&gt;
&lt;p&gt;*使用DeepSeek API测试&lt;/p&gt;
&lt;h2 id=&quot;Function-Calling&quot;&gt;&lt;a href=&quot;#Function-Calling&quot; class=&quot;headerlink&quot; title=&quot;Function Calling&quot;&gt;&lt;/a&gt;Fun</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
    <category term="DeepSeek" scheme="http://example.com/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>搭建HelloGPT</title>
    <link href="http://example.com/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/"/>
    <id>http://example.com/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/</id>
    <published>2025-02-15T07:49:11.000Z</published>
    <updated>2025-02-15T07:49:26.297Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><h2 id="通过Azure访问GPT"><a href="#通过Azure访问GPT" class="headerlink" title="通过Azure访问GPT"></a>通过Azure访问GPT</h2><p>中国大陆地区不允许访问GPT服务，可以通过微软云搭建GPT服务。</p><p>*微软云首次注册有30天免费体验</p><p><a href="https://azure.microsoft.com/zh-cn/pricing/purchase-options/azure-account/">https://azure.microsoft.com/zh-cn/pricing/purchase-options/azure-account/</a></p><p>‍</p><p>创建OpenAI服务</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125200329-jo21jm7.png" alt="image">​</p><p>‍</p><p>选择部署模型</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125200414-0bcfzdx.png" alt="image">​</p><p>‍</p><p>获取环境变量</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125200526-o69r4x2.png" alt="image">​</p><p>设置到系统配置文件中，也可以在代码中import</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125200541-inoh9dd.png" alt="image">​</p><p>‍</p><p>代码详解</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125200913-vsz9usw.png" alt="image">​</p><ul><li>temperature：针对回答的稳定性设置，0为最稳定</li><li>max_token：设置回答的长度</li></ul><p>‍</p><p>Token计费规则</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125105549-o7q171o.png" alt="image">​</p><p>‍</p><p>模型请求配额</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250125105618-6jmorto.png" alt="image">​</p><h2 id="使用DeepSeekAPI"><a href="#使用DeepSeekAPI" class="headerlink" title="使用DeepSeekAPI"></a><strong>使用DeepSeekAPI</strong></h2><p>可以使用DeepSeek的API作为代替</p><p><a href="https://platform.deepseek.com/sign_in">deepseek open platform</a></p><p><a href="https://chat.deepseek.com/">deepseek free chat</a></p><p>首次注册可以获得免费额度</p><p>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250128103053-btd7xa1.png" alt="image">​</p><p>‍</p><p><a href="https://api-docs.deepseek.com/zh-cn/">API document</a></p><blockquote><p>示例源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_api_example.ipynb">https://github.com/KaloSora/HelloGPT/blob/main/code/gpt_api_example.ipynb</a></p></blockquote><p>‍</p><h2 id="提示词工程"><a href="#提示词工程" class="headerlink" title="提示词工程"></a>提示词工程</h2><p>大模型返回的自然语言无法被程序使用。</p><p>让大模型结合到程序中，让程序能理解大模型返回的结果。</p><h3 id="提示词技巧"><a href="#提示词技巧" class="headerlink" title="提示词技巧"></a>提示词技巧</h3><ul><li>利用反向提示词（如：不使用……）</li><li>规范输出的格式（如指定Json格式，便于程序处理）</li><li>文本规范异常输出的格式（如遇到异常时，返回简单的ERROR，便于程序处理）</li><li>不断迭代提示词</li><li>提示词尽量使用英语</li></ul><p>‍</p><p>DeepSeek官方提示库</p><p><a href="https://api-docs.deepseek.com/zh-cn/prompt-library/">DeepSeek提示库</a></p><p>‍</p><blockquote><p>示例源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_prompt_demo.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_prompt_demo.ipynb</a></p></blockquote><p>‍</p><h2 id="LangChain"><a href="#LangChain" class="headerlink" title="LangChain"></a>LangChain</h2><p>大语言模型中的拓展工具类库，作为大语言模型和应用程序之间的桥梁。</p><blockquote><p>LangChain is a flexible abstractions and extensive toolkit enables developers to harness the power of LLMs.</p></blockquote><p>‍</p><p>安装方式</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install langchain</span><br><span class="line"></span><br><span class="line">pip install langchain-community</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ul><li><p>提示词模板</p></li><li><p>不同程度的上下文记忆</p></li><li><p>大模型调用API</p><ul><li>这种查询方式类似于爬虫，可能会被外部网站阻止，建议使用网站提供的API</li></ul></li><li><p>链式请求</p><ul><li>将复杂的任务分解为更简单的子任务</li><li>​<img src="/2025/02/15/%E6%90%AD%E5%BB%BAHelloGPT/image-20250128163023-kgl4499.png" alt="image">​</li></ul></li></ul><p>‍</p><blockquote><p>示例源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/langchain_demo.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/langchain_demo.ipynb</a></p></blockquote><p>‍</p><h2 id="保持会话状态"><a href="#保持会话状态" class="headerlink" title="保持会话状态"></a>保持会话状态</h2><p>LLM模型本身的对话是无状态的。</p><p>使用<code>Gradio</code>​类库让Chatbot获得记忆，能够根据上下文回答问题。</p><ul><li>能够快速构建原型</li><li>能够保存上下文对话信息</li></ul><p>‍</p><p>安装</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gradio</span><br></pre></td></tr></table></figure><p>‍</p><p>可以使用LangChain的记忆功能，让开发更加简单</p><p>可以尝试不同程度的记忆功能</p><p>例如：ConversationSummaryBufferMemory</p><p>当缓存内容Token超过参数 “max_token_limit” 的值后，就会将超出的会话内容进行总结，这个总结过程也是通过大模型完成的。</p><p>‍</p><p>使用记忆功能的模型：</p><p><strong>优点</strong></p><ul><li>控制了缓存内容的大小</li><li>尽量记忆对话的上下文</li></ul><p>缺点</p><ul><li>在缓存内容超出限制后，为了控制缓存的大小，会持续通过大模型来总结较早的内容，使程序相应的延迟增加</li><li>成本增加</li></ul><p>‍</p><blockquote><p> 示例源代码</p><p><a href="https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_history.ipynb">https://github.com/KaloSora/HelloGPT/blob/dev/code/gpt_langchain_history.ipynb</a></p></blockquote><p>‍</p><h2 id="大模型在企业中的应用畅想"><a href="#大模型在企业中的应用畅想" class="headerlink" title="大模型在企业中的应用畅想"></a>大模型在企业中的应用畅想</h2><p>启发式交互应用：如低代码平台，或自然语言生成代码</p><p>Copilot：AI助手，如微软、Apple的AI助手，或者是企业中的IT系统诊断助手</p><p>大语言模型的推理&#x2F;生成：生成式AI应用</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;h2 id=&quot;通过Azure访问GPT&quot;&gt;&lt;a href=&quot;#通过Azure访问GPT&quot; class=&quot;headerlink&quot; title=&quot;通过Azure访问GPT&quot;&gt;&lt;/a&gt;通过Azure访问GPT&lt;/h2&gt;&lt;p&gt;中国大陆地区不允许访问GPT服务，可以通过</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
    <category term="DeepSeek" scheme="http://example.com/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>Mac DeepSeek本地部署</title>
    <link href="http://example.com/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/"/>
    <id>http://example.com/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/</id>
    <published>2025-02-09T03:11:11.000Z</published>
    <updated>2025-02-09T03:11:25.396Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><blockquote><p>DeepSeek Github开源仓库</p><p><a href="https://github.com/deepseek-ai">https://github.com/deepseek-ai</a></p><p>‍</p><p>R1仓库</p><p><a href="https://github.com/deepseek-ai/DeepSeek-R1">https://github.com/deepseek-ai/DeepSeek-R1</a></p></blockquote><p>‍</p><h2 id="安装Ollama"><a href="#安装Ollama" class="headerlink" title="安装Ollama"></a>安装Ollama</h2><p>Ollama是一个开源框架，专为在本地机器（支持跨平台，如Mac&#x2F;Windows）上便捷部署和运行大语言模型（LLM）而设计。</p><p>*使用的机器为Mac 2018 Pro, Intel CPU，LM Studio不支持。</p><blockquote><p>Ollama下载链接</p><p><a href="https://ollama.com/download/mac">https://ollama.com/download/mac</a></p></blockquote><p>‍</p><p>验证安装结果</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208155744-ss6d35f.png" alt="image">​</p><p>‍</p><h2 id="Ollama载入Deepseek-r1"><a href="#Ollama载入Deepseek-r1" class="headerlink" title="Ollama载入Deepseek-r1"></a>Ollama载入Deepseek-r1</h2><p>在Ollama官网找到R1模型</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208160225-5ukfsvg.png" alt="image">​</p><p>‍</p><p>选择需要的模型，复制命令</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208160323-kngn783.png" alt="image">​</p><p>在命令行里运行对应的命令，会自动下载模型</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208160414-bywa9rp.png" alt="image">​</p><p>‍</p><p>运行结果</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208193550-jd15aq2.png" alt="image">​</p><p>‍</p><h2 id="Chatbox为AI添加UI"><a href="#Chatbox为AI添加UI" class="headerlink" title="Chatbox为AI添加UI"></a>Chatbox为AI添加UI</h2><blockquote><p>Chatbox官网</p><p><a href="https://chatboxai.app/zh">https://chatboxai.app/zh</a></p></blockquote><p>*UI也可以选择Cherry Studio</p><p>选择Ollama API</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208193833-c6ffl5u.png" alt="image">​</p><p>‍</p><p>选择已下载的模型</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208193914-rpsuerz.png" alt="image">​</p><p>‍</p><p>选择你配置好的模型，然后提出你的问题</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250208194057-96fy3y7.png" alt="image">​</p><p>‍</p><h2 id="开启本地联网服务"><a href="#开启本地联网服务" class="headerlink" title="开启本地联网服务"></a>开启本地联网服务</h2><p>安装AnythingLLM</p><p><a href="https://docs.anythingllm.com/installation-desktop/macos">https://docs.anythingllm.com/installation-desktop/macos</a></p><p>‍</p><p>API提供商选择Ollama</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250209094623-o1t509s.png" alt="image">​</p><p>‍</p><p>在设置中找到“代理技能”，开启连网搜索</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250209094943-2vud5jw.png" alt="image">​</p><p>‍</p><p>尝试提出一个2025年2月的事件，并要求deepseek分析其影响</p><p>*这里联网速度和思考速度都比较慢</p><p>​<img src="/2025/02/09/Mac-DeepSeek%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/image-20250209100454-72pvg99.png" alt="image">​</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;DeepSeek Github开源仓库&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/deepseek-ai&quot;&gt;https://github.com/deepseek-ai&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;‍&lt;/p&gt;</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
    <category term="DeepSeek" scheme="http://example.com/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>Windows DeepSeek本地部署</title>
    <link href="http://example.com/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/"/>
    <id>http://example.com/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/</id>
    <published>2025-02-02T07:11:11.000Z</published>
    <updated>2025-02-09T03:16:02.904Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><p>DeepSeek R1 Distill 本地部署相关资料</p><blockquote><p>资料来源 <a href="https://henjihenji.feishu.cn/wiki/MN3Vwl2STigk2qk1r6lcGoY5nYg">https://henjihenji.feishu.cn/wiki/MN3Vwl2STigk2qk1r6lcGoY5nYg</a></p></blockquote><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p>建议使用 NVIDIA 卡，体验会好不少，AMD 显卡未做测试，但应该也是能跑的</p><p>欢迎各位在本文档评论区反馈各自运行情况，这样可以帮到更多人</p><h1 id="LM-Studio"><a href="#LM-Studio" class="headerlink" title="LM Studio"></a>LM Studio</h1><p>官网下载：<a href="https://lmstudio.ai/">https://lmstudio.ai/</a></p><p>夸克网盘：<a href="https://pan.quark.cn/s/f7f610d2ac7a">https://pan.quark.cn/s/f7f610d2ac7a</a></p><h1 id="模型列表"><a href="#模型列表" class="headerlink" title="模型列表"></a>模型列表</h1><p>请选择文件体积小于自己显存大小的模型，略大一些的虽然也能跑，但是速度会慢很多。因个人能力有限，以下模型推荐不一定是最好的</p><p>更多模型下载</p><p>  链接1：<a href="https://www.modelscope.cn/organization/lmstudio-community">https://www.modelscope.cn/organization/lmstudio-community</a></p><p>  记得用搜索功能搜索 DeepSeek 相关模型</p><p>  链接2：<a href="https://www.modelscope.cn/collections/DeepSeek-R1-Distill-GGUF-eec5fee2f2ee42">https://www.modelscope.cn/collections/DeepSeek-R1-Distill-GGUF-eec5fee2f2ee42</a></p><p>  相比链接1会多一点不同量化精度的模型</p><p><strong>点击模型名称可以直接下载</strong></p><table><thead><tr><th>显存大小</th><th>推荐模型</th><th>备注</th></tr></thead><tbody><tr><td>32GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-32B-Q6_K.gguf">DeepSeek-R1-Distill-Qwen-32B-Q6_K.gguf</a></td><td></td></tr><tr><td>24GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-32B-Q4_K_M.gguf">DeepSeek-R1-Distill-Qwen-32B-Q4_K_M.gguf</a><br><a href="https://www.modelscope.cn/models/unsloth/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-32B-Q5_K_M.gguf">DeepSeek-R1-Distill-Qwen-32B-Q5_K_M.gguf</a></td><td>二选一即可，比较推荐第一个<br><a href="https://www.modelscope.cn/models/unsloth/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-32B-Q5_K_M.gguf">Q5</a> 质量上可能会好一点，但是因为太接近 24G 显存，所以上下文多了之后，速度可能会慢。<br>上面的 <a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-32B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-32B-Q6_K.gguf">Q6</a> 勉强也能跑，但速度会比较慢。</td></tr><tr><td>16GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-14B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-14B-Q6_K.gguf">DeepSeek-R1-Distill-Qwen-14B-Q6_K.gguf</a></td><td></td></tr><tr><td>12GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-14B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-14B-Q4_K_M.gguf">DeepSeek-R1-Distill-Qwen-14B-Q4_K_M.gguf</a></td><td></td></tr><tr><td>11GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-14B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-14B-Q4_K_M.gguf">DeepSeek-R1-Distill-Qwen-14B-Q4_K_M.gguf</a></td><td></td></tr><tr><td>8GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-7B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-7B-Q6_K.gguf">DeepSeek-R1-Distill-Qwen-7B-Q6_K.gguf</a><br><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Llama-8B-GGUF/resolve/master/DeepSeek-R1-Distill-Llama-8B-Q6_K.gguf">DeepSeek-R1-Distill-Llama-8B-Q6_K.gguf</a></td><td>二选一即可</td></tr><tr><td>6GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-7B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-7B-Q4_K_M.gguf">DeepSeek-R1-Distill-Qwen-7B-Q4_K_M.gguf</a><br><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Llama-8B-GGUF/resolve/master/DeepSeek-R1-Distill-Llama-8B-Q4_K_M.gguf">DeepSeek-R1-Distill-Llama-8B-Q4_K_M.gguf</a></td><td>二选一即可</td></tr><tr><td>4GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-7B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-7B-Q3_K_L.gguf">DeepSeek-R1-Distill-Qwen-7B-Q3_K_L.gguf</a><br><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-1.5B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-1.5B-Q8_0.gguf">DeepSeek-R1-Distill-Qwen-1.5B-Q8_0.gguf</a></td><td>二选一即可，比较推荐第一个<br>第二个 4G 显存能跑，但可能会比较慢</td></tr><tr><td>3GB、2GB</td><td><a href="https://www.modelscope.cn/models/lmstudio-community/DeepSeek-R1-Distill-Qwen-1.5B-GGUF/resolve/master/DeepSeek-R1-Distill-Qwen-1.5B-Q8_0.gguf">DeepSeek-R1-Distill-Qwen-1.5B-Q8_0.gguf</a></td><td></td></tr></tbody></table><h1 id="如何查看自己的显存"><a href="#如何查看自己的显存" class="headerlink" title="如何查看自己的显存"></a>如何查看自己的显存</h1><p>​<img src="/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/image-20250209100647-xmyvf48.png" alt="image">​</p><table><thead><tr><th>显存大小</th><th>对应N卡型号</th></tr></thead><tbody><tr><td>2GB</td><td>GTX 1050、GT 1030</td></tr><tr><td>3GB</td><td>GTX 1060 3GB</td></tr><tr><td>4GB</td><td>GTX 1050 Ti</td></tr><tr><td>6GB</td><td>GTX 1060 6GB、RTX 2060 6GB、RTX 3050 (6GB)</td></tr><tr><td>8GB</td><td>GTX 1080、GTX 1070 Ti、GTX 1070、RTX 2080 SUPER、RTX 2080、RTX 2070 SUPER、RTX 2070、RTX 2060 SUPER、RTX 3070 Ti、RTX 3070、RTX 3060 Ti、RTX 3060 (8GB)、RTX 3050 (8GB)、RTX 4080、RTX 4060 Ti 8GB、RTX 4060、RTX 5070</td></tr><tr><td>11GB</td><td>GTX 1080 Ti、RTX 2080 Ti</td></tr><tr><td>12GB</td><td>RTX 2060 12GB、RTX 3060 (12GB)、RTX 4070 Ti SUPER、RTX 4070、RTX 5070 Ti</td></tr><tr><td>16GB</td><td>RTX 4060 Ti 16GB、RTX 5080</td></tr><tr><td>24GB</td><td>RTX 3090 Ti、RTX 3090、RTX 4090</td></tr><tr><td>32GB</td><td>RTX 5090</td></tr></tbody></table><p>‍</p><h1 id="本地部署测试"><a href="#本地部署测试" class="headerlink" title="本地部署测试"></a>本地部署测试</h1><p>GPU：AMD Radeon RX580 8G</p><p>CPU：AMD Ryzen 5600X</p><p>内存：16G</p><p>‍</p><p>运行LM Studio</p><p>​<img src="/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/image-20250209110548-fxxeq1n.png" alt="image">​</p><p>‍</p><p>加载本地模型</p><p>注意模型这里直接选根目录，LM Studio会自动搜索</p><p>​<img src="/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/image-20250209110613-zipexwj.png" alt="image">​</p><p>‍</p><p>点击顶部加载模型，开始新的对话</p><p>​<img src="/2025/02/02/Windows-DeepSeek%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA/image-20250209110630-hf4qhqg.png" alt="image">​</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;p&gt;DeepSeek R1 Distill 本地部署相关资料&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;资料来源 &lt;a href=&quot;https://henjihenji.feishu.cn/wiki/MN3Vwl2STigk2qk1r6lcGoY5nYg&quot;&gt;ht</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
    <category term="DeepSeek" scheme="http://example.com/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>Jupyter Notebook</title>
    <link href="http://example.com/2025/01/29/Jupyter-Notebook/"/>
    <id>http://example.com/2025/01/29/Jupyter-Notebook/</id>
    <published>2025-01-29T06:07:11.000Z</published>
    <updated>2025-01-29T06:16:35.669Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="https://jupyter.org/">Jupyter官网</a></p><blockquote><p>JupyterLab是最新的基于web的笔记本、代码和数据交互式开发环境。其灵活的界面允许用户配置和安排数据科学、科学计算、计算新闻和机器学习中的工作流程。模块化设计邀请扩展来扩展和丰富功能。</p></blockquote><p>该工具具有以下特征：</p><ul><li>允许使用markdown语法</li><li>支持快速导出多种文件格式</li><li>支持部署在远程环境</li><li>不仅仅支持Python，也支持Javascript，Ruby等语言</li></ul><p>因此，许多公开课网站和大学课程普遍使用Jupyter分发作业。它也适合机器学习和数据分析，是集编程和写作与一身的工具。</p><p>这种编程方式也可以称为文学编程。</p><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><p>安装命令</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jupyter</span><br></pre></td></tr></table></figure><p>‍</p><p>运行结果</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194112-m528stx.png" alt="image">​</p><p>‍</p><p>运行命令</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="punctuation">[</span>target_folder<span class="punctuation">]</span></span><br><span class="line">jupyter notebook</span><br></pre></td></tr></table></figure><p>‍</p><p>运行结果</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194224-8owk4qo.png" alt="image">​</p><p>浏览器输入<code>http://localhost:8888/</code>​访问Jupyter</p><p>‍</p><p>创建新Python文件，并运行第一行测试代码</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194421-wre78l2.png" alt="image">​</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194624-s0xokbq.png" alt="image">​</p><p>‍</p><p>在本地目录检查新文件</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194833-rsd6qx2.png" alt="image">​</p><p>‍</p><p>Jupyter文件支持导出多种格式</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194946-9pknd69.png" alt="image">​</p><p>‍</p><p>输入<code>h</code>​查看所有快捷键</p><p>​<img src="/2025/01/29/Jupyter-Notebook/image-20250125194351-1zd7ao9.png" alt="image">​</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://jupyter.org/&quot;&gt;Jupyter官网&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;</summary>
      
    
    
    
    <category term="AI/ML" scheme="http://example.com/categories/AI-ML/"/>
    
    
    <category term="Python" scheme="http://example.com/tags/Python/"/>
    
    <category term="LLM" scheme="http://example.com/tags/LLM/"/>
    
  </entry>
  
  <entry>
    <title>AWS Terraform Section4 - Project</title>
    <link href="http://example.com/2024/06/30/AWS-Terraform-Section4-Project/"/>
    <id>http://example.com/2024/06/30/AWS-Terraform-Section4-Project/</id>
    <published>2024-06-30T02:27:54.000Z</published>
    <updated>2024-06-30T02:36:59.204Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><p>创建Git仓库用于存放Terraform代码</p><p>创建.gitignore</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ignore local .terraform dir</span><br><span class="line">.terraform/*</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><p>目标：创建一个EC2实例，并且在EC2里运行一个nginx docker容器</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240627220019-nclsrwk.png" alt="image">​</p><p>‍</p><p>需要创建的AWS资源</p><p>*最好不要使用默认的AWS资源</p><ol><li>创建VPC</li><li>创建Subnet</li><li>创建Route Table &amp; Internet Gateway</li><li>创建EC2</li><li>部署nginx docker容器</li><li>创建Security Group(Firewall)，并允许ssh</li></ol><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240627220353-vawsy7w.png" alt="image">​</p><p>‍</p><h2 id="创建VPC-Subnet"><a href="#创建VPC-Subnet" class="headerlink" title="创建VPC &amp; Subnet"></a>创建VPC &amp; Subnet</h2><p>terraform.tfvars</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vpc_cidr_block = &quot;10.0.0.0/16&quot;</span><br><span class="line">subnet_cidr_block = &quot;10.0.0.0/24&quot;</span><br><span class="line">avail_zone = &quot;eu-west-3b&quot;</span><br><span class="line">env_prefix = &quot;dev&quot;</span><br></pre></td></tr></table></figure><p>‍</p><p>main.tf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-west-3&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable vpc_cidr_block &#123;&#125;</span><br><span class="line">variable subnet_cidr_block &#123;&#125;</span><br><span class="line">variable avail_zone &#123;&#125;</span><br><span class="line">variable env_prefix &#123;&#125;</span><br><span class="line"></span><br><span class="line"># 创建VPC</span><br><span class="line">resource &quot;aws_vpc&quot; &quot;myapp-vpc&quot; &#123;</span><br><span class="line">  cidr_block = var.vpc_cidr_block</span><br><span class="line"></span><br><span class="line">  # vpc名称带有&quot;vpc&quot;前缀</span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name: &quot;$&#123;var.env_prefix&#125;-vpc&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建Subnet</span><br><span class="line">resource &quot;aws_subnet&quot; &quot;myapp-subnet-1&quot; &#123;</span><br><span class="line">  vpc_id = aws_vpc.myapp-vpc.id</span><br><span class="line">  cidr_block = var.vpc_cidr_block</span><br><span class="line">  availability_zone = var.avail_zone</span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name: &quot;$&#123;var.env_prefix&#125;-subnet-1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>在AWS上查看结果</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240627221856-zq53z7g.png" alt="image">​</p><p>‍</p><h2 id="Route-Table"><a href="#Route-Table" class="headerlink" title="Route Table"></a>Route Table</h2><p>Route table决定了VPC转发的目的地</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629093707-g015c9a.png" alt="image">​</p><p>‍</p><p>在Terraform code不必根据执行的先后来编写代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 创建Route table</span><br><span class="line">resource &quot;aws_route_table&quot; &quot;myapp-route-table&quot; &#123;</span><br><span class="line">  vpc_id = aws_vpc.myapp-vpc.id</span><br><span class="line"></span><br><span class="line">  route = &#123;</span><br><span class="line">    cidr_block = &quot;0.0.0.0/0&quot;</span><br><span class="line">    gateway_id = aws_internet_gateway.myapp-igw.id</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name: &quot;$&#123;var.env_prefix&#125;-rtb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Route table gateway</span><br><span class="line">resource &quot;aws_internet_gateway&quot; &quot;myapp-igw&quot; &#123;</span><br><span class="line">  vpc_id = aws_vpc.myapp-vpc.id</span><br><span class="line"></span><br><span class="line">    tags = &#123;</span><br><span class="line">    Name: &quot;$&#123;var.env_prefix&#125;-igw&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>执行结果</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629095048-bxhndn1.png" alt="image">​</p><p>‍</p><p>同时还要为Route table和Subnet创建关联</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629095414-dwpb65b.png" alt="image">​</p><p>Terraform code</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Route table &amp; Subnect</span><br><span class="line">resource &quot;aws_route_table_association&quot; &quot;a-rtb-subnet&quot; &#123;</span><br><span class="line">  subnet_id = aws_subnet.myapp-subnet-1.id</span><br><span class="line">  route_table_id = aws_route_table.myapp-route-table.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h2 id="Security-Group-Firewall"><a href="#Security-Group-Firewall" class="headerlink" title="Security Group &amp; Firewall"></a>Security Group &amp; Firewall</h2><p>创建安全组</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629100936-owifg74.png" alt="image">​</p><p>Terraform code</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># Security Group</span><br><span class="line">resource &quot;aws_security_group&quot; &quot;myapp-sg&quot; &#123;</span><br><span class="line">  name = &quot;myapp-sg&quot;</span><br><span class="line">  vpc_id = aws_vpc.myapp-vpc.id</span><br><span class="line">  </span><br><span class="line">  # Incoming traffic</span><br><span class="line">  ingress = &#123;</span><br><span class="line">    from_port = 22</span><br><span class="line">    to_port = 22</span><br><span class="line">    protocal = &quot;tcp&quot;</span><br><span class="line"></span><br><span class="line">    # IPs allow list</span><br><span class="line">    cidr_block = [&quot;your_allow_ip/32&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  # Outgoing traffic</span><br><span class="line">  egress = &#123;</span><br><span class="line">    # Allowing all port and ip</span><br><span class="line">    from_port = 0</span><br><span class="line">    to_port = 0</span><br><span class="line">    protocal = &quot;-1&quot;</span><br><span class="line">    cidr_block = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">    prefix_list_ids = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name: &quot;$&#123;var.env_prefix&#125;-sg&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>执行结果</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629101551-0c9lczq.png" alt="image">​</p><p>‍</p><h2 id="EC2-AMI"><a href="#EC2-AMI" class="headerlink" title="EC2 &amp; AMI"></a>EC2 &amp; AMI</h2><p>Amazon Machine Image(AMI)是aws提供的操作系统镜像，用户可以根据AMI创建自己的操作系统实例。</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629102443-vk9vmei.png" alt="image">​</p><p>‍</p><p>Terraform code</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># AWS AMI data definition</span><br><span class="line">data &quot;aws_ami&quot; &quot;latest_aws-linux-image&quot; &#123;</span><br><span class="line">  # Always get latest image</span><br><span class="line">  most_recent = true</span><br><span class="line"></span><br><span class="line">  owners = [&quot;amazon&quot;]</span><br><span class="line">  </span><br><span class="line">  # filter image name with regrex</span><br><span class="line">  filter &#123;</span><br><span class="line">    name = &quot;name&quot;</span><br><span class="line">    values = [&quot;amzn2-ami-hvm-*-x86_64_gp2&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  filter &#123;</span><br><span class="line">    name = &quot;virtualization-type&quot;</span><br><span class="line">    values = [&quot;hvm&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Only test for ami id output</span><br><span class="line"># When execute &quot;terraform plan&quot;, can see value from console</span><br><span class="line"># output &quot;name&quot; &#123;</span><br><span class="line">#   value = data.aws_ami.latest_aws-linux-image</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># 创建aws key pair</span><br><span class="line">resource &quot;aws_key_pair&quot; &quot;ssh-key&quot; &#123;</span><br><span class="line">  key_name = &quot;server-key&quot;</span><br><span class="line"></span><br><span class="line">  # 引用文件</span><br><span class="line">  public_key = &quot;$&#123;file(&quot;/User/xxx/.ssh/key_file.pub&quot;)&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建操作系统实例 - EC2</span><br><span class="line">resource &quot;aws_instance&quot; &quot;myapp-server&quot; &#123;</span><br><span class="line">  # Id of ami</span><br><span class="line">  ami = data.aws_ami.latest_aws-linux-image.id</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line"></span><br><span class="line">  # 引用已经创建好的VPC &amp; Subnect</span><br><span class="line">  subnet_id = aws_subnet.myapp-subnet-1.id</span><br><span class="line">  vpc_security_group_ids = [aws_default_security_group.default-sg.id]</span><br><span class="line">  availability_zone = var.avail_zone</span><br><span class="line">  associate_public_ip_address = true</span><br><span class="line"></span><br><span class="line">  # Server key pair, permission should be 400</span><br><span class="line">  # AWS will reject ssh request if permission not set correctly</span><br><span class="line">  # It&#x27;s generate from AWS console, provide the key file name</span><br><span class="line">  key_name = aws_key_pair.ssh-key.key_name </span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;$&#123;var.env_prefix&#125;-server&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>等待EC2创建</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629145356-5h7sdlf.png" alt="image">​</p><p>‍</p><h3 id="EC2-initialize-script"><a href="#EC2-initialize-script" class="headerlink" title="EC2 initialize script"></a>EC2 initialize script</h3><p>添加 <code>user_data=</code>​，设置EC2初始化时自动运行脚本</p><p>下图中的代码块只会在初始化的时候被执行一次</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629152214-ngas3tc.png" alt="image">​</p><p>‍</p><p>如果需要执行定义好的脚本而不是代码块，可以使用如下方式</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629152738-j165ka4.png" alt="image">​</p><p>‍</p><p><strong>另一种方式：使用Provisioner执行脚本</strong></p><p>使用<code>remote-exec</code>​在EC2上执行脚本</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629154524-8ou2ulm.png" alt="image">​</p><p>‍</p><p>可以使用<code>local-exec</code>​在本地机器上执行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">provisioner &quot;local-exec&quot; &#123;</span><br><span class="line">  command = &quot;echo $&#123;self.public_ip&#125; &gt; output.txt&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>Terraform文档上说明<code>Provisioners</code>​是没有其他选择时的最后手段</p><ul><li>尽量采用<code>user_data</code>​而不是<code>Provisioners</code>​</li><li>尽量使用”local provider”取代<code>local-exec</code>​</li><li>尽量采用配置管理工具取代<code>Provisioners</code>​，如Ansible, Jenkins</li></ul><p>实际上<code>Provisioners</code>​打破了Terraform的概念。Terraform能通过相同的组件状态总是提供一致的返回结果，但是<code>Provisioners</code>​执行的脚本却是未知的，Terraform无法获取到其中的状态。</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629155206-cpb6z6n.png" alt="image">​</p><p>‍</p><p>一种可能的情况是，Provisioner中的脚本执行错误，此时terraform不会返回具体的状态信息。</p><p>这种状态下无法得知EC2具体是否被创建</p><p>​<img src="/2024/06/30/AWS-Terraform-Section4-Project/image-20240629160318-0x1irb3.png" alt="image">​</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;p&gt;创建Git仓库用于存放Terraform代码&lt;/p&gt;
&lt;p&gt;创建.gitignore&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span clas</summary>
      
    
    
    
    <category term="AWS Terraform" scheme="http://example.com/categories/AWS-Terraform/"/>
    
    
    <category term="AWS" scheme="http://example.com/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>AWS Terraform Section3 - Input and Output</title>
    <link href="http://example.com/2024/06/29/AWS-Terraform-Section3-Input-and-Output/"/>
    <id>http://example.com/2024/06/29/AWS-Terraform-Section3-Input-and-Output/</id>
    <published>2024-06-29T07:20:11.000Z</published>
    <updated>2024-06-30T02:24:49.755Z</updated>
    
    <content type="html"><![CDATA[<p>‍</p><h2 id="Terraform-output"><a href="#Terraform-output" class="headerlink" title="Terraform output"></a>Terraform output</h2><p>示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_subnet&quot; &quot;dev-subnet-1&quot; &#123;</span><br><span class="line">    # 指定subnet所属的VPC</span><br><span class="line">    # 目前VPC还没创建，所以需要动态引用定义的资源</span><br><span class="line">    vpc_id = aws_pvc.development-vpc.id</span><br><span class="line"></span><br><span class="line">    # 定义VPC地址范围的子集</span><br><span class="line">    cidr_block = &quot;10.0.10.0/24&quot;</span><br><span class="line"></span><br><span class="line">    availability_zone = &quot;eu-west-3a&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">output &quot;dev-subnet-id&quot; &#123;</span><br><span class="line">    value = aws_subnet.dev-subnet-1.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan</span><br></pre></td></tr></table></figure><p>‍</p><p>可以看到控制台输出了<code>output</code>​中定义的值</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627085444-muswq4x.png" alt="image">​</p><p>‍</p><p>*可以使用vscode编写Terraform code，该工具支持打开终端</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240629162626-a5xvcbc.png" alt="image">​</p><p>‍</p><h2 id="Terraform-input"><a href="#Terraform-input" class="headerlink" title="Terraform input"></a>Terraform input</h2><p>在Terraform中引用变量</p><ul><li>通过<code>default</code>​给定默认值</li><li>通过<code>type</code>​设置变量类型，如list(string), string, object等</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;subnet_cidr_block&quot; &#123;</span><br><span class="line">    description = &quot;subnet cidr block&quot;</span><br><span class="line">default=&quot;10.0.10.0/24&quot;</span><br><span class="line">type = string</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">resource &quot;aws_subnet&quot; &quot;dev-subnet-1&quot; &#123;</span><br><span class="line">    vpc_id = aws_pvc.development-vpc.id</span><br><span class="line">    cidr_block = var.subnet_cidr_block</span><br><span class="line"></span><br><span class="line">    availability_zone = &quot;eu-west-3a&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>Object示例</p><p>terraform.tfvars</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cidr_blocks = [</span><br><span class="line">&#123;cidr_block-=&quot;10.0.0.0/16&quot;, name=&quot;dev-vpc&quot;&#125;, </span><br><span class="line">&#123;cidr_block-=&quot;10.0.0.0/16&quot;, name=&quot;dev-vpc&quot;&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>‍</p><p>变量定义方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;cidr_blocks&quot; &#123;</span><br><span class="line">  type = list(object(&#123;</span><br><span class="line">    cidr_block = string</span><br><span class="line">    name = string</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>引用方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_pvc&quot; &quot;development-vpc&quot; &#123;</span><br><span class="line"></span><br><span class="line">    cider_block = var.cider_block[0].cider_block</span><br><span class="line">    tags = &#123;</span><br><span class="line">        Name: var.cider_block[0].name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="变量的赋值方式"><a href="#变量的赋值方式" class="headerlink" title="变量的赋值方式"></a>变量的赋值方式</h3><h4 id="通过控制台输入"><a href="#通过控制台输入" class="headerlink" title="通过控制台输入"></a>通过控制台输入</h4><p>直接执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply</span><br></pre></td></tr></table></figure><p>‍</p><p>然后在控制台输入内容</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627090358-a0f77fr.png" alt="image">​</p><p>‍</p><h4 id="命令行传参数"><a href="#命令行传参数" class="headerlink" title="命令行传参数"></a>命令行传参数</h4><p>在控制台执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform -var &quot;subnet_cidr_block=10.0.30.0/24&quot;</span><br></pre></td></tr></table></figure><p>‍</p><h4 id="（常用）定义变量文件"><a href="#（常用）定义变量文件" class="headerlink" title="（常用）定义变量文件"></a>（常用）定义变量文件</h4><p>当执行如下命令时</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -var-file terraform-dev.tfvars --target=module.xxx</span><br></pre></td></tr></table></figure><p>变量传递链路如下</p><p>​<code>*.tfvars</code>​ -&gt; variable.tf -&gt; main.tf -&gt; output.tf</p><p>‍</p><p>例如：</p><p>创建一个<code>*.tfvars</code>​的文件，例如terraform.tfvars</p><p>Terraform能自动找到<code>tfvars</code>​并识别为变量文件</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627091135-d3dfmv2.png" alt="image">​</p><p>‍</p><p>执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply</span><br></pre></td></tr></table></figure><p>‍</p><p>此时不需要额外输入变量的值，Terraform会自动找到变量并且赋值</p><p>‍</p><p>推荐把变量文件根据环境来命名</p><p>例如 terraform-dev.tfvars</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627091655-ofb3joh.png" alt="image">​</p><p>指定变量文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply -var-file terraform-dev.tfvars</span><br></pre></td></tr></table></figure><p>‍</p><h2 id="AWS-Credential"><a href="#AWS-Credential" class="headerlink" title="AWS Credential"></a>AWS Credential</h2><p>不推荐以下方式明文写入access key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-west-3&quot; # 取决于购买的EC2实例所属的区域</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    不推荐hardcode明文的key</span><br><span class="line">    **/</span><br><span class="line">    access_key = &quot;&quot;</span><br><span class="line">    secret_key = &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>1.可以使用环境变量的方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export AWS_SECRET_ACCESS = &quot;XXXX&quot;</span><br><span class="line">export AWS_ACCESS_KEY_ID = &quot;XXXX&quot;</span><br></pre></td></tr></table></figure><p>‍</p><p>然后直接执行terraform命令，会自动连接到AWS</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627212211-b63szv1.png" alt="image">​</p><p>‍</p><p>2.在文件中存储以便全局调用</p><p>存储位置： <code>~/.aws/credentials</code>​</p><p>可以直接输入 aws configure进行配置，自动存储到 <code>~/.aws/credentials</code>​</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627212506-aehf3ue.png" alt="image">​</p><p>‍</p><p>也可以设置AWS_DEFAULT_REGION指定默认的区域</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627212919-krbqr1f.png" alt="image">​</p><p>‍</p><p>3.可以通过安装adfs登录AWS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python install adf-assume</span><br></pre></td></tr></table></figure><p>‍</p><p>执行以下脚本一键连接到AWS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">source [python_env]</span><br><span class="line">echo -n &quot;Input AWS password: &quot;</span><br><span class="line">read -s AWS_PASSWORD</span><br><span class="line">export AWS_PROFILE=saml</span><br><span class="line">adfs-assume -u $ACCOUNT --domain=$DOMAIN</span><br></pre></td></tr></table></figure><h2 id="Global-Variable"><a href="#Global-Variable" class="headerlink" title="Global Variable"></a>Global Variable</h2><p>命名规则必须为：<code>TF_VAR_xxx</code>​</p><p>‍</p><p>例如，需要引用操作系统当前环境下的某个变量</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627213207-7vyobna.png" alt="image">​</p><p>在Terraform中引用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">variable avail_zone &#123;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">resource &quot;aws_subnet&quot; &quot;dev-subnet-1&quot; &#123;</span><br><span class="line">  availability_zone = var.avail_zone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>执行结果</p><p>可以看到自动识别到了变量 avail_zone 自动匹配到了 TF_VAR_avail_zone</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240627213338-wu1puwy.png" alt="image">​</p><p>‍</p><h2 id="Terraform-Module"><a href="#Terraform-Module" class="headerlink" title="Terraform Module"></a>Terraform Module</h2><p>通过模块的方式编写，而不是将所有的代码都放在同一个<code>tf</code>​文件中</p><p>一个module应该将多个resource整合起来，方便相同的组件重用</p><p>例如VPC、Subnet、Route table、Internate gateway都应该放到同一个module中，方便创建EC2时直接调用</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240629160704-lusjo4f.png" alt="image">​</p><p>‍</p><p>同时Terraform也有一些现成的module方便参考，不需要重复创造功能相同的模块</p><p><a href="https://registry.terraform.io/browse/modules">https://registry.terraform.io/browse/modules</a></p><p>‍</p><h2 id="Terraform-state"><a href="#Terraform-state" class="headerlink" title="Terraform state"></a>Terraform state</h2><p>Terraform plan会根据state文件生成执行计划</p><p>最好把<code>tfstate</code>​存放起来远程访问，确保Jenkins和团队成员本地执行都能读取到最新的状态</p><p>AWS可以使用S3存储</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240629165547-mwpen00.png" alt="image">​</p><p>‍</p><p>例如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建S3</span><br><span class="line">terraform &#123;</span><br><span class="line">  required_version = &quot;&gt;=0.12&quot;</span><br><span class="line">  backend &quot;s3&quot; &#123;</span><br><span class="line">    bucket = &quot;myapp-bucket&quot;</span><br><span class="line">    key = &quot;myapp/state.tfstate&quot;</span><br><span class="line">    region = &quot;eu-west-3&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>在创建的时候会询问是否把状态存储到S3<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240629170359-36haj4u.png" alt="image">​</p><p>‍</p><p>此时state文件将交给AWS控制，Jenkins和开发人员本地会自动使用S3的state文件</p><p>​<img src="/2024/06/29/AWS-Terraform-Section3-Input-and-Output/image-20240629170604-2elttg6.png" alt="image">​</p><p>‍</p><p>使用如下命令验证，不同的环境执行应该得到相同的结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform state list</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;‍&lt;/p&gt;
&lt;h2 id=&quot;Terraform-output&quot;&gt;&lt;a href=&quot;#Terraform-output&quot; class=&quot;headerlink&quot; title=&quot;Terraform output&quot;&gt;&lt;/a&gt;Terraform output&lt;/h2&gt;&lt;p&gt;示例&lt;/p</summary>
      
    
    
    
    <category term="AWS Terraform" scheme="http://example.com/categories/AWS-Terraform/"/>
    
    
    <category term="AWS" scheme="http://example.com/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>AWS Terraform Section2 - VPC</title>
    <link href="http://example.com/2024/06/23/AWS-Terraform-Section2-VPC/"/>
    <id>http://example.com/2024/06/23/AWS-Terraform-Section2-VPC/</id>
    <published>2024-06-23T03:20:03.000Z</published>
    <updated>2024-06-30T02:29:24.441Z</updated>
    
    <content type="html"><![CDATA[<h2 id="VPC-Subnet"><a href="#VPC-Subnet" class="headerlink" title="VPC &amp; Subnet"></a>VPC &amp; Subnet</h2><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621090538-0t4qsb0.png" alt="image">​</p><p>‍</p><p>每当一个账户在区域创建时，都会拥有一个AWS VPC（Virtual Private Cloud）</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621090636-8pfda8m.png" alt="image">​</p><p>‍</p><p>跟随区域，跟随AWS账户默认创建，用于保护每个账户的私有资源访问权限</p><p>例如不同的账户可能创建在同一台物理服务器上，但是不同的账号间的资源访问是互相隔离的</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621091018-bj1wwsq.png" alt="image">​</p><p>‍</p><p>控制台可以看到默认创建的VPC</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621090729-glyury5.png" alt="image">​</p><p>‍</p><p>VPC代表了公司的网络架构，包括网络配置、路由、防火墙等</p><p>VPC由不同的<code>Availability Zone</code>​组成，具体指代实际的物理服务器所在的数据中心</p><p>例如 我在中国区，可能会有华南、华中、华北3个数据中心都有虚拟服务器运行，那么就会有3个<code>Availability Zone</code>​，也就会有3个subnet</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621091717-r6rsa9e.png" alt="image">​</p><p>‍</p><p>当我们需要从外部访问资源时，需要配置一个公共IP地址，可以使用<code>Internet Gateway</code>​</p><p>当我们需要控制外部对VPC访问权限，可以配置防火墙</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621092301-v45hvvl.png" alt="image">​</p><p>‍</p><h3 id="配置外部访问"><a href="#配置外部访问" class="headerlink" title="配置外部访问"></a>配置外部访问</h3><p>设置防火墙规则和安全组</p><p>VPC -&gt; SECURITY</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240621092558-4chx80a.png" alt="image">​</p><p>‍</p><h2 id="添加VPC资源"><a href="#添加VPC资源" class="headerlink" title="添加VPC资源"></a>添加VPC资源</h2><p>资源命名规则:  aws_[resource_name]</p><p>‍</p><p>所有的语法示例都能在文档中找到</p><p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc">https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc</a></p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623100755-9y6u10a.png" alt="image">​</p><p>‍</p><p>代码示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-west-3&quot; # 取决于购买的EC2实例所属的区域</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    不推荐hardcode明文的key</span><br><span class="line">    **/</span><br><span class="line">    access_key = &quot;&quot;</span><br><span class="line">    secret_key = &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 资源命名规则 - aws_resource</span><br><span class="line"># 创建名为 development-vpc的VPC</span><br><span class="line">resource &quot;aws_pvc&quot; &quot;development-vpc&quot; &#123;</span><br><span class="line"></span><br><span class="line">    # VPC地址范围</span><br><span class="line">    cider_block = &quot;10.0.0.0/16&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建名为 dev-subnet-1 的subnet</span><br><span class="line">resource &quot;aws_subnet&quot; &quot;dev-subnet-1&quot; &#123;</span><br><span class="line">    # 指定subnet所属的VPC</span><br><span class="line">    # 目前VPC还没创建，所以需要动态引用定义的资源</span><br><span class="line">    vpc_id = aws_pvc.development-vpc.id</span><br><span class="line"></span><br><span class="line">    # 定义VPC地址范围的子集</span><br><span class="line">    cidr_block = &quot;10.0.10.0/24&quot;</span><br><span class="line"></span><br><span class="line">    availability_zone = &quot;eu-west-3a&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>通过执行如下命令应用到AWS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform apply</span><br></pre></td></tr></table></figure><p>‍</p><p>执行命令以后可以预览terraform的执行计划，然后输入<code>yes</code>​确认该计划</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623101644-fx9ybbf.png" alt="image">​</p><p>‍</p><h3 id="DataSource"><a href="#DataSource" class="headerlink" title="DataSource"></a>DataSource</h3><p>假如我们需要从已有的VPC中创建subnet，则需要先拉取AWS已有的VPC信息，然后引用其id</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623102401-7sfq2ts.png" alt="image">​</p><p>‍</p><p>示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 拉取aws数据</span><br><span class="line"># 定义变量名为 existing_vpc 的vpc数据源</span><br><span class="line">data &quot;aws_vpc&quot; &quot;existing_vpc&quot; &#123;</span><br><span class="line"></span><br><span class="line">    # 拉取默认的vpc</span><br><span class="line">    default = true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建名为 dev-subnet-1 的subnet</span><br><span class="line">resource &quot;aws_subnet&quot; &quot;dev-subnet-2&quot; &#123;</span><br><span class="line">    # 从已有的vpc中获取id</span><br><span class="line">    vpc_id = data.aws_vpc.existing_vpc.id</span><br><span class="line"></span><br><span class="line">    # 定义VPC地址范围的子集</span><br><span class="line">    # 不应与vpc中的已有subnet ip范围重复</span><br><span class="line">    cidr_block = &quot;172.31.48.0/20&quot;</span><br><span class="line"></span><br><span class="line">    availability_zone = &quot;eu-west-3a&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>执行 terraform apply</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623103153-6tu25vy.png" alt="image">​</p><p>‍</p><h2 id="修改-删除资源"><a href="#修改-删除资源" class="headerlink" title="修改 &amp; 删除资源"></a>修改 &amp; 删除资源</h2><p>继续以AWS VPC为例</p><h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>使用关键字<code>tags</code>​，它存在于所有的资源中</p><p>例如，指定VPC名称</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623104620-e98o9gy.png" alt="image">​</p><p>在应用tf文件的时候，<code>~</code>​代表资源修改，<code>+</code>​代表新增</p><p>并且在执行计划中有8个属性保持不变</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623105005-f2r9sza.png" alt="image">​</p><p>‍</p><p>将会在控制台显示名称</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623104640-82dkf08.png" alt="image">​</p><p>‍</p><p>如果删除掉<code>tags</code>​，那么在执行计划中会以<code>-</code>​显示</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623105243-u2uvsfs.png" alt="image">​</p><p>‍</p><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><h4 id="修改tf"><a href="#修改tf" class="headerlink" title="修改tf"></a>修改tf</h4><p> *<strong>推荐使用配置文件的方式，配置文件方便代码管理</strong></p><p>如果把<code>*.tf</code>​中的subnet删除，执行 terraform apply，则意味着删除该subnet</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623105535-ysouex2.png" alt="image">​</p><p>‍</p><p>执行计划如下</p><p>可以看到整个资源都标有<code>-</code>​，因为这个资源即将被删除</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623105738-ldw0dxg.png" alt="image">​</p><p>‍</p><h4 id="terraform-destroy"><a href="#terraform-destroy" class="headerlink" title="terraform destroy"></a>terraform destroy</h4><p>执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform destroy -target [resource_type] [resource_name]</span><br></pre></td></tr></table></figure><p>‍</p><p>例如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform destroy -target aws_subnet dev-subnet-2</span><br></pre></td></tr></table></figure><p>‍</p><p>可以看到执行计划也是类似的</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623110048-4j3479w.png" alt="image">​</p><p>‍</p><h2 id="对比差异"><a href="#对比差异" class="headerlink" title="对比差异"></a>对比差异</h2><p>检查aws和tf文件的差异</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform plan</span><br></pre></td></tr></table></figure><p>示例</p><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623110453-hpt2fxs.png" alt="image">​</p><p>‍</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>provider: 用于导入一组或一段代码，类似import library</li><li>resource: 类似于从库中调用一段函数</li><li>data: 类似于返回已经存在的资源的函数</li></ul><p>​<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623103603-vixezkm.png" alt="image">​</p><p>‍</p><p>需要注意的是，这里的用户必须具有创建资源所必须的权限<img src="/2024/06/23/AWS-Terraform-Section2-VPC/image-20240623103705-nm2hmts.png" alt="image">​</p><p>‍</p><p>另外，terraform在apply相同的tf文件的时候，会自动检查所有组件的状态</p><p>如果组件已经存在，则terraform不会再执行操作</p><p>也就是说每当应用相同的配置时，总会得到一样的结果。用户不需要记住当前组件的状态，也不会意外地破坏某些原有的组件。</p><p>‍</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;VPC-Subnet&quot;&gt;&lt;a href=&quot;#VPC-Subnet&quot; class=&quot;headerlink&quot; title=&quot;VPC &amp;amp; Subnet&quot;&gt;&lt;/a&gt;VPC &amp;amp; Subnet&lt;/h2&gt;&lt;p&gt;​&lt;img src=&quot;/2024/06/23/AWS</summary>
      
    
    
    
    <category term="AWS Terraform" scheme="http://example.com/categories/AWS-Terraform/"/>
    
    
    <category term="AWS" scheme="http://example.com/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>AWS Terraform Section1 - 简介</title>
    <link href="http://example.com/2024/06/23/AWS-Terraform-Section1/"/>
    <id>http://example.com/2024/06/23/AWS-Terraform-Section1/</id>
    <published>2024-06-23T03:13:21.000Z</published>
    <updated>2024-06-30T02:31:47.218Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>官网 <a href="https://developer.hashicorp.com/terraform/intro">https://developer.hashicorp.com/terraform/intro</a></p><p>Infrastructure as Code tool.</p><p>Terraform本质上是通过调用API实现对各种服务器资源的CRUD操作。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621083744-cph8xt3.png" alt="image">​</p><p>Terraform主要是用于架构的编排，譬如创建EC2，设置VPC，安装docker等，而且其中的顺序必须要遵循一定的顺序。</p><p>另一个IaC工具是Ansible。Ansible可以用来配置基础设置、部署应用、安装和更新应用等</p><p>Terraform创建并测试完后，可以精确自动化地复制更多的环境。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617213010-g7rnt9g.png" alt="image">​</p><p>‍<img src="/2024/06/23/AWS-Terraform-Section1/image-20240629153340-5rpwr4n.png" alt="image">​</p><p>‍</p><h2 id="安装Terraform"><a href="#安装Terraform" class="headerlink" title="安装Terraform"></a>安装Terraform</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install terraform</span><br></pre></td></tr></table></figure><p>‍</p><p>查看Terraform版本号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform -v</span><br></pre></td></tr></table></figure><p>‍</p><p>安装结果如下</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617213642-gi9trte.png" alt="image">​</p><p>‍</p><h2 id="初始化AWS环境"><a href="#初始化AWS环境" class="headerlink" title="初始化AWS环境"></a>初始化AWS环境</h2><ul><li>连接到AWS账户</li><li>创建VPC</li><li>创建Subnet</li></ul><h3 id="本地环境设置"><a href="#本地环境设置" class="headerlink" title="本地环境设置"></a>本地环境设置</h3><p>创建名为<code>Terraformed</code>​的文件夹，并在其中创建文件<code>main.tf</code>​</p><p>​<code>*.tf</code>​是Terraform文件的标准命名方式</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617214824-h3zyfo9.png" alt="image">​</p><p>‍</p><p>使用Visual Studio Code打开<code>main.tf</code>​，并且安装Terraform官方插件。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617215049-jdiqpkh.png" alt="image">​</p><p>‍</p><p>安装完插件以后可以在VS Code中更方便地编辑Terraform文件</p><p>‍</p><h3 id="注册AWS云账号"><a href="#注册AWS云账号" class="headerlink" title="注册AWS云账号"></a>注册AWS云账号</h3><p>注册完毕后可以免费使用AWS云计算资源</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617215341-n63hg26.png" alt="image">​</p><p>‍</p><p>注册完毕后会自动创建root用户，此时应该通过IAM创建一个权限较低的管理员账户，并通过管理员账户管理普通账户。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082633-pze0qoe.png" alt="image">​</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082734-ltw8n4d.png" alt="image">​</p><p>添加group或者选择”Attach existing policies directly”勾选需要赋予的权限</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082909-kl5bllb.png" alt="image">​</p><p>‍</p><h3 id="Terraform连接到AWS"><a href="#Terraform连接到AWS" class="headerlink" title="Terraform连接到AWS"></a>Terraform连接到AWS</h3><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621083520-o2agtmi.png" alt="image">​</p><p>‍</p><p>Providers作为Terraform中最重要的关键字，用于标识需要调用的远程云服务供应商API</p><p>Providers列表如下，支持许多的云服务供应商</p><p>支持的资源供应商列表 <a href="https://registry.terraform.io/browse/providers">https://registry.terraform.io/browse/providers</a></p><p>包括云服务、Devops工具(Ansible、Github、Grafana、Jenkins、Kubernetes …)等</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621084141-ejuxa61.png" alt="image">​</p><p>‍</p><p>通过以下*.tf文件，将以编程的方式连接到AWS服务</p><p>AWS语法和源码示例</p><p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest">https://registry.terraform.io/providers/hashicorp/aws/latest</a></p><p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">https://registry.terraform.io/providers/hashicorp/aws/latest/docs</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-west-3&quot; # 取决于购买的EC2实例所属的区域</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    不推荐hardcode明文的key</span><br><span class="line">    **/</span><br><span class="line">    access_key = &quot;&quot;</span><br><span class="line">    secret_key = &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>*.tf文件是一个定义文件，编写完毕后需要执行以下命令安装相应的依赖(类似npm&#x2F;maven instal)</p><p>进入<code>*.tf</code>​所在的文件夹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br></pre></td></tr></table></figure><p>‍</p><p>运行结果</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621090125-g8a8waj.png" alt="image">​</p><p>‍</p><p>可以看到新文件生成</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621090308-ajssusd.png" alt="image">​</p><p>‍</p><h3 id="查看terraform状态"><a href="#查看terraform状态" class="headerlink" title="查看terraform状态"></a>查看terraform状态</h3><p>执行 terraaform state，以生成<code>tfstate</code>​文件</p><p>该文件可以记录当前terraform资源的状态列表</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240627084650-6jzruh4.png" alt="image">​</p><p>‍</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240627084208-hc9n0md.png" alt="image">​</p><p>‍</p><p>terraform state的子命令</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240627084312-2xv492o.png" alt="image">​</p><p>‍</p><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><p>官网 <a href="https://developer.hashicorp.com/terraform/intro">https://developer.hashicorp.com/terraform/intro</a></p><p>Infrastructure as Code tool.</p><p>Terraform本质上是通过调用API实现对各种服务器资源的CRUD操作。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621083744-cph8xt3.png" alt="image">​</p><p>Terraform主要是用于架构的编排，譬如创建EC2，设置VPC，安装docker等，而且其中的顺序必须要遵循一定的顺序。</p><p>另一个IaC工具是Ansible。Ansible可以用来配置基础设置、部署应用、安装和更新应用等</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617213010-g7rnt9g.png" alt="image">​</p><p>‍</p><p>Terraform创建并测试完后，可以精确自动化地复制更多的环境。</p><p>‍</p><h2 id="安装Terraform-1"><a href="#安装Terraform-1" class="headerlink" title="安装Terraform"></a>安装Terraform</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install terraform</span><br></pre></td></tr></table></figure><p>‍</p><p>查看Terraform版本号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform -v</span><br></pre></td></tr></table></figure><p>‍</p><p>安装结果如下</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617213642-gi9trte.png" alt="image">​</p><p>‍</p><h2 id="初始化AWS环境-1"><a href="#初始化AWS环境-1" class="headerlink" title="初始化AWS环境"></a>初始化AWS环境</h2><ul><li>连接到AWS账户</li><li>创建VPC</li><li>创建Subnet</li></ul><h3 id="本地环境设置-1"><a href="#本地环境设置-1" class="headerlink" title="本地环境设置"></a>本地环境设置</h3><p>创建名为<code>Terraformed</code>​的文件夹，并在其中创建文件<code>main.tf</code>​</p><p>​<code>*.tf</code>​是Terraform文件的标准命名方式</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617214824-h3zyfo9.png" alt="image">​</p><p>‍</p><p>使用Visual Studio Code打开<code>main.tf</code>​，并且安装Terraform官方插件。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617215049-jdiqpkh.png" alt="image">​</p><p>‍</p><p>安装完插件以后可以在VS Code中更方便地编辑Terraform文件</p><p>‍</p><h3 id="注册AWS云账号-1"><a href="#注册AWS云账号-1" class="headerlink" title="注册AWS云账号"></a>注册AWS云账号</h3><p>注册完毕后可以免费使用AWS云计算资源</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240617215341-n63hg26.png" alt="image">​</p><p>‍</p><p>注册完毕后会自动创建root用户，此时应该通过IAM创建一个权限较低的管理员账户，并通过管理员账户管理普通账户。</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082633-pze0qoe.png" alt="image">​</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082734-ltw8n4d.png" alt="image">​</p><p>添加group或者选择”Attach existing policies directly”勾选需要赋予的权限</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621082909-kl5bllb.png" alt="image">​</p><p>‍</p><h3 id="Terraform连接到AWS-1"><a href="#Terraform连接到AWS-1" class="headerlink" title="Terraform连接到AWS"></a>Terraform连接到AWS</h3><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621083520-o2agtmi.png" alt="image">​</p><p>‍</p><p>Providers作为Terraform中最重要的关键字，用于标识需要调用的远程云服务供应商API</p><p>Providers列表如下，支持许多的云服务供应商</p><p>支持的资源供应商列表 <a href="https://registry.terraform.io/browse/providers">https://registry.terraform.io/browse/providers</a></p><p>包括云服务、Devops工具(Ansible、Github、Grafana、Jenkins、Kubernetes …)等</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621084141-ejuxa61.png" alt="image">​</p><p>‍</p><p>通过以下*.tf文件，将以编程的方式连接到AWS服务</p><p>AWS语法和源码示例</p><p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest">https://registry.terraform.io/providers/hashicorp/aws/latest</a></p><p><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">https://registry.terraform.io/providers/hashicorp/aws/latest/docs</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">    region = &quot;eu-west-3&quot; # 取决于购买的EC2实例所属的区域</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">    不推荐hardcode明文的key</span><br><span class="line">    **/</span><br><span class="line">    access_key = &quot;&quot;</span><br><span class="line">    secret_key = &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>*.tf文件是一个定义文件，编写完毕后需要执行以下命令安装相应的依赖(类似npm&#x2F;maven instal)</p><p>进入<code>*.tf</code>​所在的文件夹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terraform init</span><br></pre></td></tr></table></figure><p>‍</p><p>运行结果</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621090125-g8a8waj.png" alt="image">​</p><p>‍</p><p>可以看到新文件生成</p><p>​<img src="/2024/06/23/AWS-Terraform-Section1/image-20240621090308-ajssusd.png" alt="image">​</p><p>‍</p><h2 id="Terraform常用命令"><a href="#Terraform常用命令" class="headerlink" title="Terraform常用命令"></a>Terraform常用命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">terraform init       # 初始化terraform文件</span><br><span class="line"></span><br><span class="line">terraform plan       # 比对当前环境与tf文件的差异</span><br><span class="line"></span><br><span class="line">terraform apply      # 将tf文件的设置应用到aws</span><br><span class="line"></span><br><span class="line">terraform destroy -target [resource_type] [resource_name]  # 删除资源 </span><br><span class="line"></span><br><span class="line">terraform apply -auto-approve  # 无需二次确认，立即应用tf配置文件</span><br><span class="line"></span><br><span class="line">terraform destroy    # 删除全部基础设施</span><br><span class="line"></span><br><span class="line">terraform state      # 生成terraform状态文件</span><br><span class="line"></span><br><span class="line">terraform state list # tfstate 显示文件中所有组件</span><br><span class="line"></span><br><span class="line">terraform state show [组件名]  # 显示tfstate文件中某个组件的terraform完整语法</span><br><span class="line"></span><br><span class="line">terraform version    # 显示terraform版本</span><br><span class="line"></span><br><span class="line">terraform fmt        # 格式化tf文件</span><br><span class="line"></span><br><span class="line">terraform validate   # 验证terraform文件是否正确</span><br><span class="line"></span><br><span class="line">terraform show       # 查看terraform状态</span><br><span class="line"></span><br><span class="line">terraform workspace  # 管理terraform工作空间</span><br><span class="line"></span><br><span class="line">terraform get        # 下载 &amp; 安装(或升级)模块</span><br><span class="line"></span><br><span class="line">terraform import     # 导入模块</span><br></pre></td></tr></table></figure><p>‍</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;官网 &lt;a href=&quot;https://developer.hashicorp.com/terraform/intro&quot;&gt;https://d</summary>
      
    
    
    
    <category term="AWS Terraform" scheme="http://example.com/categories/AWS-Terraform/"/>
    
    
    <category term="AWS" scheme="http://example.com/tags/AWS/"/>
    
  </entry>
  
  <entry>
    <title>DRF Django 学习笔记</title>
    <link href="http://example.com/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://example.com/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2024-06-16T13:34:18.000Z</published>
    <updated>2024-06-16T13:43:02.751Z</updated>
    
    <content type="html"><![CDATA[<h2 id="创建第一个测试项目"><a href="#创建第一个测试项目" class="headerlink" title="创建第一个测试项目"></a>创建第一个测试项目</h2><p>安装djanago</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Django==<span class="number">4.2</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><p>‍</p><p>创建项目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject [project_name]</span><br></pre></td></tr></table></figure><p>可以看到项目已经创建</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520212137-og7cyxd.png" alt="image">​</p><p>‍</p><p>然后在pycharm打开项目</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520212307-dqj5svv.png" alt="image">​</p><p>‍</p><p>项目基本结构</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520212403-15sh3or.png" alt="image">​</p><ul><li>wsgi.py - 配置WSGI兼容的Web服务站点</li><li>asgi.py - 配置ASGI兼容的Web服务站点</li><li>urls.py - 配置站点转发的路径</li><li>settings.py - Django项目的全局配置文件（重要）</li></ul><p>‍</p><p>添加项目模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp [module_app]</span><br></pre></td></tr></table></figure><p>‍</p><p>执行以下命令创建第一个模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp first_module</span><br></pre></td></tr></table></figure><p>‍</p><p>可以看到第一个模块已经创建成功</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520212725-g8y3rur.png" alt="image">​</p><p>‍</p><p>添加到settings.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240524211817-438xeg9.png" alt="image">​</p><p>‍</p><p>模块文件结构</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520213459-e7qzjk5.png" alt="image">​</p><ul><li>views.py - 视图层，相当于Web开发中的Controller。用于拦截请求，进行逻辑处理并返回数据</li><li>tests.py - 用于编写测试用例</li><li>models.py - 模型层，用于存放与数据库实体相对应的model</li><li>apps.py -</li><li>admin.py - 一般不用</li></ul><p>‍</p><p>运行项目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver [port]</span><br></pre></td></tr></table></figure><p>‍</p><p>使用7000端口启动项目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver <span class="number">7000</span></span><br></pre></td></tr></table></figure><p>‍</p><p>控制台</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520214939-lfnc7qk.png" alt="image">​</p><p>‍</p><p>输入URL访问 <a href="http://127.0.0.1:7000/">http://127.0.0.1:7000/</a></p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240520215022-tmwz4k0.png" alt="image">​</p><p>‍</p><p>‍</p><h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>连接MySQL</p><p>先安装mysql客户端</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install mysqlclient</span><br></pre></td></tr></table></figure><p>‍</p><p>启动docker数据库</p><p>通过UI启动</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240524210048-lomz4iw.png" alt="image">​</p><p>或通过命令启动</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240524210149-3nlah8m.png" alt="image">​</p><p>‍</p><p>settings.py添加数据库信息</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240525103915-lf2t7a9.png" alt="image">​</p><p>如果能正常启动则说明配置成功</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver <span class="number">8000</span></span><br></pre></td></tr></table></figure><p>‍</p><h2 id="DRF实现登录功能"><a href="#DRF实现登录功能" class="headerlink" title="DRF实现登录功能"></a>DRF实现登录功能</h2><h3 id="DRF概述"><a href="#DRF概述" class="headerlink" title="DRF概述"></a>DRF概述</h3><p>DRF(Django rest framework) 基于Django的封装，是Restful风格的开发框架</p><p>官方网站 <a href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org</a></p><p>‍</p><p>安装</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install djangorestframework</span><br></pre></td></tr></table></figure><p>‍</p><p>添加到settings.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240524211854-v56ns98.png" alt="image">​</p><p>‍</p><h3 id="创建user和item模块"><a href="#创建user和item模块" class="headerlink" title="创建user和item模块"></a>创建user和item模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp user</span><br><span class="line">python manage.py startapp item</span><br></pre></td></tr></table></figure><p>‍</p><p>添加到settings.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240525110511-tt1031h.png" alt="image">​</p><p>‍</p><h3 id="数据表设计"><a href="#数据表设计" class="headerlink" title="数据表设计"></a>数据表设计</h3><p>User表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(models.Model):</span><br><span class="line">    <span class="built_in">id</span> = models.AutoField(primary_key=<span class="literal">True</span>, null=<span class="literal">False</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    user_name = models.CharField(null=<span class="literal">False</span>, max_length=<span class="number">255</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    is_delete = models.IntegerField()</span><br><span class="line">    password = models.CharField(null=<span class="literal">False</span>, max_length=<span class="number">255</span>, unique=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;user_tbl&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><p>Item表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table `item_tbl`(</span><br><span class="line">  `<span class="built_in">id</span>` <span class="built_in">int</span> NOT NULL AUTO_INCREMENT,</span><br><span class="line">`name` varchar(<span class="number">255</span>) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL,</span><br><span class="line">`price` <span class="built_in">int</span> NULL DEFAULT NULL,</span><br><span class="line">`vendor_id` <span class="built_in">int</span> NULL DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`<span class="built_in">id</span>`) USING BTREE</span><br><span class="line">)ENGINE = InnoDB AUTO_INCREMENT = <span class="number">4894</span> CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure><p>‍</p><p><strong>User表 - 根据class自动在mysql db创建</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><p>‍</p><p>数据表已经创建</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240525110258-ot38hp7.png" alt="image">​</p><p>‍</p><p><strong>Item表 - 在数据库创建表，并自动在项目里生成对应的model class</strong></p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240525111124-9q3y8t1.png" alt="image">​</p><p>‍</p><p>运行命令生成class</p><ul><li>如果需要追加则把<code>&gt;</code>​替换为<code>&gt;&gt;</code>​</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py inspectdb --database default item_tbl &gt; item/models.py</span><br></pre></td></tr></table></figure><p>‍</p><p>对应的class自动生成</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240525111655-kg6g4qh.png" alt="image">​</p><p>‍</p><p>在user_tbl插入一条记录作为第一个用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_tbl(user_name, is_delete, password) <span class="keyword">VALUES</span>(<span class="string">&#x27;test1&#x27;</span>, <span class="number">0</span>, <span class="string">&#x27;123456&#x27;</span>);</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="前端UI准备"><a href="#前端UI准备" class="headerlink" title="前端UI准备"></a>前端UI准备</h3><p>前后端分离，使用Vue + axios + Bootstrap快速开发</p><p>UI source code <a href="https://github.com/nauvalazhar/bootstrap-4-login-page">https://github.com/nauvalazhar/bootstrap-4-login-page</a></p><p>index.html引入vue和axios</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue@3.4.21&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><p>修改django主页</p><p>settings.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165314-j1pafek.png" alt="image">​</p><p>‍</p><p>添加路由和controller</p><p>urls.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165237-mww0vfw.png" alt="image">​</p><p>views.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165219-ej1ga44.png" alt="image">​</p><p>‍</p><p>启动效果</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531151106-gh93lfl.png" alt="image">​</p><p>‍</p><h3 id="添加后端数据查询接口"><a href="#添加后端数据查询接口" class="headerlink" title="添加后端数据查询接口"></a>添加后端数据查询接口</h3><p>目的：连接到数据库查询用户表，并且校验用户密码</p><p>项目入口文件urls.py添加user路由</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531152238-c1ml76q.png" alt="image">​</p><p>‍</p><p>User模块下添加序列化器</p><p>*文件名必须为<code>serializers.py</code>​</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from user.models import User</span><br><span class="line">from rest_framework import serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model = User</span><br><span class="line">        fields = &quot;__all__&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><p>User模块下views.py添加控制器逻辑</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render</span><br><span class="line">from rest_framework.generics import GenericAPIView</span><br><span class="line">from rest_framework.mixins import CreateModelMixin, RetrieveModelMixin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from user.models import User</span><br><span class="line">from user.serializers import UserSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Create your views here.</span><br><span class="line">def home_page(request):</span><br><span class="line">    return render(request, &quot;index.html&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># User controller</span><br><span class="line"># post   - 对应db操作insert</span><br><span class="line"># get    - query by id</span><br><span class="line"># put    - update by id</span><br><span class="line"># delete - delete by id</span><br><span class="line">class UserMixinAPIView(GenericAPIView,</span><br><span class="line">                        CreateModelMixin,</span><br><span class="line">                        RetrieveModelMixin):</span><br><span class="line"></span><br><span class="line">    queryset = User.objects</span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line"></span><br><span class="line">    # 添加用户</span><br><span class="line">    # 添加user方法测试</span><br><span class="line">    def post(self, request):</span><br><span class="line">        return self.create(request)</span><br><span class="line"></span><br><span class="line">    # 查询用户</span><br><span class="line">    def get(self, request, pk):</span><br><span class="line">        return self.retrieve(request, pk)</span><br></pre></td></tr></table></figure><p>‍</p><p>User模块下urls.py添加路由拦截规则</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165409-zoibwhs.png" alt="image">​</p><p>‍</p><p>通过postman测试get接口, user id为1</p><p>可以看到正常返回了db里的用户信息</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531160648-oo4nkj6.png" alt="image">​</p><p>‍</p><p>目前可以看到访问api返回的是Json数据，而不是状态码</p><p>需要添加一个工具类，并且将返回结果进行封装</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165446-ta1euqw.png" alt="image">​</p><p>修改user&#x2F;views.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165622-705tdqv.png" alt="image">​</p><p>‍</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531165536-de2orro.png" alt="image">​</p><h3 id="登录改造"><a href="#登录改造" class="headerlink" title="登录改造"></a>登录改造</h3><p>一般业务场景下，不会用user_id进行登录，而是使用账号和密码</p><p>views.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531172411-rt9ehxp.png" alt="image">​</p><ul><li><p>这里引入了<code>ViewSetMixin</code>​，用于区分两个get请求</p><ul><li><a href="http://127.0.0.1:8000/user/">http://127.0.0.1:8000/user/</a> -&gt; 转发到<code>login</code>​方法, 同时会发送一个request body</li><li><a href="http://127.0.0.1:8000/user/1-%3E">http://127.0.0.1:8000/user/1-&gt;</a> 转发到<code>get</code>​方法，参数只有一个id，没有request body</li></ul></li></ul><p>‍</p><p>urls.py也要做相应的改动</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616105216-aghtber.png" alt="image">​</p><p>可以看到同一个get url可以兼容不同的输入参数</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240531172635-ki0kfir.png" alt="image">​</p><p>‍</p><p>添加前端返回结果</p><p>通过@click绑定点击事件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue@3.4.21&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> app = <span class="title class_">Vue</span>.<span class="title function_">createApp</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// Method will be executed when the page initialize</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// For testing</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// this.loginTest();</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// Mount your method to DOM element</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// Static method</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">loginTest</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">alert</span>(<span class="string">&quot;Test vue.&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">userLogin</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> accountName = $(<span class="string">&#x27;#account-name&#x27;</span>).<span class="title function_">val</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> accountPwd = $(<span class="string">&#x27;#account-password&#x27;</span>).<span class="title function_">val</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> userLoginInfo = &#123;&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">userLoginInfo.<span class="property">accountName</span> = accountName;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">userLoginInfo.<span class="property">accountPwd</span> = accountPwd;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">axios.<span class="title function_">post</span>(<span class="string">&#x27;/user/&#x27;</span>, userLoginInfo)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// debugger;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">status</span> == <span class="number">200</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// TODO 登录成功，跳转到首页</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">alert</span>(<span class="string">&#x27;登录成功&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">alert</span>(res.<span class="property">data</span>.<span class="property">msg</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">app.<span class="title function_">mount</span>(<span class="string">&#x27;#loginApp&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>‍</p><h2 id="JWT认证"><a href="#JWT认证" class="headerlink" title="JWT认证"></a>JWT认证</h2><p>Web app的会话控制</p><ul><li>Cookie  -&gt; 存储在浏览器（客户端）上的小文件，用于保存用户信息的key-value文件</li><li>Session -&gt; 存储在服务端，用于保存用户会话所需的属性及配置信息。如果用户过多会导致占用的内存过大</li><li>Token    -&gt; 用户访问API资源所需的凭证，一般由身份标识、时间戳、用户必要信息等内容组成，是一串加密的字符串</li></ul><p>‍</p><p>响应流程</p><p>‍</p><p>JWT：Json web token</p><p>官网：<a href="https://jwt.io/">https://jwt.io</a></p><p>JWT格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure><p>通过<code>.</code>​连接成的三段字符串</p><p>JWT组成</p><ul><li>第一段：header，指头信息包含算法，字符串是由头信息进行base64加密</li><li>第二段：payload，指系统自定义存储的信息，如用户名、过期时间等，并进行base64加密</li><li>第三段：verify signature，指需要系统定义 “salt”，或者称为密钥</li></ul><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20231123211650-59w49ap.png" alt="image">​</p><p>‍</p><p>JWT服务端解密</p><p>获取token，例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.GET.get(<span class="string">&quot;token&quot;</span>)</span><br></pre></td></tr></table></figure><p>然后通过<code>.</code>​把字符串分割成三个部分</p><ul><li>第一步：用base64解密得到<code>header</code>​头部信息</li><li>第二步：用base64解密得到系统中的<code>info</code>​用户数据</li><li>第三步：判断 base64 (header + info + 系统密钥) 是否等于分割后的第三部分</li></ul><p>*要注意保护好系统的密钥</p><p>‍</p><h3 id="安装pyjwt"><a href="#安装pyjwt" class="headerlink" title="安装pyjwt"></a>安装pyjwt</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyjwt</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="JWT工具类测试"><a href="#JWT工具类测试" class="headerlink" title="JWT工具类测试"></a>JWT工具类测试</h3><p>Django在初始化项目的时候会自动生成一个key，可以使用这个作为密钥</p><p>也根据自定义算法生成随机字符串</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616112951-1zjp40y.png" alt="image">​</p><p>‍</p><p>编写工具类生成token</p><p>设置token过期时间为5分钟</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616185722-ugvjkj5.png" alt="image">​</p><p>jwt_demo.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> djangoDRFDemo.settings <span class="keyword">import</span> SECRET_KEY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_token</span>():</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;alg&#x27;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;typ&#x27;</span>: <span class="string">&quot;jwt&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;test_user&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;exp&#x27;</span>: datetime.datetime.utcnow() + datetime.timedelta(minutes=<span class="number">1</span>)  <span class="comment"># 定义超时时间</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = jwt.encode(headers=headers, payload=payload, key=SECRET_KEY, algorithm=<span class="string">&quot;HS256&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload</span>(<span class="params">token</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> jwt.decode(token, SECRET_KEY,algorithms=[<span class="string">&quot;HS256&quot;</span>])</span><br><span class="line">    <span class="keyword">except</span> jwt.exceptions.DecodeError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;token认证失败&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> jwt.exceptions.ExpiredSignatureError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;token已经失效了&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> jwt.exceptions.InvalidTokenError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;无效的token&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加密过程 - 生成token</span></span><br><span class="line">    token = create_token()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生成token：&quot;</span> + token)</span><br><span class="line"></span><br><span class="line">    payload = get_payload(token)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;获取payload：&quot;</span> + <span class="built_in">str</span>(payload))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用旧的token测试验证过程</span></span><br><span class="line">    <span class="comment"># 会抛出Signature has expired异常</span></span><br><span class="line">    expired_token = <span class="string">&quot;&quot;&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6Imp3dCJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InRlc3RfdXNlciIsImV4cCI6MTcxODUzNTcyNH0.8miAzL3pG7yMRonfR68kBJdGnUM1JksyriomfdB-zFY&quot;&quot;&quot;</span></span><br><span class="line">    payload = get_payload(expired_token)</span><br></pre></td></tr></table></figure><p>‍</p><p>运行结果</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616190642-p6db7se.png" alt="image">​</p><p>‍</p><h3 id="JWT登录功能整合"><a href="#JWT登录功能整合" class="headerlink" title="JWT登录功能整合"></a>JWT登录功能整合</h3><h4 id="首次登录时返回token"><a href="#首次登录时返回token" class="headerlink" title="首次登录时返回token"></a>首次登录时返回token</h4><p>1.添加JWT工具类</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616193837-in20fg9.png" alt="image">​</p><p>‍</p><p>2.添加View方法</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616193907-luppdc2.png" alt="image">​</p><p>‍</p><p>3.添加路由</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616193933-5vh48a9.png" alt="image">​</p><p>‍</p><p>4.测试接口</p><p>成功返回token</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616194000-v88wi5c.png" alt="image">​</p><p>‍</p><h4 id="针对非登录接口添加JWT验证"><a href="#针对非登录接口添加JWT验证" class="headerlink" title="针对非登录接口添加JWT验证"></a>针对非登录接口添加JWT验证</h4><p>1.针对url中携带token进行验证</p><p>jwt工具类添加方法</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616201642-aawmuiu.png" alt="image">​</p><p>‍</p><p>View中的方法也做相应的修改</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616203620-gtorlbn.png" alt="image">​</p><p>‍</p><p>测试</p><p>1.先登录一次拿到token</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616202924-6gi24r3.png" alt="image">​</p><p>‍</p><p>2.在参数中使用token，然后发送GET请求</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616202946-8wylpft.png" alt="image">​</p><p>‍</p><p>控制台也会打印出token的信息</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616203047-lokq4um.png" alt="image">​</p><p>‍</p><p>3.等待token过期后再次发起请求</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616203640-pq1rd2p.png" alt="image">​</p><p>控制台显示token失效</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616203707-qw67jl3.png" alt="image">​</p><p>‍</p><h4 id="针对请求header中携带token的验证方式"><a href="#针对请求header中携带token的验证方式" class="headerlink" title="针对请求header中携带token的验证方式"></a>针对请求header中携带token的验证方式</h4><p>添加工具类</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616204928-23tnv8s.png" alt="image">​</p><p>‍</p><p>View里做相应的修改</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205007-v9zy1hx.png" alt="image">​</p><p>‍</p><p>测试接口，也是先拿到token</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205048-svf0zn0.png" alt="image">​</p><p>‍</p><p>‍</p><h4 id="JWT全局配置"><a href="#JWT全局配置" class="headerlink" title="JWT全局配置"></a>JWT全局配置</h4><p>如果每一个类都添加JWT验证类，不方便维护</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205142-aeipl2x.png" alt="image">​</p><p>‍</p><p>在settings.py中添加全局配置</p><p>所有的url都会被拦截</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205423-o15i58r.png" alt="image">​</p><p>‍</p><p>View里做相应的修改</p><p>注释掉类里的authentication</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205511-oxd492e.png" alt="image">​</p><p>‍</p><p>需要验证的方法里面只需要添加如下代码即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断token状态</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> request.user.get(<span class="string">&quot;status&quot;</span>):</span><br><span class="line"><span class="keyword">return</span> ResponseMessage.UserResponse.failed(<span class="string">&quot;User token is invalid.&quot;</span>)</span><br></pre></td></tr></table></figure><p>‍</p><p>测试</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616205732-ufbdmfi.png" alt="image">​</p><p>‍</p><h2 id="设置定时任务"><a href="#设置定时任务" class="headerlink" title="设置定时任务"></a>设置定时任务</h2><p>安装APSchedule</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django_apscheduler</span><br></pre></td></tr></table></figure><p>‍</p><p>settings.py添加</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616210113-vl0ot45.png" alt="image">​</p><p>‍</p><p>执行如下命令完成DB的更改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py makemigrations</span><br><span class="line">python3 manage.py migrate</span><br></pre></td></tr></table></figure><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616210647-anm7hc6.png" alt="image">​</p><p>‍</p><p>会在DB中创建APScheduler所需的表</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616210633-bolnwxx.png" alt="image">​</p><p>‍</p><p>修改app folder中的urls.py</p><p>​<img src="/2024/06/16/DRF-Django-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20240616212555-kl9jbpb.png" alt="image">​</p><p>‍</p><p>启动APP即可看到效果</p><p>代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> apscheduler.schedulers.background <span class="keyword">import</span> BackgroundScheduler</span><br><span class="line"><span class="keyword">from</span> django_apscheduler.jobstores <span class="keyword">import</span> DjangoJobStore,register_job</span><br><span class="line"></span><br><span class="line">scheduler = BackgroundScheduler()</span><br><span class="line">scheduler.add_jobstore(DjangoJobStore(), <span class="string">&quot;default&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@register_job(<span class="params">scheduler, <span class="string">&#x27;interval&#x27;</span>, seconds=<span class="number">5</span>, name=<span class="string">&#x27;auto_hello&#x27;</span>, replace_existing=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_schedule</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello schedule&quot;</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;创建第一个测试项目&quot;&gt;&lt;a href=&quot;#创建第一个测试项目&quot; class=&quot;headerlink&quot; title=&quot;创建第一个测试项目&quot;&gt;&lt;/a&gt;创建第一个测试项目&lt;/h2&gt;&lt;p&gt;安装djanago&lt;/p&gt;
&lt;figure class=&quot;highlight pyt</summary>
      
    
    
    
    <category term="Django" scheme="http://example.com/categories/Django/"/>
    
    
    <category term="Python Web" scheme="http://example.com/tags/Python-Web/"/>
    
  </entry>
  
  <entry>
    <title>Java Lucene中文分词</title>
    <link href="http://example.com/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/"/>
    <id>http://example.com/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/</id>
    <published>2024-04-15T14:07:18.000Z</published>
    <updated>2024-04-16T13:23:34.203Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Lucene中文分词"><a href="#Lucene中文分词" class="headerlink" title="Lucene中文分词"></a>Lucene中文分词</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="非结构化数据查询方法"><a href="#非结构化数据查询方法" class="headerlink" title="非结构化数据查询方法"></a>非结构化数据查询方法</h3><p>（1）顺序扫描法(Serial Scanning)</p><p>所谓顺序扫描，比如要找内容包含某一个字符串的文件，就是一个文档一个文档的看，对于每一个文档，</p><p>从头看到尾，如果此文档包含此字符串，则此文档为我们要找的文件，接着看下一个文件，</p><p>直到扫描完所有的文件。如利用windows的搜索也可以搜索文件内容，只是相当的慢。</p><p>（2）全文检索(Full-text Search)</p><p>将非结构化数据中的一部分信息提取出来，重新组织，使其变得有一定结构，然后对此有一定结构的数据进行搜索，</p><p>从而达到搜索相对较快的目的。这部分从非结构化数据中提取出的然后重新组织的信息，我们称之索引。</p><p>例如：字典。字典的拼音表和部首检字表就相当于字典的索引，对每一个字的解释是非结构化的，</p><p>如果字典没有音节表和部首检字表，在茫茫辞海中找一个字只能顺序扫描。然而字的某些信息可以提取出来进行结构化处理，</p><p>比如读音，就比较结构化，分声母和韵母，分别只有几种可以一一列举，于是将读音拿出来按一定的顺序排列，</p><p>每一项读音都指向此字的详细解释的页数。我们搜索时按结构化的拼音搜到读音，然后按其指向的页数，便可找到我们的非结构化数据——也即对字的解释。</p><p><strong>这种先建立索引，再对索引进行搜索的过程就叫全文检索(Full-text Search)。</strong></p><p>虽然创建索引的过程也是非常耗时的，但是索引一旦创建就可以多次使用，全文检索主要处理的是查询，所以耗时间创建索引是值得的。</p><p>‍</p><h3 id="什么是Lucene"><a href="#什么是Lucene" class="headerlink" title="什么是Lucene"></a>什么是Lucene</h3><p><strong>Lucene是apache下的一个开放源代码的全文检索引擎工具包</strong>。提供了完整的查询引擎和索引引擎，部分文本分析引擎（英文与德文两种西方语言）。</p><p>对于数据量大、数据结构不固定的数据可采用全文检索方式搜索，比如百度、Google等搜索引擎、论坛站内搜索、电商网站站内搜索等。</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210529105841-4936d6f.png" alt="image.png"></p><p>对搜索的原始内容进行索引构建一个索引库，索引过程包括：确定原始内容即要搜索的内容、采集文档、创建文档、分析文档、索引文档</p><p>从索引库中搜索内容，搜索过程包括：用户通过搜索界面、创建查询、执行搜索，从索引库搜索、渲染搜索结果</p><p>‍</p><h3 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h3><p>搜索引擎通常检索的场景是：给定几个关键词，找出包含关键词的文档。怎么快速找到包含某个关键词的文档就成为搜索的关键。所以全文检索引擎一般使用倒排索引，如Lucene。</p><p><strong>全文正排索引</strong></p><p>一句话总结：通过文档找到所有的词，称为正排索引</p><p>正排表是以文档的ID为关键字，表中记录文档中每个字的位置信息，查找时扫描表中每个文档中字的信息直到找出所有包含查询关键字的文档。<br>正排表结构如图所示，这种组织方法在建立索引的时候结构比较简单，建立比较方便且易于维护;因为索引是基于文档建立的，若是有新的文档加入，直接为该文档建立一个新的索引块，挂接在原来索引文件的后面。若是有文档删除，则直接找到该文档号文档对应的索引信息，将其直接删除。但是在查询的时候需对所有的文档进行扫描以确保没有遗漏，这样就使得检索时间大大延长，检索效率低下。<br>尽管正排表的工作原理非常的简单，但是由于其检索效率太低，除非在特定情况下，否则实用性价值不大。</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210602160526-o4n214r.png" alt="image.png"></p><p>‍</p><p><strong>全文倒排索引</strong></p><p>一句话总结：通过词找到所有文档，称为倒排索引</p><p>倒排表以字或词为关键字进行索引，表中关键字所对应的记录表项记录了出现这个字或词的所有文档，一个表项就是一个字表段，它记录该文档的ID和字符在该文档中出现的位置情况。<br>由于每个字或词对应的文档数量在动态变化，所以倒排表的建立和维护都较为复杂，但是在查询的时候由于可以一次得到查询关键字所对应的所有文档，所以效率高于正排表。在全文检索中，检索的快速响应是一个最为关键的性能，而索引建立由于在后台进行，尽管效率相对低一些，但不会影响整个搜索引擎的效率。</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210602160619-ul7mobu.png" alt="image.png"></p><p>‍</p><h3 id="Lucene的评分机制"><a href="#Lucene的评分机制" class="headerlink" title="Lucene的评分机制"></a>Lucene的评分机制</h3><ul><li>结果：（TF-IDF，文档id）</li><li>词频：Term Frequency，简称TF——词在文档中出现的频率</li><li>逆文档频率：Inverse Document Frequency，简称IDF——词在所有文档中出现的频率越低，说明词越重要</li></ul><p>‍</p><h3 id="中文分析器"><a href="#中文分析器" class="headerlink" title="中文分析器"></a>中文分析器</h3><p>Analyzer替换成能处理中文的分析器</p><ul><li>庖丁</li><li>盘古</li><li>IK</li></ul><p>‍</p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>主要目标：针对txt小说文件进行关键词查询，关键词为<code>泡沫 贷款</code></p><h3 id="步骤分解"><a href="#步骤分解" class="headerlink" title="步骤分解"></a>步骤分解</h3><p>1.明确查询范围，准备基础数据，并整理到目录下</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210603145755-lvyw6f9.png" alt="image.png"></p><p>【注意】使用<code>IK Analyzer</code>要保证文档是<code>UTF_8</code>编码格式</p><p>‍</p><p>2.创建索引生成器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建索引生成器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> IndexWriter <span class="title function_">createWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定索引生成目录并打开</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(INDEX_DIR);</span><br><span class="line">    <span class="type">var</span> <span class="variable">dir</span> <span class="operator">=</span> FSDirectory.open(path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定词法分析器</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">analyzer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IKAnalyzer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建造者模式生成配置</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">writerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(dir, writerConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果需要使用英文分析器，则<code>new IKAnalyzer()</code>改为<code>new StandardAnalyzer()</code></p><p>‍</p><p>3.读取小说数据，由Lucene引擎在指定目录创建索引</p><p>4.创建索引搜索器</p><p>5.使用索引搜索器进行搜索，注意搜索中的分析器必须与<code>第二步</code>中的<strong>分析器一致</strong></p><blockquote><p>Lucene的查询方式很 丰富，对于数值类型的数据，采取TermRangeQuery的方式，对于String类型的，就可以采取TermQuery等，查询方式了，可以通过采取合适的查询方式，检索到数据。Queryparser这个查询方式包含了其他几种查询方式。</p></blockquote><p>【注意】几种查询方式的比较</p><table><thead><tr><th>TermQuery</th><th>精确查询</th></tr></thead><tbody><tr><td>TermRangeQuery</td><td>查询一个范围</td></tr><tr><td>PrefixQuery</td><td>前缀匹配查询</td></tr><tr><td>WildcardQuery</td><td>通配符查询</td></tr><tr><td>BooleanQuery</td><td>多条件查询</td></tr><tr><td>PhraseQuery</td><td>短语查询</td></tr><tr><td>FuzzyQuery</td><td>模糊查询</td></tr><tr><td>Queryparser</td><td>万能查询（上面的都可以用这个来查询到）</td></tr></tbody></table><p>‍</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>Lucene.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> lucene;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> data.Book;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.analysis.standard.StandardAnalyzer;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.document.TextField;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.DirectoryReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriter;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.index.IndexWriterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.ParseException;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.queryparser.classic.QueryParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.search.IndexSearcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.lucene.store.FSDirectory;</span><br><span class="line"><span class="keyword">import</span> org.wltea.analyzer.lucene.IKAnalyzer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Lucene中文分词</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LuceneCN</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INDEX_DIR</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/novel/index_data&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATA_DIR</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/novel/book&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引生成器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> IndexWriter <span class="title function_">createWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定索引生成目录并打开</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(INDEX_DIR);</span><br><span class="line">        <span class="type">var</span> <span class="variable">dir</span> <span class="operator">=</span> FSDirectory.open(path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定词法分析器</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">analyzer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IKAnalyzer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 建造者模式生成配置</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">writerConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexWriterConfig</span>(analyzer);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IndexWriter</span>(dir, writerConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建索引</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取索引生成器</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="built_in">this</span>.createWriter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 采集数据</span></span><br><span class="line">        Map&lt;Integer, Book&gt; bookMap = readFromBooks(DATA_DIR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 按章节分割文档</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO 多线程处理以提高效率</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建文档对象</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">documents</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Document&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Book&gt; entry : bookMap.entrySet()) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">Book</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="type">var</span> <span class="variable">document</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;Name&quot;</span>,</span><br><span class="line">                    value.getName(),</span><br><span class="line">                    Field.Store.YES));</span><br><span class="line"><span class="comment">//            document.add(new TextField(&quot;Author&quot;,</span></span><br><span class="line"><span class="comment">//                    value.getAuthor(),</span></span><br><span class="line"><span class="comment">//                    Field.Store.YES));</span></span><br><span class="line">            document.add(<span class="keyword">new</span> <span class="title class_">TextField</span>(<span class="string">&quot;Sentence&quot;</span>,</span><br><span class="line">                    value.getSentence(),</span><br><span class="line">                    Field.Store.YES));</span><br><span class="line"></span><br><span class="line">            documents.add(document);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对文档对象创建索引</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> document : documents) &#123;</span><br><span class="line">            writer.addDocument(document);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        writer.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;全文索引生成完毕!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从指定目录读取数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bookPath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, Book&gt; <span class="title function_">readFromBooks</span><span class="params">(String bookPath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Map&lt;Integer, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取文件列表</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">booksPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(bookPath);</span><br><span class="line">        <span class="type">var</span> <span class="variable">books</span> <span class="operator">=</span> booksPath.listFiles();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历文件</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> book : books) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取书名和作者名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> book.getName();</span><br><span class="line"></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(book);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(fis, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            <span class="keyword">while</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 组装书本信息</span></span><br><span class="line">                <span class="type">Book</span> <span class="variable">bookInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>();</span><br><span class="line">                bookInfo.setName(fileName);</span><br><span class="line">                <span class="comment">//bookInfo.setAuthor(bookAuthor);</span></span><br><span class="line">                bookInfo.setSentence(context);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 入队并读取下一个句子</span></span><br><span class="line">                bookMap.put(count, bookInfo);</span><br><span class="line">                context = reader.readLine();</span><br><span class="line"></span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bookMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引搜索器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> IndexSearcher <span class="title function_">createSearcher</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 指定索引生成目录并打开</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(INDEX_DIR);</span><br><span class="line">        <span class="type">var</span> <span class="variable">dir</span> <span class="operator">=</span> FSDirectory.open(path);</span><br><span class="line">        <span class="type">var</span> <span class="variable">reader</span> <span class="operator">=</span> DirectoryReader.open(dir);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IndexSearcher</span>(reader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从索引搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyWord</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryIndex</span><span class="params">(String keyWord)</span> <span class="keyword">throws</span> ParseException, IOException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryParser</span>(<span class="string">&quot;Sentence&quot;</span>, <span class="keyword">new</span> <span class="title class_">IKAnalyzer</span>()).parse(keyWord);</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">searcher</span> <span class="operator">=</span> <span class="built_in">this</span>.createSearcher();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 仅查询前10条</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">docs</span> <span class="operator">=</span> searcher.search(query, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出结果</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> scoreDoc : docs.scoreDocs) &#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">docID</span> <span class="operator">=</span> scoreDoc.doc;</span><br><span class="line">            <span class="type">var</span> <span class="variable">doc</span> <span class="operator">=</span> searcher.doc(docID);</span><br><span class="line"><span class="comment">//            System.out.format(&quot;%s %s %s %s\n&quot;, scoreDoc.score,</span></span><br><span class="line"><span class="comment">//                    doc.get(&quot;Author&quot;),</span></span><br><span class="line"><span class="comment">//                    doc.get(&quot;Name&quot;),</span></span><br><span class="line"><span class="comment">//                    doc.get(&quot;Sentence&quot;));</span></span><br><span class="line"></span><br><span class="line">            System.out.format(<span class="string">&quot;%s %s %s\n&quot;</span>, scoreDoc.score,</span><br><span class="line">                    doc.get(<span class="string">&quot;Name&quot;</span>),</span><br><span class="line">                    doc.get(<span class="string">&quot;Sentence&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中文分词入口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ParseException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">LuceneCN</span> <span class="variable">lucene</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LuceneCN</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建索引</span></span><br><span class="line">        <span class="comment">//lucene.createIndex();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询关键词</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">keyword</span> <span class="operator">=</span> <span class="string">&quot;贷款 泡沫&quot;</span>;</span><br><span class="line">        lucene.queryIndex(keyword);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>pom.xml</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">         xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;org.example&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;LuceneX&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.0</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- Lucene Lib --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lucene-memory&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.1</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.1</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lucene-queryparser&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.1</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- IK 中文分词 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.magese&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;ik-analyzer&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">7.4</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;<span class="number">12</span>&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;<span class="number">12</span>&lt;/target&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>输出目录</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210603151149-q6tptou.png" alt="image.png"></p><p>‍</p><p>运行结果</p><p><img src="/2024/04/15/Lucene%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/image-20210603151130-diflmqr.png" alt="image.png"></p><p>‍</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/p/47764999">Java 全文检索引擎工具包 Lucene 原理解析</a></p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Lucene中文分词&quot;&gt;&lt;a href=&quot;#Lucene中文分词&quot; class=&quot;headerlink&quot; title=&quot;Lucene中文分词&quot;&gt;&lt;/a&gt;Lucene中文分词&lt;/h1&gt;&lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;head</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Java Core" scheme="http://example.com/tags/Java-Core/"/>
    
  </entry>
  
  <entry>
    <title>旅程还在继续</title>
    <link href="http://example.com/2024/03/29/%E6%97%85%E7%A8%8B%E8%BF%98%E5%9C%A8%E7%BB%A7%E7%BB%AD/"/>
    <id>http://example.com/2024/03/29/%E6%97%85%E7%A8%8B%E8%BF%98%E5%9C%A8%E7%BB%A7%E7%BB%AD/</id>
    <published>2024-03-29T14:22:13.000Z</published>
    <updated>2024-03-30T03:31:59.330Z</updated>
    
    <content type="html"><![CDATA[<h1 id="旅程还在继续"><a href="#旅程还在继续" class="headerlink" title="旅程还在继续"></a>旅程还在继续</h1><p>一年半没有更新博客，原因是Mac重置数据以后，我发现博客数据没有备份…</p><p>还好有记下hexo配置的过程，于是只能从头来过</p><p>Hexo NEXT主题也从原来的5.X升级到了7.X</p><p>​<img src="/2024/03/29/%E6%97%85%E7%A8%8B%E8%BF%98%E5%9C%A8%E7%BB%A7%E7%BB%AD/image-20240317124230-zpap1uq.png" alt="image">​</p><p>‍</p><p>旅程还在继续，学习也不能止步。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;旅程还在继续&quot;&gt;&lt;a href=&quot;#旅程还在继续&quot; class=&quot;headerlink&quot; title=&quot;旅程还在继续&quot;&gt;&lt;/a&gt;旅程还在继续&lt;/h1&gt;&lt;p&gt;一年半没有更新博客，原因是Mac重置数据以后，我发现博客数据没有备份…&lt;/p&gt;
&lt;p&gt;还好有记下hexo配置</summary>
      
    
    
    
    <category term="随记" scheme="http://example.com/categories/%E9%9A%8F%E8%AE%B0/"/>
    
    
    <category term="随记" scheme="http://example.com/tags/%E9%9A%8F%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Oracle 开发常用代码</title>
    <link href="http://example.com/2022/06/14/Oracle%20%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/"/>
    <id>http://example.com/2022/06/14/Oracle%20%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/</id>
    <published>2022-06-14T03:04:05.000Z</published>
    <updated>2024-03-29T14:19:05.191Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h2><h3 id="获取环境信息"><a href="#获取环境信息" class="headerlink" title="获取环境信息"></a>获取环境信息</h3><p>USEREVN()方法返回用户环境的信息。</p><p>option 可以是 ENTRYID,SESSIONID,TERMINAL,ISDBA,LANGUAGE,CLIENT_INFO,LANG,VSIZE</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看当前用户是否是 DBA，如果是返回 true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;isbda&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回 SESSION 会话 ID </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;sessionid&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回多人会话人数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;entryid&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回当前 instance 标志</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;instance&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回当前语言环境</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;language&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回当前语言环境的缩写，如 ZHS,EN 等</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;lang&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回用户终端或机器标识</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(<span class="string">&#x27;terminal&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line"><span class="comment">--返回传入字符的字节数，以 X 为例，返回的就是 X 字符的大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> userevn(X) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="截取到某一个字符串前面的内容"><a href="#截取到某一个字符串前面的内容" class="headerlink" title="截取到某一个字符串前面的内容"></a>截取到某一个字符串前面的内容</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> substr(<span class="string">&#x27;210-1106000001&#x27;</span>,<span class="number">1</span>,instr(<span class="string">&#x27;210-1106000001&#x27;</span>,<span class="string">&#x27;-&#x27;</span>)<span class="number">-1</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="设置当前会话日期格式"><a href="#设置当前会话日期格式" class="headerlink" title="设置当前会话日期格式"></a>设置当前会话日期格式</h3><p>设置当前会话日期格式为英文</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> session <span class="keyword">set</span> nls_date_language<span class="operator">=</span>american;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="开启控制台输出"><a href="#开启控制台输出" class="headerlink" title="开启控制台输出"></a>开启控制台输出</h3><p>用于使 <code>dbms_output.put_line()</code> 生效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> serveroutput <span class="keyword">on</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure><p>‍</p><h3 id="关闭参数输入"><a href="#关闭参数输入" class="headerlink" title="关闭参数输入"></a>关闭参数输入</h3><p>使Oracle的参数符号 <code>&amp;</code> 失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">define</span> off;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure><p>‍</p><h2 id="数据库指标"><a href="#数据库指标" class="headerlink" title="数据库指标"></a>数据库指标</h2><h3 id="查看占用表空间大小"><a href="#查看占用表空间大小" class="headerlink" title="查看占用表空间大小"></a>查看占用表空间大小</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> se.username,</span><br><span class="line">       se.sid,</span><br><span class="line">       su.extents,</span><br><span class="line">       su.blocks <span class="operator">*</span> to_number(rtrim(p.value)) <span class="keyword">AS</span> Space,</span><br><span class="line">       tablespace,</span><br><span class="line">       segtype,</span><br><span class="line">       sql_text</span><br><span class="line">  <span class="keyword">FROM</span> v$sort_usage su, v$<span class="keyword">parameter</span> p, v$session se, v$<span class="keyword">sql</span> s</span><br><span class="line"> <span class="keyword">WHERE</span> p.name <span class="operator">=</span> <span class="string">&#x27;db_block_size&#x27;</span></span><br><span class="line">   <span class="keyword">AND</span> su.session_addr <span class="operator">=</span> se.saddr</span><br><span class="line">   <span class="keyword">AND</span> s.hash_value <span class="operator">=</span> su.sqlhash</span><br><span class="line">   <span class="keyword">AND</span> s.address <span class="operator">=</span> su.sqladdr</span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> se.username, se.sid;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><h3 id="查看占用的磁盘空间"><a href="#查看占用的磁盘空间" class="headerlink" title="查看占用的磁盘空间"></a>查看占用的磁盘空间</h3><p>对于产生大量DML的场景，会需要监控磁盘空间。如果空间爆满会导致Oracle宕机。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TRUNC(first_time) &quot;Date&quot;,</span><br><span class="line">       to_char(first_time, <span class="string">&#x27;Dy&#x27;</span>) &quot;Day&quot;,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="number">1</span>) &quot;Total(GB)&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;00&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h0&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;01&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h1&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;02&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h2&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;03&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h3&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;04&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h4&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;05&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h5&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;06&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h6&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;07&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h7&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;08&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h8&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;09&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h9&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;10&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h10&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;11&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h11&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;12&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h12&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;13&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h13&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;14&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h14&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;15&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h15&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;16&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h16&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;17&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h17&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;18&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h18&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;19&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h19&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;20&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h20&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;21&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h21&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;22&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h22&quot;,</span><br><span class="line">       <span class="built_in">SUM</span>(DECODE(to_char(first_time, <span class="string">&#x27;hh24&#x27;</span>), <span class="string">&#x27;23&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) &quot;h23&quot;,</span><br><span class="line">       ROUND(<span class="built_in">COUNT</span>(<span class="number">1</span>) <span class="operator">/</span> <span class="number">24</span>, <span class="number">2</span>) &quot;Avg&quot;</span><br><span class="line">  <span class="keyword">FROM</span> gv$log_history</span><br><span class="line"> <span class="keyword">WHERE</span> thread# <span class="operator">=</span> inst_id</span><br><span class="line">   <span class="keyword">AND</span> TRUNC(first_time) <span class="operator">&gt;=</span> to_date(<span class="string">&#x27;2022/01/25&#x27;</span>, <span class="string">&#x27;yyyy/mm/dd&#x27;</span>)</span><br><span class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> TRUNC(first_time), to_char(first_time, <span class="string">&#x27;Dy&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><h3 id="查询锁住的表"><a href="#查询锁住的表" class="headerlink" title="查询锁住的表"></a>查询锁住的表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dob.object_name &quot;对象名称&quot;,</span><br><span class="line">       lo.session_id &quot;会话ID&quot;,</span><br><span class="line">       vss.serial# &quot;穿行&quot;,</span><br><span class="line">       vss.action &quot;职责&quot;,</span><br><span class="line">       vss.module &quot;表单&quot;,</span><br><span class="line">       vss.blocking_session &quot;等待其他会话ID&quot;,</span><br><span class="line">       vss.client_identifier &quot;用户&quot;,</span><br><span class="line">       vql.sql_text &quot;SQL语句&quot;,</span><br><span class="line">       <span class="string">&#x27;alter system kill session &#x27;</span> <span class="operator">||</span> <span class="string">&#x27;&#x27;&#x27;&#x27;</span> <span class="operator">||</span> lo.session_id <span class="operator">||</span> <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> vss.serial# <span class="operator">||</span> <span class="string">&#x27;&#x27;&#x27;immediate;&#x27;</span> &quot;命令&quot;</span><br><span class="line">  <span class="keyword">FROM</span> v$locked_object lo,</span><br><span class="line">       dba_objects     dob,</span><br><span class="line">       v$session       vss,</span><br><span class="line">       v$process       vps,</span><br><span class="line">       v$<span class="keyword">sql</span>           vql</span><br><span class="line"> <span class="keyword">WHERE</span> lo.object_id <span class="operator">=</span> dob.object_id</span><br><span class="line">   <span class="keyword">AND</span> lo.session_id <span class="operator">=</span> vss.sid</span><br><span class="line">   <span class="keyword">AND</span> vss.paddr <span class="operator">=</span> vps.addr</span><br><span class="line">   <span class="keyword">AND</span> vql.sql_id(<span class="operator">+</span>) <span class="operator">=</span> vss.sql_id</span><br><span class="line">   <span class="comment">--AND OBJECT_NAME = &#x27;AP_INVOICES_ALL&#x27;</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> lo.session_id;</span><br></pre></td></tr></table></figure><p>‍</p><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="数字转换成大写"><a href="#数字转换成大写" class="headerlink" title="数字转换成大写"></a>数字转换成大写</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FUNCTION</span> convert_money(input_nbr1 NUMBER) <span class="keyword">RETURN</span> VARCHAR2 <span class="keyword">IS</span></span><br><span class="line">    input_nbr_bak  NUMBER(<span class="number">20</span>);</span><br><span class="line">    num_character  VARCHAR2(<span class="number">200</span>) :<span class="operator">=</span> <span class="string">&#x27;零壹贰叁肆伍陆柒捌玖&#x27;</span>;</span><br><span class="line">    unit_character VARCHAR2(<span class="number">400</span>) :<span class="operator">=</span> <span class="string">&#x27;分角圆拾佰仟万拾佰仟亿拾佰仟万拾佰仟亿&#x27;</span>;</span><br><span class="line">    output_string  VARCHAR2(<span class="number">1000</span>) :<span class="operator">=</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    remain_nbr     NUMBER(<span class="number">20</span>);</span><br><span class="line">    bit_num        NUMBER(<span class="number">20</span>);</span><br><span class="line">    bit_unit       VARCHAR2(<span class="number">20</span>);</span><br><span class="line">    bit_indic      NUMBER(<span class="number">1</span>) :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    i              NUMBER(<span class="number">2</span>) :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    spe_unit       VARCHAR2(<span class="number">20</span>) :<span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    sign_indic     VARCHAR2(<span class="number">10</span>);</span><br><span class="line">    input_nbr      NUMBER(<span class="number">38</span>);</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    input_nbr :<span class="operator">=</span> input_nbr1 <span class="operator">*</span> <span class="number">100</span>;</span><br><span class="line">    IF input_nbr <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">      <span class="keyword">RETURN</span> <span class="string">&#x27;零圆整&#x27;</span>;</span><br><span class="line">    ELSIF input_nbr <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">      sign_indic    :<span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">      input_nbr_bak :<span class="operator">=</span> input_nbr;</span><br><span class="line">    ELSIF input_nbr <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line">      sign_indic    :<span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">      input_nbr_bak :<span class="operator">=</span> <span class="operator">-</span>input_nbr;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    LOOP</span><br><span class="line">      remain_nbr    :<span class="operator">=</span> <span class="built_in">floor</span>(input_nbr_bak <span class="operator">/</span> <span class="number">10</span>);</span><br><span class="line">      bit_num       :<span class="operator">=</span> input_nbr_bak <span class="operator">-</span> remain_nbr <span class="operator">*</span> <span class="number">10</span>;</span><br><span class="line">      input_nbr_bak :<span class="operator">=</span> remain_nbr;</span><br><span class="line">      bit_unit      :<span class="operator">=</span> rtrim(substr(unit_character,</span><br><span class="line">                                    i <span class="operator">+</span> <span class="number">1</span>,</span><br><span class="line">                                    <span class="number">1</span>));</span><br><span class="line">      IF bit_num <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">        bit_indic :<span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        IF i <span class="operator">=</span> <span class="number">6</span></span><br><span class="line">           <span class="keyword">OR</span> i <span class="operator">=</span> <span class="number">14</span> <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">          spe_unit :<span class="operator">=</span> <span class="string">&#x27;万&#x27;</span>;</span><br><span class="line">        ELSIF (i <span class="operator">&gt;=</span> <span class="number">7</span> <span class="keyword">AND</span> i <span class="operator">&lt;=</span> <span class="number">9</span>)</span><br><span class="line">              <span class="keyword">OR</span> (i <span class="operator">&gt;=</span> <span class="number">15</span> <span class="keyword">AND</span> i <span class="operator">&lt;=</span> <span class="number">17</span>) <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">          IF spe_unit <span class="operator">!=</span> <span class="string">&#x27;万&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">            output_string :<span class="operator">=</span> <span class="string">&#x27;万&#x27;</span> <span class="operator">||</span> output_string;</span><br><span class="line">            spe_unit      :<span class="operator">=</span> <span class="string">&#x27;万&#x27;</span>;</span><br><span class="line">          <span class="keyword">END</span> IF;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">        output_string :<span class="operator">=</span> substr(num_character,</span><br><span class="line">                                bit_num <span class="operator">+</span> <span class="number">1</span>,</span><br><span class="line">                                <span class="number">1</span>) <span class="operator">||</span> bit_unit <span class="operator">||</span> output_string;</span><br><span class="line">      <span class="keyword">ELSE</span></span><br><span class="line"> </span><br><span class="line">        IF bit_indic <span class="operator">=</span> <span class="number">1</span> <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">          output_string :<span class="operator">=</span> <span class="string">&#x27;零&#x27;</span> <span class="operator">||</span> output_string;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">        IF bit_unit <span class="keyword">IN</span> (<span class="string">&#x27;圆&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;亿&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">          spe_unit      :<span class="operator">=</span> bit_unit;</span><br><span class="line">          output_string :<span class="operator">=</span> bit_unit <span class="operator">||</span> output_string;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line">        bit_indic :<span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">END</span> IF;</span><br><span class="line">      i :<span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">      EXIT <span class="keyword">WHEN</span> input_nbr_bak <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">END</span> LOOP;</span><br><span class="line">    IF <span class="built_in">MOD</span>(input_nbr,</span><br><span class="line">           <span class="number">100</span>) <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span></span><br><span class="line"> </span><br><span class="line">      output_string :<span class="operator">=</span> output_string <span class="operator">||</span> <span class="string">&#x27;整&#x27;</span>;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    IF sign_indic <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">      output_string :<span class="operator">=</span> <span class="string">&#x27;负&#x27;</span> <span class="operator">||</span> output_string;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> output_string;</span><br><span class="line">  <span class="keyword">END</span>;</span><br></pre></td></tr></table></figure><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基本&quot;&gt;&lt;a href=&quot;#基本&quot; class=&quot;headerlink&quot; title=&quot;基本&quot;&gt;&lt;/a&gt;基本&lt;/h2&gt;&lt;h3 id=&quot;获取环境信息&quot;&gt;&lt;a href=&quot;#获取环境信息&quot; class=&quot;headerlink&quot; title=&quot;获取环境信息&quot;&gt;&lt;/a&gt;获</summary>
      
    
    
    
    <category term="Database" scheme="http://example.com/categories/Database/"/>
    
    
    <category term="Oracle" scheme="http://example.com/tags/Oracle/"/>
    
  </entry>
  
  <entry>
    <title>Java 单例模式的安全性</title>
    <link href="http://example.com/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/"/>
    <id>http://example.com/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/</id>
    <published>2022-05-26T02:14:13.000Z</published>
    <updated>2024-03-29T14:17:51.079Z</updated>
    
    <content type="html"><![CDATA[<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>单例模式是指，某个对象在运行时仅存在一个，并对外提供统一访问方式。</p><ul><li>饿汉模式：类被加载的时候就立即初始化并创建唯一实例</li><li>懒汉模式：在被首次调用的时候才创建唯一实例。加入双重检查锁机制能保证线程安全。</li></ul><p>‍</p><h3 id="饿汉单例模式"><a href="#饿汉单例模式" class="headerlink" title="饿汉单例模式"></a>饿汉单例模式</h3><p>实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 饿汉单例模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanContainerStaving</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">BeanContainerStaving</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanContainerStaving</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 禁止访问构造方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">BeanContainerStaving</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BeanContainerStaving <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 get instance&quot;</span>);</span><br><span class="line">                System.out.println(BeanContainerStaving.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get instance&quot;</span>);</span><br><span class="line">                System.out.println(BeanContainerStaving.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>结果</p><p>保证获取到的是唯一实例</p><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220527094219-vqdoi4y.png" alt="image.png"></p><p>‍</p><h3 id="懒汉单例模式"><a href="#懒汉单例模式" class="headerlink" title="懒汉单例模式"></a>懒汉单例模式</h3><p>实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉单例模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanContainerLazy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止指令重排序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span>  BeanContainerLazy instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">BeanContainerLazy</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BeanContainerLazy <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 双重检测</span></span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (BeanContainerLazy.class)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">BeanContainerLazy</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 get instance: &quot;</span> + BeanContainerLazy.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get instance: &quot;</span> + BeanContainerLazy.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>结果</p><p>懒汉模式同样保证了实例在运行时唯一</p><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220527094800-q1lz1rw.png" alt="image.png"></p><p>‍</p><h2 id="单例的安全性"><a href="#单例的安全性" class="headerlink" title="单例的安全性"></a>单例的安全性</h2><p>尽管单例模式已经将构造方法设置为 <code>private</code> 但是依然存在让单例不唯一的手段。</p><ul><li>反射攻击</li><li>序列化攻击</li></ul><p>‍</p><h3 id="反射攻击"><a href="#反射攻击" class="headerlink" title="反射攻击"></a>反射攻击</h3><p>实现：通过反射创建实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 get instance: &quot;</span> + BeanContainerLazy.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 2 get instance: &quot;</span> + BeanContainerLazy.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射创建懒汉单例模式</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">lazyClazz</span> <span class="operator">=</span> BeanContainerLazy.class;</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    constructor = lazyClazz.getDeclaredConstructor();</span><br><span class="line">                    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 3 get instance: &quot;</span> + constructor.newInstance());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>结果：出现了地址不相同的实例，表明通过反射可以破坏单例模式的唯一性</p><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220527150904-rey5u1e.png" alt="image.png"></p><p>‍</p><h3 id="序列化攻击"><a href="#序列化攻击" class="headerlink" title="序列化攻击"></a>序列化攻击</h3><p>懒汉式单，实现序列化接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉单例模式</span></span><br><span class="line"><span class="comment"> * 实现序列化接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanContainerLazySel</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止指令重排序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> BeanContainerLazySel instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">BeanContainerLazySel</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BeanContainerLazySel <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 双重检测</span></span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (BeanContainerLazySel.class)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">BeanContainerLazySel</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>测试序列化攻击</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setObject</span><span class="params">(BeanContainerLazySel instance)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;instance&quot;</span>));</span><br><span class="line">        outputStream.writeObject(instance);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BeanContainerLazySel <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;instance&quot;</span>));</span><br><span class="line">        <span class="type">BeanContainerLazySel</span> <span class="variable">object</span> <span class="operator">=</span> (BeanContainerLazySel)inputStream.readObject();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanContainerLazySel</span> <span class="variable">instance</span> <span class="operator">=</span> BeanContainerLazySel.getInstance();</span><br><span class="line">        System.out.println(instance);</span><br><span class="line">        setObject(instance);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanContainerLazySel</span> <span class="variable">object</span> <span class="operator">=</span> getObject();</span><br><span class="line">        System.out.println(object);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>结果：在懒汉式单例下，通过序列化来获取单例，可以看到地址不一致。</p><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220529101039-2xeopat.png" alt="image.png"></p><p>‍</p><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="抵御反射攻击"><a href="#抵御反射攻击" class="headerlink" title="抵御反射攻击"></a>抵御反射攻击</h4><p><strong>使用枚举类型</strong></p><p>把懒汉式单例存放到枚举类型中，可防止反射和序列化攻击</p><p>以懒汉式单例为例子：</p><p>实现（枚举）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉单例模式</span></span><br><span class="line"><span class="comment"> * 实现序列化接口</span></span><br><span class="line"><span class="comment"> * 单例存放在枚举类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumBeanContainerStavingSel</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EnumBeanContainerStavingSel</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EnumBeanContainerStavingSel <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ContainerHolder.HOLDER.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">ContainerHolder</span></span><br><span class="line">    &#123;</span><br><span class="line">        HOLDER;</span><br><span class="line">        <span class="keyword">private</span> EnumBeanContainerStavingSel instance;</span><br><span class="line"></span><br><span class="line">        ContainerHolder()</span><br><span class="line">        &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">EnumBeanContainerStavingSel</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.coding.singleton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingletonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setObject</span><span class="params">(EnumBeanContainerStavingSel instance)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;instance&quot;</span>));</span><br><span class="line">        outputStream.writeObject(instance);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> EnumBeanContainerStavingSel <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;instance&quot;</span>));</span><br><span class="line">        <span class="type">EnumBeanContainerStavingSel</span> <span class="variable">object</span> <span class="operator">=</span> (EnumBeanContainerStavingSel)inputStream.readObject();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Thread 1 get instance: &quot;</span> + EnumBeanContainerStavingSel.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射攻击</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> EnumBeanContainerStavingSel.class.getDeclaredConstructor();</span><br><span class="line">                    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">EnumBeanContainerStavingSel</span> <span class="variable">enumBeanContainerStavingSel</span> <span class="operator">=</span> (EnumBeanContainerStavingSel)constructor.newInstance();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 2 get instance: &quot;</span> + enumBeanContainerStavingSel.getInstance());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化攻击</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">EnumBeanContainerStavingSel</span> <span class="variable">instance</span> <span class="operator">=</span> EnumBeanContainerStavingSel.getInstance();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 把对象写入到磁盘</span></span><br><span class="line">                    setObject(instance);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 从磁盘中读取对象，并观察是否与运行中的实例相同</span></span><br><span class="line">                    <span class="type">EnumBeanContainerStavingSel</span> <span class="variable">object</span> <span class="operator">=</span> getObject();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Thread 3 get instance: &quot;</span> + object);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>结果</p><p>可以看到放在枚举中的实:</p><ol><li>反射的方式读取都是同一个类。</li><li>序列化方式读取，却不是同一个类，也就是说枚举类型能够抵御反射攻击，却不能抵御序列化攻击</li></ol><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220529103748-ram6wrj.png" alt="image.png"></p><p>‍</p><h4 id="抵御序列化攻击"><a href="#抵御序列化攻击" class="headerlink" title="抵御序列化攻击"></a>抵御序列化攻击</h4><p>在类中定义 <code>readResolve</code> 的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 懒汉单例模式</span></span><br><span class="line"><span class="comment"> * 实现序列化接口</span></span><br><span class="line"><span class="comment"> * 单例存放在枚举类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumBeanContainerStavingSel</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">EnumBeanContainerStavingSel</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> EnumBeanContainerStavingSel <span class="title function_">getInstance</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ContainerHolder.HOLDER.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">ContainerHolder</span></span><br><span class="line">    &#123;</span><br><span class="line">        HOLDER;</span><br><span class="line">        <span class="keyword">private</span> EnumBeanContainerStavingSel instance;</span><br><span class="line"></span><br><span class="line">        ContainerHolder()</span><br><span class="line">        &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">EnumBeanContainerStavingSel</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(getInstance() == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EnumBeanContainerStavingSel</span>();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> ContainerHolder.HOLDER.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>使用同样的测试用例进行测试，结果如下</p><p><img src="/2022/05/26/Java%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7/image-20220529104010-0nrheqc.png" alt="image.png"></p><p>‍</p><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ol><li>枚举类型实际上是 <code>static</code> 的代码块，会在类加载的时候执行，不能被反射创建。枚举类型中的实例是线程安全的。</li><li>在序列化对象的时候，如果要保证单例，则需要实现 <code>readResolve()</code> 方法保证对象唯一。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;单例模式&quot;&gt;&lt;a href=&quot;#单例模式&quot; class=&quot;headerlink&quot; title=&quot;单例模式&quot;&gt;&lt;/a&gt;单例模式&lt;/h2&gt;&lt;p&gt;单例模式是指，某个对象在运行时仅存在一个，并对外提供统一访问方式。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;饿汉模式：类被加载的时候就立即</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Java Core" scheme="http://example.com/tags/Java-Core/"/>
    
  </entry>
  
  <entry>
    <title>MinIO搭建OSS</title>
    <link href="http://example.com/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/"/>
    <id>http://example.com/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/</id>
    <published>2021-08-23T06:34:17.000Z</published>
    <updated>2024-03-29T14:15:51.448Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MinIO搭建OSS"><a href="#MinIO搭建OSS" class="headerlink" title="MinIO搭建OSS"></a>MinIO搭建OSS</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>环境基于dokcer。</p><p>首先确保docker启动状态，输入命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull minio/minio</span><br></pre></td></tr></table></figure><p>‍</p><p>等待下载完毕后，需要创建两个文件夹：config和data，作为minIO的docker映射文件夹</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823142734-i76o6a9.png" alt="image.png"></p><p>‍</p><p>执行命令，启动容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  -p 9000:9000 \</span><br><span class="line">  -p 9001:9001 \</span><br><span class="line">  --name minio \</span><br><span class="line">  -e <span class="string">&quot;MINIO_ROOT_USER=KALOSORA&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;MINIO_ROOT_PASSWORD=KALOSORA&quot;</span> \</span><br><span class="line">  -v /Users/kalosora/docker-reflection/minio/data:/data \</span><br><span class="line">  -v /Users/kalosora/docker-reflection/minio/config:/root/.minio \</span><br><span class="line">  minio/minio server /data --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><p>命令说明：</p><ul><li>需要映射两个端口，一个是api端口，另一个是web控制台端口，最后要用 <code>--console-address</code> 指定控制台，那么此时9001被指定为控制台端口，另一个9000就会自动变成API端口</li><li>USER和PASSWORD最好是纯英文字符串，不要包含特殊符号，因为曾经试过登录以后Java上传不了文件</li><li>这里映射的&#x2F;data和&#x2F;config路径对应上面创建的两个文件夹路径</li></ul><p>‍</p><p>当docker后台显示如下即为搭建完成</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823143155-j8ejxnc.png" alt="image.png"></p><p>‍</p><h2 id="设置访问策略"><a href="#设置访问策略" class="headerlink" title="设置访问策略"></a>设置访问策略</h2><p>登陆到控制台</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9001</span><br></pre></td></tr></table></figure><p>‍</p><p>点击右上角添加存储桶</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823143309-9r3x26w.png" alt="image.png"></p><p>‍</p><p>添加完毕后，设置访问策略为public，这样可以通过 <code>http://127.0.0.1:9001/存储桶名称/文件名</code> 的形式访问</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823143432-vdi8abb.png" alt="image.png"></p><p>‍</p><p>最后添加一个访问规则</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823143517-dmvj87d.png" alt="image.png"></p><p>‍</p><p>按照图里的进行设置即可</p><p><img src="/2021/08/23/MinIO%E6%90%AD%E5%BB%BAOSS/image-20210823143543-6cub0ux.png" alt="image.png"></p><p>‍</p><h2 id="简单实例"><a href="#简单实例" class="headerlink" title="简单实例"></a>简单实例</h2><p>maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--           Minio     --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><h3 id="本地文件上传"><a href="#本地文件上传" class="headerlink" title="本地文件上传"></a>本地文件上传</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// MinIO OSS</span></span><br><span class="line"><span class="comment">// 测试文件上传</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Base information</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">accessKey</span> <span class="operator">=</span> <span class="string">&quot;KALOSORA&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;KALOSORA&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serverUrl</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:9000&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">&quot;images&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">                MinioClient.builder()</span><br><span class="line">                        .endpoint(serverUrl)</span><br><span class="line">                        .credentials(accessKey, secretKey)</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make &#x27;asiatrip&#x27; bucket if not exist.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">                minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build());</span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="comment">// Make a new bucket called &#x27;asiatrip&#x27;.</span></span><br><span class="line">            minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Bucket already exists.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Upload &#x27;/home/user/Photos/asiaphotos.zip&#x27; as object name &#x27;asiaphotos-2015.zip&#x27; to bucket</span></span><br><span class="line">        <span class="comment">// &#x27;asiatrip&#x27;.</span></span><br><span class="line">        minioClient.uploadObject(</span><br><span class="line">                UploadObjectArgs.builder()</span><br><span class="line">                        <span class="comment">//.contentType(&quot;image/jpg&quot;)</span></span><br><span class="line">                        .bucket(bucketName)</span><br><span class="line">                        .object(<span class="string">&quot;portal-cover.jpg&quot;</span>)</span><br><span class="line">                        .filename(<span class="string">&quot;/Users/kalosora/Desktop/portal-cover.jpg&quot;</span>)</span><br><span class="line">                        .build());</span><br><span class="line">        System.out.println(<span class="string">&quot;File has been uploaded!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MinioException e) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);</span><br><span class="line">        System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="文件流上传"><a href="#文件流上传" class="headerlink" title="文件流上传"></a>文件流上传</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidKeyException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Base information</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">accessKey</span> <span class="operator">=</span> <span class="string">&quot;KALOSORA&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;KALOSORA&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">serverUrl</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:9000&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">&quot;article&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span></span><br><span class="line">            <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">                    MinioClient.builder()</span><br><span class="line">                            .endpoint(serverUrl)</span><br><span class="line">                            .credentials(accessKey, secretKey)</span><br><span class="line">                            .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Make &#x27;asiatrip&#x27; bucket if not exist.</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span></span><br><span class="line">                    minioClient.bucketExists(BucketExistsArgs.builder().bucket(bucketName).build());</span><br><span class="line">            <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">                <span class="comment">// Make a new bucket called &#x27;asiatrip&#x27;.</span></span><br><span class="line">                minioClient.makeBucket(MakeBucketArgs.builder().bucket(bucketName).build());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Bucket &#x27;test&#x27; already exists.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过文件流上传</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/Users/kalosora/Downloads/tempfile/210426A9N10GBYNC_数据结构 - 集合.md&quot;</span>);</span><br><span class="line">            minioClient.putObject(</span><br><span class="line">                    PutObjectArgs.builder().bucket(bucketName)</span><br><span class="line">                            .object(<span class="string">&quot;kalosora/article.md&quot;</span>) <span class="comment">// 这里可以自动生成kalosora文件夹</span></span><br><span class="line">                            .stream(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file), -<span class="number">1</span>, <span class="number">10485760</span>)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;File has been uploaded!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MinioException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Error occurred: &quot;</span> + e);</span><br><span class="line">            System.out.println(<span class="string">&quot;HTTP trace: &quot;</span> + e.httpTrace());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h2 id="Springboot整合"><a href="#Springboot整合" class="headerlink" title="Springboot整合"></a>Springboot整合</h2><p>‍</p><p>前端引用上传后的图片</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1:9000/images/portal-cover.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Photo 1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;img-fluid&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>完整实例1</p><blockquote><p><a href="https://blog.csdn.net/zhuyu19911016520/article/details/109448375?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-15-109448375.pc_agg_rank_aggregation&utm_term=minio+%E5%AD%98%E5%82%A8%E8%A7%86%E9%A2%91&spm=1000.2123.3001.4430">https://blog.csdn.net/zhuyu19911016520/article/details/109448375?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-15-109448375.pc_agg_rank_aggregation&amp;utm_term=minio+存储视频&amp;spm=1000.2123.3001.4430</a></p></blockquote><p>完整实例2</p><blockquote><p><a href="https://blog.csdn.net/qq_43230007/article/details/108701081?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-2-108701081.pc_agg_rank_aggregation&utm_term=minio%E6%96%87%E4%BB%B6%E6%B5%81&spm=1000.2123.3001.4430">https://blog.csdn.net/qq_43230007/article/details/108701081?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_v2~rank_aggregation-2-108701081.pc_agg_rank_aggregation&amp;utm_term=minio文件流&amp;spm=1000.2123.3001.4430</a></p></blockquote><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;MinIO搭建OSS&quot;&gt;&lt;a href=&quot;#MinIO搭建OSS&quot; class=&quot;headerlink&quot; title=&quot;MinIO搭建OSS&quot;&gt;&lt;/a&gt;MinIO搭建OSS&lt;/h1&gt;&lt;h2 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;head</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Spring" scheme="http://example.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Docker部署Eureka</title>
    <link href="http://example.com/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/"/>
    <id>http://example.com/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/</id>
    <published>2021-07-14T07:21:03.000Z</published>
    <updated>2025-03-04T00:53:03.048Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker部署Eureka"><a href="#Docker部署Eureka" class="headerlink" title="Docker部署Eureka"></a>Docker部署Eureka</h1><h2 id="SpringCloud打包"><a href="#SpringCloud打包" class="headerlink" title="SpringCloud打包"></a>SpringCloud打包</h2><p>【注意】</p><ul><li><p>其他微服务组件部署方式相同，如zuul也能这样部署（部署依然失败）</p></li><li><p>部署zuul要指定本地网络 <code>--network=host </code></p><ul><li><blockquote><p>docker run –network&#x3D;host –name zuul-server  -d -p 7070:7070 springcloud&#x2F;zuul-server</p></blockquote></li></ul></li></ul><p>‍</p><p>1.在需要打包的项目的 <code>pom.xml</code> 中添加如下内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 打包参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 打包的文件名称 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>eureka<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><p>2.更新maven，并全局install</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714091040-72udekv.png" alt="image.png">  </p><p>‍</p><p>直到出现构建成功字样</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714091121-5crabt0.png" alt="image.png">  </p><p>‍</p><p>3.找到需要打包的项目，这里以 eureka 为例，点击package</p><p>直到出现打包成功字样</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714091257-0fnxdxv.png" alt="image.png">  </p><p>‍</p><p>4.命令终端运行，测试系统是否正常连接到该项目</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">java </span>-<span class="keyword">jar </span>eureka.<span class="keyword">jar</span></span><br></pre></td></tr></table></figure><p>‍</p><p>结果如下（需要终止时，<code>ctrl + c</code> 或 关闭终端窗口 即可）</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714091413-79bzuse.png" alt="image.png">  </p><h2 id="jar构建镜像"><a href="#jar构建镜像" class="headerlink" title="jar构建镜像"></a>jar构建镜像</h2><p>1.拉取jdk镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull java:8</span><br></pre></td></tr></table></figure><p>‍</p><p>2.新建一个目录，并且把jar包放进去</p><p>3.在新建的目录中，创建名为Dockerfile的文件</p><ul><li>EXPOSE：表明暴露的端口号</li><li>ADD：表明要添加的jar包</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM java:8</span><br><span class="line">EXPOSE 7070</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ADD eureka.jar app.jar</span><br><span class="line">RUN sh -c &#x27;touch /app.jar&#x27;</span><br><span class="line">ENV JAVA_OPTS=&quot;&quot;</span><br><span class="line">ENTRYPOINT [ &quot;sh&quot;, &quot;-c&quot;, &quot;java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar&quot; ]</span><br></pre></td></tr></table></figure><p>‍</p><p>目录内容如下：</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714100334-l0hh2wd.png" alt="image.png">  </p><p>‍</p><p>4.命令终端cd进入该目录，执行命令</p><p>【注意】命令末尾有个 ‘.’ 代表当前路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t springcloud/eureka .</span><br></pre></td></tr></table></figure><p>‍</p><p>结果：</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714095258-vnft06a.png" alt="image.png">  </p><p>‍</p><p>5.在docker中查看镜像</p><p>也可以使用命令 <code>docker images</code></p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714095344-w6ih4fz.png" alt="image.png">  </p><p>‍</p><p>6.创建容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 7070:7070 springcloud/eureka</span><br></pre></td></tr></table></figure><p>‍</p><p>7.访问eureka</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:7070</span><br></pre></td></tr></table></figure><p>‍</p><p>结果可以看到运行成功</p><p><img src="/2021/07/14/Docker%E9%83%A8%E7%BD%B2Eureka/image-20210714095610-yyuntu2.png" alt="image.png">  </p><p>‍</p><p>‍</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Docker部署Eureka&quot;&gt;&lt;a href=&quot;#Docker部署Eureka&quot; class=&quot;headerlink&quot; title=&quot;Docker部署Eureka&quot;&gt;&lt;/a&gt;Docker部署Eureka&lt;/h1&gt;&lt;h2 id=&quot;SpringCloud打包&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="Cloud Native" scheme="http://example.com/categories/Cloud-Native/"/>
    
    
    <category term="Spring" scheme="http://example.com/tags/Spring/"/>
    
    <category term="Devops" scheme="http://example.com/tags/Devops/"/>
    
    <category term="Docker" scheme="http://example.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Java 文件上传与下载</title>
    <link href="http://example.com/2021/06/18/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/"/>
    <id>http://example.com/2021/06/18/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/</id>
    <published>2021-06-18T06:34:17.000Z</published>
    <updated>2024-03-29T14:11:54.882Z</updated>
    
    <content type="html"><![CDATA[<h1 id="文件上传与下载"><a href="#文件上传与下载" class="headerlink" title="文件上传与下载"></a>文件上传与下载</h1><p><strong>基于Springboot + Vue前后端分离</strong></p><p>项目源码：</p><ul><li>前端<code>springboot-file</code></li><li>后端<code>springboot-file-process</code></li></ul><p>‍</p><h2 id="流程梳理"><a href="#流程梳理" class="headerlink" title="流程梳理"></a>流程梳理</h2><p><strong>文件上传</strong></p><ol><li><p>前端提交文件，后端使用<code>MultipartFile</code>接收</p></li><li><p>后端新建File并保存到对应的目录上（此时文件后端服务一般与文件存储放在同一个linux服务器上）</p></li><li><p>如果需要回显，存储成功后，向前端返回文件路径。此时该路径必须能够通过http直接访问</p><ol><li>还有一种方法，返回图片的base64格式，放到img标签里面</li></ol></li></ol><p>‍</p><p><strong>文件下载</strong></p><ol><li><p>前端提交文件名到后端</p></li><li><p>后端搜索到文件名，通过文件流写入到<code>HttpServletResponse</code>的<code>OutputStream</code>中</p></li><li><p>前端通过<code>window.location</code>接收</p><ol><li><p>或者是通过以下方式设置图片的Base64，其中<code>imgurl</code>是vue的动态绑定变量</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;&#x27;data:image/png;base64,&#x27;+imgurl&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol></li></ol><p>‍</p><h2 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h2><h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><p>upload.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;fileUploadVue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:inlines</span>=<span class="string">&quot;text&quot;</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>选择文件: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;fileName&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;fileUpload&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;下载&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;fileDownload&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:inlines</span>=<span class="string">&quot;text&quot;</span>&gt;</span>图片上传并回显<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>选择文件: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;fileName&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;fileUploadAndShow&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;&#x27;data:image/png;base64,&#x27;+imageBase64&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;vue/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;vue/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> fileUploadVue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>: <span class="string">&quot;#fileUploadVue&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">imageBase64</span>: <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> me = <span class="variable language_">this</span>;</span></span><br><span class="line"><span class="language-javascript">            me.<span class="title function_">testPostStatus</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 测试前后端是否调通</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">testPostStatus</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> name = <span class="string">&quot;hello&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> postTestUrl = <span class="string">&quot;http://localhost:8001/postTest?name=&quot;</span>;  <span class="comment">// 这里必须添加 &#x27;http://&#x27; 前缀，否则会CORS请求被拦截</span></span></span><br><span class="line"><span class="language-javascript">                axios.<span class="title function_">post</span>(postTestUrl + name).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fileUpload</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> uploadFileUrl = <span class="string">&quot;http://localhost:8001/uploadFile&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">file</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                axios.<span class="title function_">post</span>(uploadFileUrl, formData).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (res.<span class="property">data</span> == <span class="string">&quot;SUCCESS&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件上传成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件上传失败&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fileDownload</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> downloadFileUrl = <span class="string">&quot;http://localhost:8001/downloadFile&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">window</span>.<span class="property">location</span> = <span class="string">&quot;http://localhost:8001/downloadFile&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fileUploadAndShow</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> me = <span class="variable language_">this</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> downloadFileUrl = <span class="string">&quot;http://localhost:8001/fileUploadAndShow&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">file</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                axios.<span class="title function_">post</span>(downloadFileUrl, formData).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">status</span> == <span class="string">&quot;SUCCESS&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        me.<span class="property">imageBase64</span> = res.<span class="property">data</span>.<span class="property">imageBase64</span>;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件上传成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件上传失败&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><h3 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h3><p>SwaggerConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.file.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Predicate;</span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Predicates;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.RequestHandler;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Contact;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swagger2</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    http://localhost:8088/swagger-ui.html     原路径</span></span><br><span class="line"><span class="comment">//    http://localhost:8088/doc.html     新路径，github开源的swagger页面，自带汉化</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置swagger2核心配置 docket</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        Predicate&lt;RequestHandler&gt; filePredicate = RequestHandlerSelectors.basePackage(<span class="string">&quot;com.file.controller&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)  <span class="comment">// 指定api类型为swagger2</span></span><br><span class="line">                .apiInfo(apiInfo())                 <span class="comment">// 用于定义api文档汇总信息</span></span><br><span class="line">                .select()</span><br><span class="line">                .apis(Predicates.or(filePredicate))</span><br><span class="line">                .paths(PathSelectors.any())         <span class="comment">// 所有controller</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;sora blog·博客接口api&quot;</span>)                       <span class="comment">// 文档页标题</span></span><br><span class="line">                .contact(<span class="keyword">new</span> <span class="title class_">Contact</span>(<span class="string">&quot;sora&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;https://www.kalosora.work&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;kalosora@gmail.com&quot;</span>))                   <span class="comment">// 联系人信息</span></span><br><span class="line">                .description(<span class="string">&quot;sora blog博客的api文档&quot;</span>)      <span class="comment">// 详细信息</span></span><br><span class="line">                .version(<span class="string">&quot;1.0.0&quot;</span>)                               <span class="comment">// 文档版本号</span></span><br><span class="line">                .termsOfServiceUrl(<span class="string">&quot;https://www.kalosora.work&quot;</span>)     <span class="comment">// 网站地址</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‍</p><p>FileController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.file.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许跨域</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = &quot;*&quot;, methods = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line"><span class="meta">@Api(value = &quot;文件处理相关Controller&quot;, tags = &#123;&quot;文件处理相关Controller&quot;&#125;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Status Code</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATUS_SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;SUCCESS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATUS_ERROR</span> <span class="operator">=</span> <span class="string">&quot;ERROR&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/downloadFile&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件下载的接口&quot;, notes = &quot;文件下载的接口&quot;, httpMethod = &quot;GET&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">downloadFile</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;布偶.jpg&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">storePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/模拟下载/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">downLoadFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storePath + fileName);</span><br><span class="line">        <span class="keyword">if</span> (!downLoadFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span> STATUS_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件存在，开始下载</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;content-type&quot;</span>, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + java.net.URLEncoder.encode(fileName, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义输入流</span></span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            os = response.getOutputStream();</span><br><span class="line">            is = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(downLoadFile);</span><br><span class="line">            bis = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> bis.read(buffer);</span><br><span class="line">            <span class="keyword">while</span> (i != -<span class="number">1</span>) &#123;</span><br><span class="line">                os.write(buffer);</span><br><span class="line">                i = bis.read(buffer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bis.close();</span><br><span class="line">            is.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/uploadFile&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传的接口&quot;, notes = &quot;文件上传的接口&quot;, httpMethod = &quot;POST&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件保存路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">storePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/模拟下载/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> STATUS_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取原文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        System.out.println(<span class="string">&quot;文件名: &quot;</span> + originalFileName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取文件类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> originalFileName.substring(originalFileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;文件类型: &quot;</span> + fileType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟文件保存到与应用同一个服务器</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">saveFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storePath + originalFileName);</span><br><span class="line">        System.out.println(<span class="string">&quot;新文件:&quot;</span> + saveFile.toString());</span><br><span class="line">        <span class="keyword">if</span> (!saveFile.exists()) &#123;</span><br><span class="line">            file.transferTo(saveFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/fileUploadAndShow&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;文件上传的接口&quot;, notes = &quot;文件上传的接口&quot;, httpMethod = &quot;POST&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">fileUploadAndShow</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 文件保存路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">storePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/模拟下载/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            resultMap.put(<span class="string">&quot;status&quot;</span>, STATUS_ERROR);</span><br><span class="line">            <span class="keyword">return</span> resultMap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取原文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        System.out.println(<span class="string">&quot;文件名: &quot;</span> + originalFileName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取文件类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> originalFileName.substring(originalFileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;文件类型: &quot;</span> + fileType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟文件保存到与应用同一个服务器</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">saveFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(storePath + originalFileName);</span><br><span class="line">        System.out.println(<span class="string">&quot;新文件:&quot;</span> + saveFile.toString());</span><br><span class="line">        <span class="keyword">if</span> (!saveFile.exists()) &#123;</span><br><span class="line">            file.transferTo(saveFile);</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 文件存在，则直接返回图片Base64</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">imageBase64</span> <span class="operator">=</span> fileToBase64(saveFile);</span><br><span class="line">            resultMap.put(<span class="string">&quot;imageBase64&quot;</span>, imageBase64);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resultMap.put(<span class="string">&quot;status&quot;</span>, STATUS_SUCCESS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/postTest&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;测试前后端交互的接口&quot;, notes = &quot;测试前后端交互的接口&quot;, httpMethod = &quot;POST&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">postTest</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件转换成Base64编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件转换为base64</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fileToBase64</span><span class="params">(File file)</span> &#123;<span class="comment">//将图片文件转化为字节数组字符串，并对其进行Base64编码处理</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] fileData = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 读取文件字节数组</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            fileData = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">            in.read(fileData);</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对字节数组Base64编码并且返回</span></span><br><span class="line">        <span class="type">BASE64Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BASE64Encoder</span>();</span><br><span class="line">        <span class="keyword">return</span> encoder.encode(fileData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h2 id="参考网站"><a href="#参考网站" class="headerlink" title="参考网站"></a>参考网站</h2><p><a href="https://www.jianshu.com/p/be1af489551c">Springboot文件上传下载</a></p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;文件上传与下载&quot;&gt;&lt;a href=&quot;#文件上传与下载&quot; class=&quot;headerlink&quot; title=&quot;文件上传与下载&quot;&gt;&lt;/a&gt;文件上传与下载&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;基于Springboot + Vue前后端分离&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;项目</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Spring" scheme="http://example.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java 多线程导入excel数据</title>
    <link href="http://example.com/2021/05/26/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AF%BC%E5%85%A5excel%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2021/05/26/Java%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AF%BC%E5%85%A5excel%E6%95%B0%E6%8D%AE/</id>
    <published>2021-05-26T02:54:02.000Z</published>
    <updated>2024-03-29T14:11:42.347Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-多线程导入excel数据"><a href="#Java-多线程导入excel数据" class="headerlink" title="Java 多线程导入excel数据"></a>Java 多线程导入excel数据</h1><p>项目源码：</p><ul><li>前端<code>springboo-excel</code></li><li>后端<code>springboot-excel-process</code></li></ul><p>‍</p><p>本质上是如何高效地处理大量的数据集合：</p><ul><li>从一个数据库抓取另一个数据库的大量数据</li><li>从大文件Excel中导入到数据库</li></ul><h2 id="目标分解"><a href="#目标分解" class="headerlink" title="目标分解"></a>目标分解</h2><p>使用springboot，方便使用依赖和后续的文件上传</p><ol><li><p>使用POI生成Excel文件</p></li><li><p>使用POI解析Excel文件</p></li><li><p>多线程拆分Excel文件，并导入到数据库，观察耗时</p><ol><li>尝试使用多线程以降低耗时</li><li>使用 spring jdbc template，前端使用MultipartFile</li><li>生产者读取，消费者写入</li></ol></li></ol><p>‍</p><h2 id="Springboot通用配置"><a href="#Springboot通用配置" class="headerlink" title="Springboot通用配置"></a>Springboot通用配置</h2><p>0.<code>application.yml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: oracle</span><br></pre></td></tr></table></figure><p>‍</p><p>1.<code>application-oracle.yml</code>，用于连接oracle数据库</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8003</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  # 数据源的相关配置</span><br><span class="line">  datasource:</span><br><span class="line">    type: com.zaxxer.hikari.HikariDataSource          # 数据源类型：HikariCP</span><br><span class="line">    driver-class-name: oracle.jdbc.driver.OracleDriver</span><br><span class="line">    url: jdbc:oracle:thin:@10.38.1.101:1521:PROD</span><br><span class="line">    username: apps</span><br><span class="line">    password: It2017</span><br><span class="line">    hikari:</span><br><span class="line">      connection-timeout: 30000       # 等待连接池分配连接的最大时长（毫秒），超过这个时长还没可用的连接则发生SQLException， 默认:30秒</span><br><span class="line">      minimum-idle: 5                 # 最小连接数</span><br><span class="line">      maximum-pool-size: 20           # 最大连接数</span><br><span class="line">      auto-commit: true               # 自动提交</span><br><span class="line">      idle-timeout: 600000            # 连接超时的最大时长（毫秒），超时则被释放（retired），默认:10分钟</span><br><span class="line">      pool-name: DateSourceHikariCP   # 连接池名字</span><br><span class="line">      max-lifetime: 1800000           # 连接的生命时长（毫秒），超时而且没被使用则被释放（retired），默认:30分钟 1800000ms</span><br><span class="line">      connection-test-query: SELECT 1 FROM DUAL</span><br><span class="line">  application:</span><br><span class="line">    name: spring-excel</span><br></pre></td></tr></table></figure><p>‍</p><p>2.<code>pom.xml</code> 使用jdk1.8</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-excel-process<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-bootstrap-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- apache poi --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 用于操作微软办公文档 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring Jdbc Template --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Oralce Jdbc --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.oracle.database.jdbc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ojdbc8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>12.2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- fastJson --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- Java 编译 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><p>3.<code>swagger2.java</code>接口调试配置</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package com.excel.config;</span><br><span class="line"></span><br><span class="line">import com.google.common.base.Predicate;</span><br><span class="line">import com.google.common.base.Predicates;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import springfox.documentation.RequestHandler;</span><br><span class="line">import springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line">import springfox.documentation.builders.PathSelectors;</span><br><span class="line">import springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line">import springfox.documentation.service.ApiInfo;</span><br><span class="line">import springfox.documentation.service.Contact;</span><br><span class="line">import springfox.documentation.spi.DocumentationType;</span><br><span class="line">import springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line">import springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@EnableSwagger2</span><br><span class="line">public class Swagger2 &#123;</span><br><span class="line"></span><br><span class="line">//    http://localhost:8088/swagger-ui.html     原路径</span><br><span class="line">//    http://localhost:8088/doc.html     新路径，github开源的swagger页面，自带汉化</span><br><span class="line">    // 配置swagger2核心配置 docket</span><br><span class="line">    @Bean</span><br><span class="line">    public Docket createRestApi() &#123;</span><br><span class="line"></span><br><span class="line">        Predicate<span class="tag">&lt;<span class="name">RequestHandler</span>&gt;</span> excelPredicate = RequestHandlerSelectors.basePackage(&quot;com.excel.controller&quot;);</span><br><span class="line"></span><br><span class="line">        return new Docket(DocumentationType.SWAGGER_2)  // 指定api类型为swagger2</span><br><span class="line">                .apiInfo(apiInfo())                 // 用于定义api文档汇总信息</span><br><span class="line">                .select()</span><br><span class="line">                .apis(Predicates.or(excelPredicate))</span><br><span class="line">                .paths(PathSelectors.any())         // 所有controller</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    private ApiInfo apiInfo() &#123;</span><br><span class="line">        return new ApiInfoBuilder()</span><br><span class="line">                .title(&quot;sora blog·博客接口api&quot;)                       // 文档页标题</span><br><span class="line">                .contact(new Contact(&quot;sora&quot;,</span><br><span class="line">                        &quot;https://www.kalosora.work&quot;,</span><br><span class="line">                        &quot;kalosora@gmail.com&quot;))                   // 联系人信息</span><br><span class="line">                .description(&quot;sora blog博客的api文档&quot;)      // 详细信息</span><br><span class="line">                .version(&quot;1.0.0&quot;)                               // 文档版本号</span><br><span class="line">                .termsOfServiceUrl(&quot;https://www.kalosora.work&quot;)     // 网站地址</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>‍</p><h2 id="生成Excel文件"><a href="#生成Excel文件" class="headerlink" title="生成Excel文件"></a>生成Excel文件</h2><h3 id="生成简单的Excel表格"><a href="#生成简单的Excel表格" class="headerlink" title="生成简单的Excel表格"></a>生成简单的Excel表格</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;excel&quot;)</span></span><br><span class="line"><span class="meta">@Api(value = &quot;EXCEL处理相关Controller&quot;, tags = &#123;&quot;EXCEL处理相关Controller&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建Excel文件</span></span><br><span class="line"><span class="comment">     * 一个Excel文件，包括多个Sheet；一个Sheet包括多个Cell</span></span><br><span class="line"><span class="comment">     * 一个Cell包括多个Column</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;createSampleExcel&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;创建简单Excel文件&quot;, notes = &quot;创建简单Excel文件&quot;, httpMethod = &quot;GET&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createExcel</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">excelFilePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/sample.xls&quot;</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">excelFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(excelFilePath);</span><br><span class="line">        <span class="keyword">if</span> (excelFile.exists()) &#123;</span><br><span class="line">            excelFile.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始创建Excel</span></span><br><span class="line">        <span class="type">HSSFWorkbook</span> <span class="variable">workbook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HSSFWorkbook</span>();</span><br><span class="line">        <span class="type">HSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> workbook.createSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line">        <span class="comment">// 从第0行开始创建</span></span><br><span class="line">        <span class="type">HSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 设置单元格内容，从0开始</span></span><br><span class="line">        row.createCell(<span class="number">0</span>).setCellValue(<span class="string">&quot;发票编号&quot;</span>);</span><br><span class="line">        row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;经营单位&quot;</span>);</span><br><span class="line">        row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;GL日期&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置Excel备注信息</span></span><br><span class="line">        setExcelDesc(workbook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入到Excel</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(excelFile);</span><br><span class="line">        workbook.write(fos);</span><br><span class="line">        workbook.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;创建成功!输出到:&quot;</span> + excelFilePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置Excel文档信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workbook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setExcelDesc</span><span class="params">(HSSFWorkbook workbook)</span> &#123;</span><br><span class="line">        workbook.createInformationProperties();                     <span class="comment">//创建文档信息</span></span><br><span class="line">        <span class="type">DocumentSummaryInformation</span> <span class="variable">dsi</span> <span class="operator">=</span> workbook.getDocumentSummaryInformation();<span class="comment">//摘要信息</span></span><br><span class="line">        dsi.setCategory(<span class="string">&quot;Excel文件&quot;</span>);                                <span class="comment">//类别</span></span><br><span class="line">        dsi.setManager(<span class="string">&quot;kalosora&quot;</span>);                                 <span class="comment">//管理者</span></span><br><span class="line">        dsi.setCompany(<span class="string">&quot;--&quot;</span>);                                       <span class="comment">//公司</span></span><br><span class="line">        <span class="type">SummaryInformation</span> <span class="variable">si</span> <span class="operator">=</span> workbook.getSummaryInformation();   <span class="comment">//摘要信息</span></span><br><span class="line">        si.setSubject(<span class="string">&quot;测试文档&quot;</span>);                                   <span class="comment">//主题</span></span><br><span class="line">        si.setTitle(<span class="string">&quot;测试文档&quot;</span>);                                     <span class="comment">//标题</span></span><br><span class="line">        si.setAuthor(<span class="string">&quot;kalosora&quot;</span>);                                   <span class="comment">//作者</span></span><br><span class="line">        si.setComments(<span class="string">&quot;POI测试文档&quot;</span>);                               <span class="comment">//备注</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="改进：从数据库导出到excel"><a href="#改进：从数据库导出到excel" class="headerlink" title="改进：从数据库导出到excel"></a>改进：从数据库导出到excel</h3><p>使用spring jdbc Template导出excel文件</p><p>Repository层，<code>ApInvoiceVO.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.excel.repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发票实体类VO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApInvoiceVO</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发票编号</span></span><br><span class="line">    <span class="keyword">private</span> String invoiceNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 经营单位</span></span><br><span class="line">    <span class="keyword">private</span> String orgName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总账日期</span></span><br><span class="line">    <span class="keyword">private</span> String glDate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter &amp; setter</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInvoiceNum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> invoiceNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInvoiceNum</span><span class="params">(String invoiceNum)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.invoiceNum = invoiceNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOrgName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> orgName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrgName</span><span class="params">(String orgName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.orgName = orgName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getGlDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> glDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGlDate</span><span class="params">(String glDate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.glDate = glDate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>Service层，<code>ApInvoiceService.java</code>，使用Jdbc Template</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发票Service层</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApInvoiceService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApInvoiceService</span><span class="params">(JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询发票信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ApInvoiceVO&gt; <span class="title function_">queryInvoiceInfo</span><span class="params">(String querySql)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(querySql, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">BeanPropertyRowMapper</span>&lt;&gt;(ApInvoiceVO.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>Controller层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/createExcelFromDB&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;从数据库导出Excel文件&quot;, notes = &quot;从数据库导出Excel文件&quot;, httpMethod = &quot;GET&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createExcelFromDB</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据源</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(<span class="string">&quot;select aia.invoice_num,hou.name org_name,to_char(aia.gl_date,&#x27;yyyy-mm-dd hh24:mi:ss&#x27;) gl_date &quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;from ap_invoices_all aia,hr_operating_units hou &quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;where 1=1 and aia.org_id = hou.organization_id &quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;and gl_date &gt;= to_date(&#x27;2021-05-01&#x27;,&#x27;yyyy-mm-dd&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixme：测试sql语句</span></span><br><span class="line">    System.out.println(<span class="string">&quot;查询语句:&quot;</span> + sb.toString());</span><br><span class="line"></span><br><span class="line">    List&lt;ApInvoiceVO&gt; invoiceVOList = apInvoiceService.queryInvoiceInfo(sb.toString());</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">excelFilePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/sampleDB.xls&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">excelFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(excelFilePath);</span><br><span class="line">    <span class="keyword">if</span> (excelFile.exists()) &#123;</span><br><span class="line">        excelFile.createNewFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始创建Excel</span></span><br><span class="line">    <span class="type">HSSFWorkbook</span> <span class="variable">workbook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HSSFWorkbook</span>();</span><br><span class="line">    <span class="type">HSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> workbook.createSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置表头</span></span><br><span class="line">    <span class="type">HSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">    row.createCell(<span class="number">0</span>).setCellValue(<span class="string">&quot;发票编号&quot;</span>);</span><br><span class="line">    row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;经营单位&quot;</span>);</span><br><span class="line">    row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;GL日期&quot;</span>);</span><br><span class="line">    <span class="comment">// 写入到Sheet1中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; invoiceVOList.size(); i++) &#123;</span><br><span class="line">        row = sheet.createRow(i);</span><br><span class="line">        <span class="comment">// 设置单元格内容，从0开始</span></span><br><span class="line">        row.createCell(<span class="number">0</span>).setCellValue(invoiceVOList.get(i).getInvoiceNum());</span><br><span class="line">        row.createCell(<span class="number">1</span>).setCellValue(invoiceVOList.get(i).getOrgName());</span><br><span class="line">        row.createCell(<span class="number">2</span>).setCellValue(invoiceVOList.get(i).getGlDate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置Excel备注信息</span></span><br><span class="line">    setExcelDesc(workbook);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入到Excel</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(excelFile);</span><br><span class="line">    workbook.write(fos);</span><br><span class="line">    workbook.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;创建成功!输出到:&quot;</span> + excelFilePath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="改进：freemarker导出到excel"><a href="#改进：freemarker导出到excel" class="headerlink" title="改进：freemarker导出到excel"></a>改进：freemarker导出到excel</h3><p>上传sql文件，并且导出到excel</p><p>步骤分解</p><ol><li>从file中获取sql语句</li><li>读取select后，from前的所有字段，生成字节码（动态生成实体类）</li><li>连接数据库，通过freemarker导出到excel</li></ol><p>‍</p><h2 id="从Excel导入"><a href="#从Excel导入" class="headerlink" title="从Excel导入"></a>从Excel导入</h2><h3 id="解析简单的Excel表格"><a href="#解析简单的Excel表格" class="headerlink" title="解析简单的Excel表格"></a>解析简单的Excel表格</h3><p>excel包含少量数据，使用Spring Jdbc Template处理，并在数据库创建记录</p><p>【注意】xls格式最大行数为65535，以二进制形式存储文件；xlsx格式以xml形式存储文件，可以最多存储100w+行数据</p><p>前端：<code>excel.html</code>，使用Vue</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Excel文件上传页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;excelProcess&quot;</span>&gt;</span></span><br><span class="line">        请选择excel文件: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;excelUpload&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;测试连接&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;testPostStatus&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> excelProcess = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>: <span class="string">&quot;#excelProcess&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 测试前后端连接</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">testPostStatus</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> postUrl = <span class="string">&quot;http://localhost:8003/testPost?postMsg=&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> msg = <span class="string">&quot;从VUE发送消息!&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                axios.<span class="title function_">post</span>(postUrl + msg).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">status</span> == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;连接服务器成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;连接服务器失败&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 上传Excel文件</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">excelUpload</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> excelUploadUrl = <span class="string">&quot;http://localhost:8003/excel/readExcelIntoDB&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                formData.<span class="title function_">append</span>(<span class="string">&#x27;excel&#x27;</span>, <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">file</span>.<span class="property">files</span>[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                axios.<span class="title function_">post</span>(excelUploadUrl, formData).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">status</span> == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件上传成功！&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;文件解析失败！&quot;</span> + res.<span class="property">data</span>.<span class="property">msg</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>‍</p><p>后端，连接的是mysql数据库</p><p><code>ExcelService.java</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.excel.service;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class ExcelService &#123;</span><br><span class="line"></span><br><span class="line">    private final JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public ExcelService(JdbcTemplate jdbcTemplate) &#123;</span><br><span class="line">        this.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void insertExcelData(String sqlStr)</span><br><span class="line">    &#123;</span><br><span class="line">        jdbcTemplate.update(sqlStr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p><code>ExcelController.java</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 从数据库导出到Excel</span><br><span class="line"> *</span><br><span class="line"> * @return</span><br><span class="line"> * @throws IOException</span><br><span class="line"> */</span><br><span class="line">@GetMapping(&quot;/createExcelFromDB&quot;)</span><br><span class="line">@ApiOperation(value = &quot;从数据库导出Excel文件&quot;, notes = &quot;从数据库导出Excel文件&quot;, httpMethod = &quot;GET&quot;)</span><br><span class="line">public String createExcelFromDB() throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    // 获取数据源</span><br><span class="line">    StringBuilder sb = new StringBuilder();</span><br><span class="line">    sb.append(&quot;select aia.invoice_num,hou.name org_name,to_char(aia.gl_date,&#x27;yyyy-mm-dd hh24:mi:ss&#x27;) gl_date &quot;);</span><br><span class="line">    sb.append(&quot;from ap_invoices_all aia,hr_operating_units hou &quot;);</span><br><span class="line">    sb.append(&quot;where 1=1 and aia.org_id = hou.organization_id &quot;);</span><br><span class="line">    sb.append(&quot;and gl_date &gt;= to_date(&#x27;2021-05-01&#x27;,&#x27;yyyy-mm-dd&#x27;)&quot;);</span><br><span class="line"></span><br><span class="line">    // fixme：测试sql语句</span><br><span class="line">    System.out.println(&quot;查询语句:&quot; + sb.toString());</span><br><span class="line"></span><br><span class="line">    List<span class="tag">&lt;<span class="name">ApInvoiceVO</span>&gt;</span> invoiceVOList = apInvoiceService.queryInvoiceInfo(sb.toString());</span><br><span class="line"></span><br><span class="line">    String excelFilePath = &quot;/Users/kalosora/Desktop/sampleDB.xls&quot;;</span><br><span class="line">    File excelFile = new File(excelFilePath);</span><br><span class="line">    if (excelFile.exists()) &#123;</span><br><span class="line">        excelFile.createNewFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 开始创建Excel</span><br><span class="line">    HSSFWorkbook workbook = new HSSFWorkbook();</span><br><span class="line">    HSSFSheet sheet = workbook.createSheet(&quot;Sheet1&quot;);</span><br><span class="line">    // 设置表头</span><br><span class="line">    HSSFRow row = sheet.createRow(0);</span><br><span class="line">    row.createCell(0).setCellValue(&quot;发票编号&quot;);</span><br><span class="line">    row.createCell(1).setCellValue(&quot;经营单位&quot;);</span><br><span class="line">    row.createCell(2).setCellValue(&quot;GL日期&quot;);</span><br><span class="line">    // 写入到Sheet1中</span><br><span class="line">    for (int i = 1; i &lt; invoiceVOList.size(); i++) &#123;</span><br><span class="line">        row = sheet.createRow(i);</span><br><span class="line">        // 设置单元格内容，从0开始</span><br><span class="line">        row.createCell(0).setCellValue(invoiceVOList.get(i).getInvoiceNum());</span><br><span class="line">        row.createCell(1).setCellValue(invoiceVOList.get(i).getOrgName());</span><br><span class="line">        row.createCell(2).setCellValue(invoiceVOList.get(i).getGlDate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 设置Excel备注信息</span><br><span class="line">    setExcelDesc(workbook);</span><br><span class="line"></span><br><span class="line">    // 写入到Excel</span><br><span class="line">    FileOutputStream fos = new FileOutputStream(excelFile);</span><br><span class="line">    workbook.write(fos);</span><br><span class="line">    workbook.close();</span><br><span class="line"></span><br><span class="line">    return &quot;创建成功!输出到:&quot; + excelFilePath;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 解析Excel文件，并插入到数据库</span><br><span class="line"> *</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@PostMapping(&quot;/readExcelIntoDB&quot;)</span><br><span class="line">@ApiOperation(value = &quot;解析Excel文件并插入到数据库&quot;, notes = &quot;解析Excel文件并插入到数据库&quot;, httpMethod = &quot;POST&quot;)</span><br><span class="line">public Map&lt;String, Object&gt; readExcelIntoDB(@RequestParam(&quot;excel&quot;) MultipartFile excel) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = new HashMap<span class="tag">&lt;&gt;</span>();</span><br><span class="line"></span><br><span class="line">    // 校验文件类型</span><br><span class="line">    String originFile = excel.getOriginalFilename();</span><br><span class="line">    if (!originFile.contains(&quot;xls&quot;) &amp;&amp; !originFile.contains(&quot;xlsx&quot;)) &#123;</span><br><span class="line">        resultMap.put(&quot;status&quot;, -1);</span><br><span class="line">        resultMap.put(&quot;msg&quot;, &quot;无法解析的Excel文件类型&quot;);</span><br><span class="line">        return resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析Excel文件，xls文件最大行数65535，使用POI进行简单的数据导入</span><br><span class="line">    Map&lt;Integer, List<span class="tag">&lt;<span class="name">String</span>&gt;</span>&gt; excelMap = new HashMap<span class="tag">&lt;&gt;</span>();</span><br><span class="line">    try &#123;</span><br><span class="line">        InputStream is = excel.getInputStream();</span><br><span class="line">        Workbook workBook = new HSSFWorkbook(is, true);</span><br><span class="line">        excelMap = processWorkBook(workBook);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        System.out.println(&quot;获取Excel文件失败：&quot; + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 拼接Mysql SQL语句,当然也可以采用实体类的方式。拼接的方式比较节省空间</span><br><span class="line">    StringBuilder sb = new StringBuilder();</span><br><span class="line">    sb.append(&quot;insert into `sample-table` (column1,column2,column3) values &quot;);</span><br><span class="line">    // 插入到数据库，第0行一般为标题，故忽略</span><br><span class="line">    for (int i = 1; i &lt; excelMap.size(); i++) &#123;</span><br><span class="line">        List<span class="tag">&lt;<span class="name">String</span>&gt;</span> columnList = excelMap.get(i);</span><br><span class="line"></span><br><span class="line">        StringJoiner joiner = new StringJoiner(&quot;,&quot;, &quot;(&quot;, &quot;),&quot;);</span><br><span class="line">        for (String column : columnList) &#123;</span><br><span class="line">            column = &quot;&#x27;&quot; + column + &quot;&#x27;&quot;;</span><br><span class="line">            joiner.add(column);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(joiner);</span><br><span class="line">    &#125;</span><br><span class="line">    String sqlStr = sb.toString();</span><br><span class="line">    sqlStr = sqlStr.substring(0, sqlStr.lastIndexOf(&quot;,&quot;));</span><br><span class="line">    System.out.println(&quot;sql语句:&quot; + sqlStr);</span><br><span class="line"></span><br><span class="line">    // 插入到数据库</span><br><span class="line">    excelService.insertExcelData(sqlStr);</span><br><span class="line"></span><br><span class="line">    resultMap.put(&quot;status&quot;, 200);</span><br><span class="line">    return resultMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 处理Excel文件</span><br><span class="line"> *</span><br><span class="line"> * @param workbook</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">private Map&lt;Integer, List<span class="tag">&lt;<span class="name">String</span>&gt;</span>&gt; processWorkBook(Workbook workbook) &#123;</span><br><span class="line">    Sheet sheet = workbook.getSheetAt(0);</span><br><span class="line"></span><br><span class="line">    // 二维集合对应Excel二维表</span><br><span class="line">    Map&lt;Integer, List<span class="tag">&lt;<span class="name">String</span>&gt;</span>&gt; map = new HashMap<span class="tag">&lt;&gt;</span>();</span><br><span class="line"></span><br><span class="line">    int i = 0;</span><br><span class="line">    for (Row row : sheet) &#123;</span><br><span class="line">        map.put(i, new ArrayList<span class="tag">&lt;<span class="name">String</span>&gt;</span>());</span><br><span class="line">        for (Cell cell : row) &#123; // 遍历当前行的所有cell</span><br><span class="line">            switch (cell.getCellType()) &#123;</span><br><span class="line">                case STRING:</span><br><span class="line">                    map.get(i).add(cell.getRichStringCellValue().getString()); // 如果是字符串则保存</span><br><span class="line">                    break;</span><br><span class="line">                case _NONE:</span><br><span class="line">                    break;</span><br><span class="line">                case NUMERIC:</span><br><span class="line">                    map.get(i).add(cell.getNumericCellValue() + &quot;&quot;); //将数值转换为字符串</span><br><span class="line">                    break;</span><br><span class="line">                case BOOLEAN:</span><br><span class="line">                    break;</span><br><span class="line">                case FORMULA:</span><br><span class="line">                    break;</span><br><span class="line">                case BLANK:</span><br><span class="line">                    break;</span><br><span class="line">                case ERROR:</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>‍</p><h4 id="改进：添加AOP并观察单线程运行速度"><a href="#改进：添加AOP并观察单线程运行速度" class="headerlink" title="改进：添加AOP并观察单线程运行速度"></a>改进：添加AOP并观察单线程运行速度</h4><p>尝试导入10w条数据，并观察导入的速度，添加AOP拦截</p><h5 id="AOP配置"><a href="#AOP配置" class="headerlink" title="AOP配置"></a>AOP配置</h5><p>0.修改<code>application.yml</code>配置文件，修改允许上传文件的尺寸</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: mariadb</span><br><span class="line">  servlet:</span><br><span class="line">    multipart:</span><br><span class="line">      max-file-size: 50MB</span><br><span class="line">      max-request-size: 50MB</span><br></pre></td></tr></table></figure><p>1.<code>pom.xml</code>引入AOP依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.Aspect配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.excel.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceLogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ServiceLogAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AOP通知：</span></span><br><span class="line"><span class="comment">     * 1.前置通知</span></span><br><span class="line"><span class="comment">     * 2.后置通知</span></span><br><span class="line"><span class="comment">     * 3.环绕通知：调用service之前和之后执行</span></span><br><span class="line"><span class="comment">     * 4.异常通知：service发生异常的时候通知</span></span><br><span class="line"><span class="comment">     * 5.最终通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.excel.controller.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordTimeOfService</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;==== 开始执行 &#123;&#125;.&#123;&#125; ====&quot;</span>,</span><br><span class="line">                joinPoint.getTarget().getClass(),</span><br><span class="line">                joinPoint.getSignature().getName());</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">takeTime</span> <span class="operator">=</span> end - start;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (takeTime &gt; <span class="number">3000</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;当前执行耗时：&#123;&#125;&quot;</span>, takeTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (takeTime &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;当前执行耗时：&#123;&#125;&quot;</span>, takeTime);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;当前执行耗时：&#123;&#125;&quot;</span>, takeTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><h5 id="数据导入测试"><a href="#数据导入测试" class="headerlink" title="数据导入测试"></a>数据导入测试</h5><p>准备了10w行的xls文档，导入到空表，观察测试结果</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210526102050-srjdrwj.png)</p><p>‍</p><p>实际测试发现，仅能导入65535行，耗时1875ms</p><p>springboot单机导入</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210526103408-jsigw9k.png)</p><p>mysql数据总数</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210526102956-x5hphwk.png)</p><p>‍</p><h3 id="解析xlsx的Excel表格"><a href="#解析xlsx的Excel表格" class="headerlink" title="解析xlsx的Excel表格"></a>解析xlsx的Excel表格</h3><p>pom.xml添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用于操作微软办公文档2007 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>添加XLSX解析的方法</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/readExcelXLSXIntoDB&quot;)</span><br><span class="line">@ApiOperation(value = &quot;解析xlsx文件并插入到数据库&quot;, notes = &quot;解析xlsx文件并插入到数据库&quot;, httpMethod = &quot;POST&quot;)</span><br><span class="line">public Map&lt;String, Object&gt; readExcelXLSXIntoDB(@RequestParam(&quot;excel&quot;) MultipartFile excel) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = new HashMap<span class="tag">&lt;&gt;</span>();</span><br><span class="line"></span><br><span class="line">    // 校验文件类型</span><br><span class="line">    String originFile = excel.getOriginalFilename();</span><br><span class="line">    if (!originFile.contains(&quot;xls&quot;) &amp;&amp; !originFile.contains(&quot;xlsx&quot;)) &#123;</span><br><span class="line">        resultMap.put(&quot;status&quot;, -1);</span><br><span class="line">        resultMap.put(&quot;msg&quot;, &quot;无法解析的Excel文件类型&quot;);</span><br><span class="line">        return resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析Excel文件，xlsx文件最大行数100w+</span><br><span class="line">    Map&lt;Integer, List<span class="tag">&lt;<span class="name">String</span>&gt;</span>&gt; excelMap = new HashMap<span class="tag">&lt;&gt;</span>();</span><br><span class="line">    try &#123;</span><br><span class="line">        InputStream is = excel.getInputStream();</span><br><span class="line">        Workbook workBook = new XSSFWorkbook(is);</span><br><span class="line">        excelMap = processWorkBook(workBook);</span><br><span class="line"></span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        System.out.println(&quot;获取Excel文件失败：&quot; + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 拼接Mysql SQL语句,当然也可以采用实体类的方式。拼接的方式比较节省空间</span><br><span class="line">    StringBuilder sb = new StringBuilder();</span><br><span class="line">    sb.append(&quot;insert into `sample-table` (column1,column2,column3) values &quot;);</span><br><span class="line">    // 插入到数据库，第0行一般为标题，故忽略</span><br><span class="line">    for (int i = 1; i &lt; excelMap.size(); i++) &#123;</span><br><span class="line">        List<span class="tag">&lt;<span class="name">String</span>&gt;</span> columnList = excelMap.get(i);</span><br><span class="line"></span><br><span class="line">        StringJoiner joiner = new StringJoiner(&quot;,&quot;, &quot;(&quot;, &quot;),&quot;);</span><br><span class="line">        for (String column : columnList) &#123;</span><br><span class="line">            column = &quot;&#x27;&quot; + column + &quot;&#x27;&quot;;</span><br><span class="line">            joiner.add(column);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(joiner);</span><br><span class="line">    &#125;</span><br><span class="line">    String sqlStr = sb.toString();</span><br><span class="line">    sqlStr = sqlStr.substring(0, sqlStr.lastIndexOf(&quot;,&quot;));</span><br><span class="line">    System.out.println(&quot;sql语句:&quot; + sqlStr);</span><br><span class="line"></span><br><span class="line">    // 插入到数据库</span><br><span class="line">    excelService.insertExcelData(sqlStr);</span><br><span class="line"></span><br><span class="line">    resultMap.put(&quot;status&quot;, 200);</span><br><span class="line">    return resultMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>实际测试发现，导入10W行</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210526160723-yzwn6bj.png)</p><p>‍</p><p>mysql数据总数</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210526160746-jrxa084.png)</p><p>‍</p><h3 id="多线程导入"><a href="#多线程导入" class="headerlink" title="多线程导入"></a>多线程导入</h3><p>场景：Springboot 单线程导入100w行Excel数据，报GC溢出</p><blockquote><p>GC Overhead Limit Exceeded Error简介</p><p>OutOfMemoryError是java.lang.VirtualMachineError的子类，当JVM资源利用出现问题时抛出，更具体地说，这个错误是由于JVM花费太长时间执行GC且只能回收很少的堆内存时抛出的。根据Oracle官方文档，默认情况下，如果Java进程花费98%以上的时间执行GC，并且每次只有不到2%的堆被恢复，则JVM抛出此错误。换句话说，<strong>这意味着我们的应用程序几乎耗尽了所有可用内存</strong>，垃圾收集器花了太长时间试图清理它，并多次失败。</p><p>在这种情况下，用户会体验到应用程序响应非常缓慢，通常只需要几毫秒就能完成的某些操作，此时则需要更长的时间来完成，这是因为所有的CPU正在进行垃圾收集，因此无法执行其他任务。</p></blockquote><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210527134344-07tmkad.png)</p><p>‍</p><h4 id="改进：生产者消费者模型"><a href="#改进：生产者消费者模型" class="headerlink" title="改进：生产者消费者模型"></a>改进：生产者消费者模型</h4><h5 id="步骤分解"><a href="#步骤分解" class="headerlink" title="步骤分解"></a>步骤分解</h5><ol><li><p>获取上传的文件并保存副本到临时目录</p></li><li><p>确定长度</p><ol><li>文件总长度</li><li>每个线程处理的任务长度</li><li>生产者预计线程数，根据机器性能给定，或者用 文件长度&#x2F;线程任务长度</li><li>消费者预计线程数，根据机器性能给定，或者按比例分配（生产者:消费者 &#x3D; 4:1）</li></ol></li><li><p>数据分片处理</p><ol><li><p>多线程任务一般都是需要进行数据分片</p></li><li><p>任务开始位置：<code>I * 线程任务长度</code></p></li><li><p>任务结束位置：<code>（I+1） * 线程任务长度</code></p></li><li><p>Excel文件处理</p><ol><li><code>sheet.getRow(startPos).getRowNum()</code>获取特定行数进行行循环</li><li><code>Map&lt;Integer, List&lt;String&gt;&gt;</code>定义数据结构保存Excel二维表</li><li><code>map.get(i).add(cell.getRichStringCellValue().getString())</code>进行列循环并保存到数据结构中</li><li>拼接成mysql的<code>insert into</code>语句，并放入生产者队列中</li></ol></li></ol></li><li><p>开启多线程</p><ol><li><code>ExecutorService</code>分别开启生产者和消费者线程</li><li><code>CountDownLatch</code>观察生产者任务（转换mysql语句）是否完成</li><li><code>LinkedBlockingQueue</code>线程安全的无界链队列，保存mysql语句供消费者调用</li></ol></li></ol><p>‍</p><p>实例代码：</p><p>Controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/readXLSXMultiIntoDB&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;多线程导入xlsx文件到数据库&quot;, notes = &quot;多线程导入xlsx文件到数据库&quot;, httpMethod = &quot;POST&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">readXLSXMultiIntoDB</span><span class="params">(<span class="meta">@RequestParam(&quot;excel&quot;)</span> MultipartFile excel)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 多线程处理EXCEL时，文件要先保存到本地</span></span><br><span class="line">    <span class="comment">// https://blog.csdn.net/bieber007/article/details/109963775</span></span><br><span class="line">    <span class="type">MultipartFile</span> <span class="variable">multipartFile</span> <span class="operator">=</span> excel;</span><br><span class="line">    <span class="type">String</span> <span class="variable">localStorePath</span> <span class="operator">=</span> <span class="string">&quot;/Users/kalosora/Desktop/exceltmp/&quot;</span> + excel.getOriginalFilename();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        multipartFile.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(localStorePath));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;保存上传文件失败:&quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开本地文件</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">localFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localStorePath);</span><br><span class="line">    <span class="type">Workbook</span> <span class="variable">workBook</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Sheet</span> <span class="variable">sheet</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(localFile);</span><br><span class="line">        workBook = <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(is);</span><br><span class="line">        <span class="comment">// 默认读取第一个表格</span></span><br><span class="line">        sheet = workBook.getSheetAt(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        resultMap.put(<span class="string">&quot;status&quot;</span>, -<span class="number">1</span>);</span><br><span class="line">        resultMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;解析Excel文件失败: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟已知文档长度，如果计算的话需要50秒，这里节省性能</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">fileLength</span> <span class="operator">=</span> <span class="number">1000000</span>;  <span class="comment">//500000，单个线程处理5000，通过测试，耗时335s</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假设每个线程处理5000数据</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">threadLength</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算生产者 &amp; 消费者线程数</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">producerThreadCount</span> <span class="operator">=</span> fileLength / threadLength;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">consumerThreadCount</span> <span class="operator">=</span> producerThreadCount / <span class="number">4</span>; <span class="comment">// 生产者:消费者 4:1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 任务队列</span></span><br><span class="line">    LinkedBlockingQueue&lt;String&gt; excelQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(producerThreadCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 机器性能限制，只开启100个线程</span></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">consumerService</span> <span class="operator">=</span> Executors.newFixedThreadPool(consumerThreadCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动生产者</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; producerThreadCount; i++) &#123;</span><br><span class="line">        <span class="comment">// 创建线程副本</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">LocalI</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="type">Sheet</span> <span class="variable">localSheet</span> <span class="operator">=</span> sheet;</span><br><span class="line"></span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">startPos</span> <span class="operator">=</span> LocalI * threadLength + <span class="number">1</span>;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">endPos</span> <span class="operator">=</span> (LocalI + <span class="number">1</span>) * threadLength;</span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">localCountDown</span> <span class="operator">=</span> latch;</span><br><span class="line"></span><br><span class="line">            processXLSXMulti(excelQueue, localCountDown, localSheet, startPos, endPos);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动消费者</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; consumerThreadCount; i++) &#123;</span><br><span class="line">        consumerService.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (excelQueue.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">sqlStr</span> <span class="operator">=</span> excelQueue.poll();</span><br><span class="line">                    <span class="comment">// 插入到数据库</span></span><br><span class="line">                    excelService.insertExcelData(sqlStr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;生产者任务已完成!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;任务屏障失败:&quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞，等待消费者任务执行完毕</span></span><br><span class="line">    System.out.println(<span class="string">&quot;等待消费者任务 ...&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (excelQueue.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resultMap.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">    <span class="keyword">return</span> resultMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者：读取XLSX数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sheet</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startPos Excel开始位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endPos   Excel结束为止</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processXLSXMulti</span><span class="params">(LinkedBlockingQueue&lt;String&gt; excelQueue,</span></span><br><span class="line"><span class="params">                              CountDownLatch localCountDown,</span></span><br><span class="line"><span class="params">                              Sheet sheet,</span></span><br><span class="line"><span class="params">                              Integer startPos,</span></span><br><span class="line"><span class="params">                              Integer endPos)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 二维集合对应Excel二维表</span></span><br><span class="line">    Map&lt;Integer, List&lt;String&gt;&gt; excelMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取起止行数</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">startRowNum</span> <span class="operator">=</span> sheet.getRow(startPos).getRowNum();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">endRowNum</span> <span class="operator">=</span> sheet.getRow(endPos).getRowNum();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 行循环</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> startRowNum; row &lt;= endRowNum; row++) &#123;</span><br><span class="line">        <span class="type">Row</span> <span class="variable">currentRow</span> <span class="operator">=</span> sheet.getRow(row);</span><br><span class="line">        excelMap.put(count, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 列循环</span></span><br><span class="line">        <span class="keyword">for</span> (Cell cell : currentRow) &#123; <span class="comment">// 遍历当前行的所有cell</span></span><br><span class="line">            <span class="keyword">switch</span> (cell.getCellType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> STRING:</span><br><span class="line">                    excelMap.get(count).add(cell.getRichStringCellValue().getString()); <span class="comment">// 如果是字符串则保存</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> _NONE:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> NUMERIC:</span><br><span class="line">                    excelMap.get(count).add(cell.getNumericCellValue() + <span class="string">&quot;&quot;</span>); <span class="comment">//将数值转换为字符串</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> FORMULA:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> BLANK:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ERROR:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;[线程&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;] &quot;</span></span><br><span class="line">            + <span class="string">&quot;EXCEL开始行数: &quot;</span> + startRowNum</span><br><span class="line">            + <span class="string">&quot;，EXCEL结束行数: &quot;</span> + endRowNum</span><br><span class="line">            + <span class="string">&quot;, 列表长度：&quot;</span> + excelMap.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接Mysql SQL语句,当然也可以采用实体类的方式。拼接的方式比较节省空间</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(<span class="string">&quot;insert into `sample-table` (column1,column2,column3) values &quot;</span>);</span><br><span class="line">    <span class="comment">// 插入到数据库，第0行一般为标题，故忽略</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; count; k++) &#123;</span><br><span class="line">        List&lt;String&gt; columnList = excelMap.get(k);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringJoiner</span> <span class="variable">joiner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringJoiner</span>(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;),&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String column : columnList) &#123;</span><br><span class="line">            column = <span class="string">&quot;&#x27;&quot;</span> + column + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">            joiner.add(column);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(joiner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sqlStr</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">    sqlStr = sqlStr.substring(<span class="number">0</span>, sqlStr.lastIndexOf(<span class="string">&quot;,&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 任务入队</span></span><br><span class="line">    excelQueue.offer(sqlStr);</span><br><span class="line">    localCountDown.countDown();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;[线程&quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;] 已完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>Service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelService</span><span class="params">(JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertExcelData</span><span class="params">(String sqlStr)</span></span><br><span class="line">    &#123;</span><br><span class="line">        jdbcTemplate.update(sqlStr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‍</p><p>进一步优化的方案</p><blockquote><p>提升Excel导入速度的方法：</p><ul><li>使用更快的 Excel 读取框架(推荐使用阿里 EasyExcel)</li><li>对于需要与数据库交互的校验、按照业务逻辑适当的使用缓存。用空间换时间</li><li>使用 values(),(),() 拼接长 SQL 一次插入多行数据</li><li>使用多线程插入数据，利用掉网络IO等待时间(推荐使用并行流，简单易用)</li><li>避免在循环中打印无用的日志</li></ul><p><a href="https://zhuanlan.zhihu.com/p/258525453">https://zhuanlan.zhihu.com/p/258525453</a></p></blockquote><p>‍</p><h2 id="导出到Excel"><a href="#导出到Excel" class="headerlink" title="导出到Excel"></a>导出到Excel</h2><p>从plsql中导出100w条数据，耗时745秒</p><p>多线程目标：导出100w条数据，至少优化到400秒以下</p><p>![image.png](Java 多线程导入excel数据&#x2F;image-20210527133017-h2hde4n.png)</p><p>有空再做吧…</p><p>‍</p><p>‍</p><h2 id="参考来源"><a href="#参考来源" class="headerlink" title="参考来源"></a>参考来源</h2><p><a href="https://www.zhihu.com/question/23258804">java多线程进行大批量EXcel数据导入实现方案</a></p><p><a href="https://blog.csdn.net/holmofy/article/details/82532311">java POI详解</a></p><p><a href="https://blog.csdn.net/joycesunny/article/details/106246302">java POI 实例</a></p><p><a href="https://github.com/alibaba/easyexcel">代替POI的EasyExcel</a></p><p><a href="https://www.iocoder.cn/Spring-Boot/battcn/v2-orm-jdbc//">Spring Jdbc Template</a></p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Java-多线程导入excel数据&quot;&gt;&lt;a href=&quot;#Java-多线程导入excel数据&quot; class=&quot;headerlink&quot; title=&quot;Java 多线程导入excel数据&quot;&gt;&lt;/a&gt;Java 多线程导入excel数据&lt;/h1&gt;&lt;p&gt;项目源码：&lt;/p&gt;
</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Spring" scheme="http://example.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>Java8-11的新特性</title>
    <link href="http://example.com/2021/04/07/Java8-11%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7/"/>
    <id>http://example.com/2021/04/07/Java8-11%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7/</id>
    <published>2021-04-07T06:54:17.000Z</published>
    <updated>2024-03-29T14:06:58.236Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java8-11的新特性"><a href="#Java8-11的新特性" class="headerlink" title="Java8-11的新特性"></a>Java8-11的新特性</h1><h2 id="Java8"><a href="#Java8" class="headerlink" title="Java8"></a>Java8</h2><h3 id="Lambda-Functional-Interface"><a href="#Lambda-Functional-Interface" class="headerlink" title="Lambda &amp; Functional Interface"></a>Lambda &amp; Functional Interface</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LambdaExamples</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>误区：</p><ul><li>认为的：通过匿名函数生成Runnable对象，传递给Thread</li><li>事实上：内部优化直接调用了匿名函数（invokedynamic指令)</li></ul><h3 id="方法引用-操作符"><a href="#方法引用-操作符" class="headerlink" title="方法引用::操作符"></a>方法引用<code>::</code>操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodReference</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">var</span> <span class="variable">val</span> <span class="operator">=</span> List.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).stream()</span><br><span class="line">                .map(Object::toString)</span><br><span class="line">                .map(Integer::<span class="keyword">new</span>)</span><br><span class="line">                .reduce((a,b)-&gt;a+b);</span><br><span class="line">            </span><br><span class="line">        System.out.println(val);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><p>一个Monad。 函数式、流计算重磅炸弹，<strong>见之前讲流和Monad部分</strong> 。</p><h3 id="Optional"><a href="#Optional" class="headerlink" title="Optional"></a>Optional<T></T></h3><p>一个Monad。 流计算必备工具，减少空值检查。另一个还没有支持，但比较重要的Monad是Try。这个在实现AOP框架的程序中，我们已经使用到了。<strong>见之前讲流和Monad部分</strong></p><h3 id="接口的方法-static-default-private"><a href="#接口的方法-static-default-private" class="headerlink" title="接口的方法(static, default, private)"></a>接口的方法(static, default, private)</h3><ul><li>static(java 8)</li><li>default(java 8)</li><li>private(java 9)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Stream</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">BaseStream</span>&lt;T, Stream&lt;T&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 每个Stream Monad都有这个方法</span></span><br><span class="line">   <span class="keyword">default</span> Stream&lt;T&gt; <span class="title function_">takeWhile</span><span class="params">(Predicate&lt;? <span class="built_in">super</span> T&gt; predicate)</span> &#123;</span><br><span class="line">   ...</span><br><span class="line">       foo(); <span class="comment">// 可以调用</span></span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 可以通过Stream.empty()构造空的流</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; Stream&lt;T&gt; <span class="title function_">empty</span><span class="params">()</span> &#123;</span><br><span class="line">    ...   </span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 不是源代码中的程序</span></span><br><span class="line">   <span class="keyword">private</span> <span class="title function_">foo</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Java-8-Nashorn-JavaScript"><a href="#Java-8-Nashorn-JavaScript" class="headerlink" title="Java 8 Nashorn JavaScript"></a>Java 8 Nashorn JavaScript</h3><p>在Java8中增加，在Java11中标记为Deprecated， 在Java15中移出的新特性。支持javascriptES5语法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_engine</span><span class="params">()</span> <span class="keyword">throws</span> ScriptException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">jscode</span> <span class="operator">=</span> <span class="string">&quot; [1,2,3].map(function(x)&#123;return x + 1;&#125;).join(&#x27;-&#x27;);&quot;</span>;</span><br><span class="line">    <span class="type">ScriptEngineManager</span> <span class="variable">scriptEngineManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>();</span><br><span class="line">    <span class="type">ScriptEngine</span> <span class="variable">nashorn</span> <span class="operator">=</span> scriptEngineManager.getEngineByName(<span class="string">&quot;nashorn&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> nashorn.eval(jscode);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="comment">// 2-3-4</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>脚本这么多专门选JS没有优势。</strong></p><h3 id="本地化日期处理升级"><a href="#本地化日期处理升级" class="headerlink" title="本地化日期处理升级"></a>本地化日期处理升级</h3><p>提供了Local和Zoned两种处理日期的方式，在新的API中不再允许mutable的操作（非线程安全）；另外对时区采取更好的处理方法：如果用户的系统不考虑国际化，那么就用Local的日期，如果考虑国际化，可以构造带时区的DateTime。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test_date</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 2022年2月22日</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">date</span> <span class="operator">=</span> LocalDate.of(<span class="number">2022</span>, <span class="number">2</span>, <span class="number">22</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10:55:59</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">time</span> <span class="operator">=</span> LocalTime.of(<span class="number">10</span>, <span class="number">55</span>, <span class="number">59</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">datetime</span> <span class="operator">=</span> LocalDateTime.of(date, time);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">zoneDT</span> <span class="operator">=</span> ZonedDateTime.of(datetime, ZoneId.of(<span class="string">&quot;Asia/Shanghai&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内置了Base64工具"><a href="#内置了Base64工具" class="headerlink" title="内置了Base64工具"></a>内置了Base64工具</h3><p>tips： 对0~255之间的字符，Base64编码是以4个可见字符去描述3个字符。会增加数据的体积，但是因为所有字符都可以读，用Base64编码描述的字符串，在URL、XML中都不会被转义。</p><p>Base64.Decoder和Base64.Encoder类。</p><h2 id="Java9新特性"><a href="#Java9新特性" class="headerlink" title="Java9新特性"></a>Java9新特性</h2><h3 id="模块系统"><a href="#模块系统" class="headerlink" title="模块系统"></a>模块系统</h3><p>因为和底层原理知识结合紧密，在ClassLoader部分介绍。</p><h3 id="交互式编程环境-JShell"><a href="#交互式编程环境-JShell" class="headerlink" title="交互式编程环境(JShell)"></a>交互式编程环境(JShell)</h3><p><img src="/2021/04/07/Java8-11%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7/836941f89ea9634e9e7ee5506d989903-20210407221013-6a1s7eu.png" alt="image-20210219120607478"></p><p>除了上图中的能力，也提供API，可以动态的eval程序。</p><h3 id="新的HTTP-2-0-Clinet"><a href="#新的HTTP-2-0-Clinet" class="headerlink" title="新的HTTP 2.0 Clinet"></a>新的HTTP 2.0 Clinet</h3><p>主要针对旧Client，提供Buidler，方便用户设置header和参数。</p><p>另外支持HTTP2.0，HTTP2.0兼容HTTP1.1的能力，主要是从性能角度进行了调优。理解HTTP2.0主要是这几个特性：</p><ul><li>多个HTTP 请求&#x2F;返回在一个TCP请求上多路复用（客户端要负责实现多路复用）</li><li>头部压缩算法（客户端要负责解压）</li><li>Server Push：服务器可能会给客户端额外的文件（浏览器要负责识别，并缓存这些文件，客户端不一定要实现）</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">HttpClient</span> <span class="variable">httpClient</span> </span><br><span class="line">                <span class="operator">=</span> HttpClient.newHttpClient(); </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="type">HttpRequest</span> <span class="variable">httpRequest</span> </span><br><span class="line">    <span class="operator">=</span> HttpRequest </span><br><span class="line">    .newBuilder() </span><br><span class="line">    .headers(<span class="string">&quot;x-key&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;x-name&quot;</span>, <span class="string">&quot;something&quot;</span>)</span><br><span class="line">    .uri(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;https://www.baidu.com&quot;</span>)) </span><br><span class="line">    .GET() </span><br><span class="line">    .build(); </span><br><span class="line"></span><br><span class="line">HttpResponse&lt;String&gt; response </span><br><span class="line">    = httpClient.send( </span><br><span class="line">    httpRequest, </span><br><span class="line">    HttpResponse.BodyHandler.asString()); </span><br><span class="line"></span><br><span class="line">System.out.println(response.statusCode());</span><br><span class="line">System.out.println(response.body());</span><br></pre></td></tr></table></figure><p>‍</p><h3 id="改进了Javadoc"><a href="#改进了Javadoc" class="headerlink" title="改进了Javadoc"></a>改进了Javadoc</h3><p>大家平时读的很多Java的文档（特别是官方的文档），就是用Javadoc生成的。 所以这也是Java文档——比较难读的原因之一。 写程序的人注释往往是为了让内部人员读懂，而文档是面向外部人员。</p><p>例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javadoc -d foo -html5 MyHelloWorld.java</span><br></pre></td></tr></table></figure><p>可以生成符合HTML5标准的网页。</p><h3 id="支持multirelease-jar包"><a href="#支持multirelease-jar包" class="headerlink" title="支持multirelease jar包"></a>支持multirelease jar包</h3><p>项目目录结构可以这样安排，不同的版本的程序在不同的目录下。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|-java</span><br><span class="line">|   └──java8</span><br><span class="line">|       └── hello</span><br><span class="line">|           └── xxx.java</span><br><span class="line">|   └──java9</span><br><span class="line">|       └── hello</span><br><span class="line">|           └── xxx.java</span><br></pre></td></tr></table></figure><p>然后可以通过<code>javac</code>** **编译成不同版本的class文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac --release 9 java8/hello/xxx.java</span><br><span class="line">javac --release 8 java9/hello/xxx.java</span><br></pre></td></tr></table></figure><p>最后用<code>jar</code>** <strong>可以产生不同版本的</strong>​**<code>jar</code>** **包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -c -f xxx.jar -C java8 . --release 9 -C java9.</span><br></pre></td></tr></table></figure><p>这样<code>xxx.jar</code>** **中会同时有java8和java9的程序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp test.jar hello <span class="comment">// 不同java版本访问不同的类</span></span><br></pre></td></tr></table></figure><p>这个功能的意义是什么？</p><p>Java升级太快了，多版本同时发布，让程序的提供者可以兼容不同用户的需求。</p><h3 id="集合的工厂方法"><a href="#集合的工厂方法" class="headerlink" title="集合的工厂方法"></a>集合的工厂方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">set</span> <span class="operator">=</span> Set.of(<span class="string">&quot;Apple&quot;</span>, <span class="string">&quot;Google&quot;</span>);</span><br><span class="line"><span class="type">var</span> <span class="variable">list</span> <span class="operator">=</span> List.of(<span class="string">&quot;...&quot;</span>, <span class="string">&quot;abc&quot;</span>, <span class="number">1</span>); <span class="comment">// 报错，思考为什么？</span></span><br><span class="line"><span class="type">var</span> <span class="variable">map</span> <span class="operator">=</span> Map.of(<span class="string">&quot;String&quot;</span>, <span class="number">5</span>, <span class="string">&quot;Integer&quot;</span>, <span class="number">6</span>); </span><br></pre></td></tr></table></figure><h3 id="增加ProcessHandler"><a href="#增加ProcessHandler" class="headerlink" title="增加ProcessHandler"></a>增加ProcessHandler</h3><p>增加了一个ProcessHandler用于查看某个特定进程的信息：启动时间、关联参数等等。目前是加强对进程的支持。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;ls -l&quot;</span>);</span><br><span class="line"><span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> builder.start();</span><br><span class="line">ProcessHandle.<span class="type">Info</span> <span class="variable">info</span> <span class="operator">=</span> p.info();</span><br><span class="line"></span><br><span class="line"><span class="comment">// start time</span></span><br><span class="line">info.startInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// arguments</span></span><br><span class="line">info.arguments();</span><br></pre></td></tr></table></figure><h3 id="Stream-API增加了方法"><a href="#Stream-API增加了方法" class="headerlink" title="Stream API增加了方法"></a>Stream API增加了方法</h3><p>为了方便操作，提供了更多的Stream API。</p><ul><li>takeWhile<br>字面意思：take while x !&#x3D; 7 is hold ， 中文意思：在x !&#x3D; 7的时候，拿，否则停下来</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">0</span>).takeWhile(x -&gt; x != <span class="number">7</span>)</span><br><span class="line">   .collect(Collectors.toList());</span><br><span class="line"><span class="comment">// [2,1,3]</span></span><br></pre></td></tr></table></figure><ul><li>dropWhile<br>字面意思： drop while x!&#x3D;7 is hold， 中文意思：在x!&#x3D;7的时候，丢弃，否则停下来</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(<span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">0</span>).dropWhile(x -&gt; x!=<span class="number">7</span>)</span><br><span class="line">  .collect(Collectors.toList());</span><br><span class="line"><span class="comment">//[7, 4, 6, 8, 0]</span></span><br></pre></td></tr></table></figure><ul><li>iterate</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> Stream.iterate(</span><br><span class="line">     <span class="number">10</span>,  <span class="comment">// 初始值</span></span><br><span class="line">     x -&gt; x &lt; <span class="number">100</span>, <span class="comment">// 终结断言</span></span><br><span class="line">     x-&gt;x+<span class="number">2</span> <span class="comment">// 递推函数</span></span><br><span class="line"> ).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">// [10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>另外一个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jshell&gt; Stream.iterate(<span class="string">&quot;i&quot;</span>, x -&gt; x.length() &lt; <span class="number">20</span>, x-&gt;x+<span class="string">&quot;i&quot;</span>).collect(Collectors.toList());</span><br><span class="line"><span class="comment">//[i, ii, iii, iiii, iiiii, iiiiii, iiiiiii, iiiiiiii, iiiiiiiii, iiiiiiiiii, iiiiiiiiiii, iiiiiiiiiiii, iiiiiiiiiiiii, iiiiiiiiiiiiii, iiiiiiiiiiiiiii, iiiiiiiiiiiiiiii, iiiiiiiiiiiiiiiii, iiiiiiiiiiiiiiiiii, iiiiiiiiiiiiiiiiiii]</span></span><br></pre></td></tr></table></figure><ul><li>ofNullable</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.ofNullable(<span class="literal">null</span>); <span class="comment">// Stream.empty()</span></span><br></pre></td></tr></table></figure><h3 id="钻石操作符语法优化"><a href="#钻石操作符语法优化" class="headerlink" title="&lt;&gt;钻石操作符语法优化"></a>&lt;&gt;钻石操作符语法优化</h3><p>允许匿名类使用钻石操作符。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Iterable&lt;Integer&gt; it = <span class="keyword">new</span> <span class="title class_">Iterable</span>&lt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Integer&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="CompletableFuture改进"><a href="#CompletableFuture改进" class="headerlink" title="CompletableFuture改进"></a>CompletableFuture改进</h3><p>CompletableFuture是java异步计算能力的核心，代表一个需要在未来被计算出来的的值。</p><p>在 Java9中针对已有能力，对CompletableFuture进行了提升。</p><h4 id="增加completeOnTimeout方法"><a href="#增加completeOnTimeout方法" class="headerlink" title="增加completeOnTimeout方法"></a>增加completeOnTimeout方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">future</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    Executors.newCachedThreadPool().submit(() -&gt; &#123;</span><br><span class="line">        <span class="comment">//Thread.sleep(1000);</span></span><br><span class="line">        <span class="comment">// future.complete(&quot;Hello&quot;);</span></span><br><span class="line">        <span class="comment">// 等价于 </span></span><br><span class="line">        <span class="comment">// completeOnTimeout是Java9新语法</span></span><br><span class="line">        future.completeOnTimeout(<span class="string">&quot;Hello&quot;</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// sync. method blocking...</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">value</span> <span class="operator">=</span> future.get();</span><br><span class="line">    System.out.println(value);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="增加直接成功-失败的future工厂方法"><a href="#增加直接成功-失败的future工厂方法" class="headerlink" title="增加直接成功&#x2F;失败的future工厂方法"></a>增加直接成功&#x2F;失败的future工厂方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">successFuture</span> <span class="operator">=</span> CompletableFuture.completedFuture(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">failFuture</span> <span class="operator">=</span> CompletableFuture.failedFuture(<span class="keyword">new</span> <span class="title class_">InterruptedException</span>());</span><br><span class="line"></span><br><span class="line">    System.out.println(successFuture.get()); <span class="comment">// hello</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(failFuture.isCompletedExceptionally()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;error&quot;</span>); <span class="comment">// print</span></span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(failFuture.get()); <span class="comment">// Exception</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>更多参考并发部分有一节对Future的专项突破课程</strong></p><h3 id="try-with-resources的改进"><a href="#try-with-resources的改进" class="headerlink" title="try-with-resources的改进"></a>try-with-resources的改进</h3><p>Java中的一部分资源对象会继承于Closeable接口，这就可以使用<code>try-with-resources</code>** **能力。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">InputStream</span> <span class="keyword">implements</span> <span class="title class_">Closeable</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果要使用的话：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException, IOException &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">fin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;somefile&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span>(fin) &#123; <span class="comment">// AutoClose</span></span><br><span class="line">        fin.read();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面直接对某个实现了Closeable的对象进行try，并且主动触发close能力， 是Java9的一个优化。</p><h2 id="Java-10"><a href="#Java-10" class="headerlink" title="Java 10"></a>Java 10</h2><h3 id="局部变量类型推断"><a href="#局部变量类型推断" class="headerlink" title="局部变量类型推断"></a>局部变量类型推断</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;Integer&gt;();</span><br><span class="line"><span class="comment">// list is LinkedList&lt;Integer&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">o</span> <span class="operator">=</span> Stream.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">// o is Stream&lt;Integer&gt;</span></span><br></pre></td></tr></table></figure><h3 id="JDK代码仓库整理"><a href="#JDK代码仓库整理" class="headerlink" title="JDK代码仓库整理"></a>JDK代码仓库整理</h3><p>所有JDK代码不再使用8个仓库存储：root、corba、hotspot、jaxp、jaxws、jdk、langtools、nashorn。</p><p>统一成为1个仓库。</p><p>主要是解决原子提交的问题：1个功能可能需要更新多个代码仓库。</p><h3 id="G1增加并行能力"><a href="#G1增加并行能力" class="headerlink" title="G1增加并行能力"></a>G1增加并行能力</h3><p>在mark-sweep-compact的GC算法上，再增加<strong>并行</strong> 能力。</p><p>见JVM GC部分</p><h3 id="优化：应用程序数据共享（Application-Data-Sharing"><a href="#优化：应用程序数据共享（Application-Data-Sharing" class="headerlink" title="优化：应用程序数据共享（Application Data Sharing)"></a>优化：应用程序数据共享（Application Data Sharing)</h3><p>ADS： 允许多个JVM实例共享共同用到的类，这些类以共享内存的形式存在。这样对于运行了多个JVM的机器，可以节省内存空间以及类的加载速度。</p><h3 id="计划移除JNI头生成工具"><a href="#计划移除JNI头生成工具" class="headerlink" title="计划移除JNI头生成工具"></a>计划移除JNI头生成工具</h3><p>JNI（Java Native Interface)是Java程序和Native(C, C++)程序沟通的接口。 一个Java类，如果要Native调用，通常是在Android开发当中，需要生成一个C&#x2F;C++的头文件。之前可以用javah来生成，现在用javah工具生成的时候，会有一行warning。</p><p>以后JNI的能力会被Panama项目替代，一个专门为非java语言提供接口的库。</p><h3 id="增加实验性的Graal编译器"><a href="#增加实验性的Graal编译器" class="headerlink" title="增加实验性的Graal编译器"></a>增加实验性的Graal编译器</h3><p>可以配置参数开启：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-XX：+ UnlockExperimentalVMOptions -XX：+ UseJVMCICompiler</span></span><br></pre></td></tr></table></figure><p>Graal是一款同时支持JIT和AOT的编译器。</p><ul><li>JIT(Just in Time)一边编译一边执行，执行完第一次之后，下一次不需要编译</li><li>AOT(Ahead of Time)，类似C&#x2F;C++那样，先编译成机器码，再执行。 注意，是机器码，越过了JVM的bytecode。</li></ul><p>目前还是实验阶段，不建议用作生产。已经发现了不少的Bug，等待进一步的修复。</p><h2 id="Java-11"><a href="#Java-11" class="headerlink" title="Java 11"></a>Java 11</h2><h3 id="引入NestedMembers概念"><a href="#引入NestedMembers概念" class="headerlink" title="引入NestedMembers概念"></a>引入NestedMembers概念</h3><p>嵌套类和它的父亲作为一组NestedMembers，可以互相访问元数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Nested</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">B</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bar</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">            System.out.println(A.class.getDeclaredField(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        b.bar();</span><br><span class="line">        <span class="comment">// name </span></span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(A.class.getNestMembers()));</span><br><span class="line">        <span class="comment">// [Nested, A, B]</span></span><br><span class="line">    </span><br><span class="line">        System.out.println(A.class.getNestHost());</span><br><span class="line">        <span class="comment">// Nested</span></span><br><span class="line">    </span><br><span class="line">        System.out.println(Arrays.toString(B.class.getNestMembers()));</span><br><span class="line">        <span class="comment">// [Nested, A, B]</span></span><br><span class="line">    </span><br><span class="line">        System.out.println(B.class.getNestHost());</span><br><span class="line">        <span class="comment">// Nested</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="增加无操作GC回收器-Epsilon"><a href="#增加无操作GC回收器-Epsilon" class="headerlink" title="增加无操作GC回收器:Epsilon"></a>增加无操作GC回收器:Epsilon</h3><p>Epsilon不会进行垃圾回收操作，是的，你没有看错， 它不进行GC。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="variable constant_">XX</span><span class="symbol">:+UseEpsilonGC</span></span><br></pre></td></tr></table></figure><p>Epsilon虽然不GC，但是仍然承担着内存分配的工作。（Java 的 GC也是Java的内存管理工具，更多见GC部分）</p><p>有点：</p><ul><li>对于开发者明确知道不需要GC的程序有助于减少延迟</li><li>对于性能测试、压力测试场景，可以忽略GC带来的延迟</li></ul><h3 id="Lambda优化：允许使用-var定义匿名函数形参"><a href="#Lambda优化：允许使用-var定义匿名函数形参" class="headerlink" title="Lambda优化：允许使用 var定义匿名函数形参"></a>Lambda优化：允许使用 var定义匿名函数形参</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@interface</span> My&#123;&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">    Predicate&lt;String&gt; predicate = (<span class="meta">@My</span> <span class="keyword">var</span> a) -&gt; <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="优化：增加字符串能处理函数"><a href="#优化：增加字符串能处理函数" class="headerlink" title="优化：增加字符串能处理函数"></a>优化：增加字符串能处理函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot; &quot;</span>.isBlank();                <span class="comment">// true</span></span><br><span class="line"><span class="string">&quot; Foo Bar &quot;</span>.strip();          <span class="comment">// &quot;Foo Bar&quot;</span></span><br><span class="line"><span class="string">&quot; Foo Bar &quot;</span>.stripTrailing();  <span class="comment">// &quot; Foo Bar&quot;</span></span><br><span class="line"><span class="string">&quot; Foo Bar &quot;</span>.stripLeading();   <span class="comment">// &quot;Foo Bar &quot;</span></span><br><span class="line"><span class="string">&quot;Java&quot;</span>.repeat(<span class="number">3</span>);             <span class="comment">// &quot;JavaJavaJava&quot;</span></span><br><span class="line"><span class="string">&quot;A\nB\nC&quot;</span>.lines().count();    <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><p>‍</p><p>‍</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Java8-11的新特性&quot;&gt;&lt;a href=&quot;#Java8-11的新特性&quot; class=&quot;headerlink&quot; title=&quot;Java8-11的新特性&quot;&gt;&lt;/a&gt;Java8-11的新特性&lt;/h1&gt;&lt;h2 id=&quot;Java8&quot;&gt;&lt;a href=&quot;#Java8&quot; c</summary>
      
    
    
    
    <category term="Java" scheme="http://example.com/categories/Java/"/>
    
    
    <category term="Java Core" scheme="http://example.com/tags/Java-Core/"/>
    
  </entry>
  
</feed>
